<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda CCB</title>
    <meta name="description" content="Agenda CCB">
    <meta name="theme-color" content="#003366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Agenda CCB">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #334155;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        html,
        body,
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .bg-navy {
            background-color: #003366;
        }

        .text-navy {
            color: #003366;
        }

        .border-navy {
            border-color: #003366;
        }

        .bg-orange-custom {
            background-color: #FF8C00;
        }

        .text-orange-custom {
            color: #FF8C00;
        }

        .border-orange-custom {
            border-color: #FF8C00;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
        }

        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
        }

        .disabled-area {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            border-width: 2px !important;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background-color: #f1f5f9;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #003366;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
        }

        #report-capture-area {
            width: 794px;
            min-height: 1123px;
            background: white;
            padding: 50px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
        }

        .highlight-item {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
        }

        #conn-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: all 0.3s ease;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
        }

        #conn-status.offline {
            background: #ef4444;
            color: white;
            opacity: 1;
            visibility: visible;
        }

        #conn-status.online-recovered {
            background: #10b981;
            color: white;
            opacity: 1;
            visibility: visible;
        }

        .sync-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f59e0b;
            color: white;
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .temp-badge {
            background-color: #fff7ed;
            border: 1px solid #ffedd5;
            color: #9a3412;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        @keyframes highlight-pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .highlight-item {
            animation: highlight-pulse 1s ease-in-out;
        }
    </style>
    <link rel="manifest" href="./manifest.json">

</head>

<body class="h-screen w-full flex flex-col bg-slate-100">

    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <span class="loading-text">Carregando Agenda...</span>
        </div>
    </div>

    <div id="conn-status"></div>

    <div id="modal-container"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm"></div>

    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 id="modal-login-title" class="font-bold text-lg text-navy uppercase tracking-tight">Faça Login ou
                    Cadastro</h3>
                <button type="button" onclick="window.closeModal()" class="text-slate-400 p-1 hover:text-slate-600"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div id="name-field" class="hidden">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Nome Completo</label>
                    <input type="text" id="login-name"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="Seu nome">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Email</label>
                    <input type="email" id="login-email"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="exemplo@email.com" required>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Senha</label>
                    <input type="password" id="login-password"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="••••••••" required>
                </div>
                <div id="login-error"
                    class="text-red-500 text-[11px] hidden font-bold bg-red-50 p-2 rounded-lg border border-red-100">
                </div>
                <button type="submit" id="login-submit-btn"
                    class="w-full py-4 rounded-xl bg-navy text-white font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Entrar</button>
                <div class="text-center pt-2">
                    <button type="button" id="toggle-auth-mode"
                        class="text-[11px] font-bold text-slate-500 hover:text-navy uppercase tracking-tight underline">Não
                        tem conta? Cadastre-se</button>
                </div>
            </form>
        </div>
    </template>

    <script type="module">
        const SUPABASE_URL = "https://gcsvapoqpbrrqubxawkd.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdjc3ZhcG9xcGJycnF1Ynhhd2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTgyMzYsImV4cCI6MjA4MDQ3NDIzNn0.QtIldObznGEYTXyEf0MS4mIgIDgbMKmS0M2FBVInTZQ";
        const ADMIN_EMAIL = "eventosadmvalente@gmail.com";

        // --- Schema Centralizado de Configuração ---
        const TableSchema = {
            types: {
                label: 'Tipos de Evento',
                pk: 'id',
                fields: {
                    name: { label: 'Nome', type: 'text', required: true, listPriority: 1 },
                    sigla: { label: 'Sigla', type: 'text', maxLength: 5, uppercase: true, required: true, listPriority: 2 }
                }
            },
            locations: {
                label: 'Localidades',
                pk: 'id',
                fields: {
                    localidade: { label: 'Localidade', type: 'text', required: true, listPriority: 1 },
                    adm: { label: 'ADM', type: 'text', listPriority: 2 },
                    setor: { label: 'Setor', type: 'text', listPriority: 3 },
                    cidade: { label: 'Cidade', type: 'text', listPriority: 4 },
                    anciao_1: { label: 'Ancião 1', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Ancião', group: 'anciaes' },
                    anciao_2: { label: 'Ancião 2', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Ancião', group: 'anciaes' },
                    anciao_3: { label: 'Ancião 3', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Ancião', group: 'anciaes' },
                    diacono_1: { label: 'Diácono 1', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Diácono', group: 'diaconos' },
                    diacono_2: { label: 'Diácono 2', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Diácono', group: 'diaconos' },
                    diacono_3: { label: 'Diácono 3', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Diácono', group: 'diaconos' },
                    com_1: { label: 'Coop. Oficial 1', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Oficial', group: 'cooperadores' },
                    com_2: { label: 'Coop. Oficial 2', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Oficial', group: 'cooperadores' },
                    cjm: { label: 'Coop. Jovens', type: 'picker', refTable: 'attendants', filterKey: 'ministerio', filterVal: 'Jovens', group: 'cooperadores' }
                }
            },
            attendants: {
                label: 'Atendentes',
                pk: 'id',
                fields: {
                    name: { label: 'Nome', type: 'text', required: true, listPriority: 1 },
                    ministerio: { label: 'Ministério', type: 'text', listPriority: 2 }
                }
            },
            feriados: {
                label: 'Feriados',
                pk: 'id',
                fields: {
                    nome_feriado: { label: 'Nome do Feriado', type: 'text', required: true, listPriority: 1 },
                    data: { label: 'Data', type: 'date', required: true, listPriority: 2 },
                    tipo_feriado: { label: 'Tipo', type: 'text', listPriority: 3 }
                }
            },
            perfis: {
                label: 'Gestão de Usuários',
                pk: 'id',
                fields: {
                    nome: { label: 'Nome Completo', type: 'text', readonly: true, listPriority: 1 },
                    email: { label: 'Email', type: 'email', readonly: true, listPriority: 2 },
                    autorizado: { label: 'Autorizado', type: 'boolean', defaultValue: false },
                    permissao: { label: 'Nível de Permissão', type: 'select', options: ['leitura', 'admin'], defaultValue: 'leitura' }
                }
            },
            agenda: {
                label: 'Eventos',
                pk: 'id',
                fields: {
                    date: { label: 'Data', type: 'date', required: true },
                    time: { label: 'Hora', type: 'time', required: true },
                    location_id: { label: 'Localidade', type: 'ref', refTable: 'locations', required: true },
                    type_id: { label: 'Tipo', type: 'ref', refTable: 'types', required: true },
                    attendant_id: { label: 'Atendente', type: 'ref', refTable: 'attendants' },
                    irmaos: { label: 'Irmãos', type: 'number' },
                    irmas: { label: 'Irmãs', type: 'number' },
                    alterado_por: { label: 'Alterado Por', type: 'system' }
                }
            }
        };

        // Singleton: Garante que não criaremos múltiplos clientes se o script rodar de novo
        if (!window.supabaseInstance) {
            window.supabaseInstance = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true,
                    storageKey: 'agenda-ccb-auth'
                },
                realtime: {
                    timeout: 20000 // Aumentado para 20s conforme solicitado
                }
            });

            // Monitoramento Heartbeat para detectar falhas de conexão
            window.supabaseInstance.realtime.onHeartbeat(() => {
                console.log("[Realtime] Heartbeat recebido - Conexão ativa.");
            });
        }
        const supabaseClient = window.supabaseInstance;

        // Gerenciamento de canais com proteção contra duplicidade
        const activeChannelss = new Map();

        async function setupRealtime(tableName) {
            // Se já existe um canal para essa tabela, removemos antes de criar outro
            if (activeChannelss.has(tableName)) {
                await supabaseClient.removeChannel(activeChannelss.get(tableName));
            }

            const channel = supabaseClient
                .channel(`public:${tableName}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: tableName }, (payload) => {
                    console.log(`Mudança em ${tableName}:`, payload);
                    // Sua função de atualizar a UI aqui
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') console.log(`Monitorando: ${tableName}`);
                    if (status === 'CHANNEL_ERROR') {
                        console.error('Erro no Realtime, tentando reconectar...');
                        setTimeout(() => setupRealtime(tableName), 5000);
                    }
                });

            activeChannels.set(tableName, channel);
        }

        // Monitora se o usuário ficou muito tempo fora e a sessão "dormiu"
        document.addEventListener("visibilitychange", async () => {
            if (document.visibilityState === "visible") {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    const isSessionActive = !!session;
                    const isRealtimeActive = supabaseClient.realtime && supabaseClient.realtime.isConnected();

                    console.log(`[App] Visível - Sessão: ${isSessionActive}, Realtime: ${isRealtimeActive}`);

                    if (!isSessionActive || !isRealtimeActive) {
                        if (navigator.onLine) {
                            console.log("[App] Instabilidade ONLINE. Recarregando...");
                            window.location.reload();
                        } else {
                            console.log("[App] Instabilidade OFFLINE. Usando cache...");
                            if (window.loadFromCache) window.loadFromCache();
                            showConnStatus('offline');
                        }
                    } else {
                        console.log("[App] Tudo OK. Sincronizando...");
                        if (window.processOfflineQueue) processOfflineQueue(true);
                    }
                } catch (e) { console.error("[App] Erro visibilidade:", e); }
            }
        });

        window.loadFromCache = () => {
            console.log("[App] Carregando dados do cache local...");
            const tables = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'agenda': 'events', 'feriados': 'feriados', 'perfis': 'perfis' };
            Object.entries(tables).forEach(([table, key]) => {
                try {
                    const cached = localStorage.getItem(`cache_${table}`);
                    if (cached) state[key] = JSON.parse(cached);
                } catch (e) { }
            });
            state.isLoading = false;
            scheduleRender();
        };

        const activeChannels = new Map();
        function cleanupListeners() {
            activeChannels.forEach((channel, name) => {
                supabaseClient.removeChannel(channel);
            });
            activeChannels.clear();
        }

        const setupListener = (table, stateKey) => {
            const channelName = `public:${table}`;

            if (activeChannels.has(channelName)) {
                const oldChannel = activeChannels.get(channelName);
                supabaseClient.removeChannel(oldChannel);
                activeChannels.delete(channelName);
            }


            const cacheSaveTimers = {};
            const debouncedSave = (table, data) => {
                if (cacheSaveTimers[table]) clearTimeout(cacheSaveTimers[table]);
                cacheSaveTimers[table] = setTimeout(() => {
                    localStorage.setItem(`cache_${table}`, JSON.stringify(data));
                    delete cacheSaveTimers[table];
                }, 2000);
            };

            const uiUpdateTimers = {};
            const requestUIUpdate = (table) => {
                if (uiUpdateTimers[table]) cancelAnimationFrame(uiUpdateTimers[table]);
                uiUpdateTimers[table] = requestAnimationFrame(() => {
                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);
                    delete uiUpdateTimers[table];
                });
            };

            const isSameRecord = (r1, r2, table) => {
                if (table === 'agenda') {
                    return r1.date === r2.date && r1.time === r2.time && String(r1.location_id) === String(r2.location_id) && String(r1.type_id) === String(r2.type_id);
                } else if (table === 'locations') {
                    return r1.localidade === r2.localidade && r1.setor === r2.setor && r1.adm === r2.adm;
                } else if (table === 'types' || table === 'attendants' || table === 'feriados' || table === 'perfis') {
                    const name1 = r1.name || r1.nome || r1.nome_feriado;
                    const name2 = r2.name || r2.nome || r2.nome_feriado;
                    return name1 === name2;
                }
                return false;
            };

            const channel = supabaseClient.channel(channelName)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table }, (payload) => {
                    const current = [...(state[stateKey] || [])];
                    if (current.find(item => String(item.id) === String(payload.new.id))) return;

                    // Tenta encontrar um registro temporário que corresponda a este novo registro real
                    const tempItem = current.find(item => String(item.id).startsWith('temp_') && isSameRecord(item, payload.new, table));

                    if (tempItem) {
                        console.log(`[setupListener] Mesclando INSERT real ${payload.new.id} sobre temporário ${tempItem.id}`);
                        state[stateKey] = current.map(item => item.id === tempItem.id ? payload.new : item);
                    } else {
                        state[stateKey] = [...current, payload.new];
                    }

                    debouncedSave(table, state[stateKey]);
                    requestUIUpdate(table);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table }, async (payload) => {
                    const current = [...(state[stateKey] || [])];
                    state[stateKey] = current.map(item => String(item.id) === String(payload.new.id) ? payload.new : item);
                    debouncedSave(table, state[stateKey]);

                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);

                    if (table === 'perfis' && state.user && payload.new.id === state.user.id) {
                        const isMasterAdmin = (state.user.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase());
                        const wasAuthorized = state.isAuthorized;

                        state.isAdmin = isMasterAdmin || (payload.new.permissao === 'admin');
                        state.isAuthorized = isMasterAdmin || (payload.new.autorizado === true);

                        localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({
                            isAdmin: state.isAdmin,
                            isAuthorized: state.isAuthorized
                        }));

                        if (state.isAuthorized && !wasAuthorized) await refreshAllData();
                    }
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table }, (payload) => {
                    const current = [...(state[stateKey] || [])];
                    state[stateKey] = current.filter(item => String(item.id) !== String(payload.old.id));
                    debouncedSave(table, state[stateKey]);

                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);
                })
                .subscribe();

            activeChannels.set(channelName, channel);
        };

        function translateAuthError(message) {
            const msg = message.toLowerCase();
            if (msg.includes('invalid login credentials')) return "E-mail ou senha incorretos.";
            if (msg.includes('user already registered')) return "Este e-mail já está cadastrado no sistema.";
            if (msg.includes('password should be at least 6 characters')) return "A senha deve ter pelo menos 6 caracteres.";
            if (msg.includes('signup requires a valid email')) return "Por favor, insira um endereço de e-mail válido.";
            if (msg.includes('email not confirmed')) return "E-mail ainda não confirmado. Verifique sua caixa de entrada.";
            if (msg.includes('invalid email or password')) return "E-mail ou senha inválidos.";
            return message;
        }

        const CACHE_NAME = 'adm-valente-v2.0-optimized';
        const SYNC_QUEUE_KEY = 'adm_valente_sync_queue';
        const USER_PROFILE_CACHE_KEY = 'cache_user_profile';

        async function processOfflineQueue(isRecovery = false) {
            if (!navigator.onLine) return;

            await new Promise(resolve => setTimeout(resolve, 1000));

            const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
            if (queue.length === 0) return;

            const item = queue[0];
            const { table, action, data, id, originalSnapshot } = item;

            if (action === 'UPDATE' && id && originalSnapshot) {
                try {
                    const { data: serverRecord, error } = await supabaseClient.from(table).select('*').eq('id', id).single();

                    const serverString = serverRecord ? JSON.stringify(serverRecord) : null;
                    const snapshotString = JSON.stringify(originalSnapshot);

                    if (!serverRecord || (serverString !== snapshotString && serverRecord.alterado_por !== state.user.id)) {
                        showConflictModal(item, serverRecord);
                        return;
                    }
                } catch (err) { }
            }

            await executeSync(item, isRecovery);
        }

        async function executeSync(item, isRecovery = false) {
            const { table, action, data, id } = item;
            const cleanData = { ...data };
            delete cleanData.id;
            const stateKey = table === 'agenda' ? 'events' : table;

            try {
                console.log(`[executeSync] Sincronizando ${action} para ${table}...`);

                // 1. Verificação proativa da sessão
                let { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

                if (sessionError || !session) {
                    console.warn("[executeSync] Sessão inválida. Tentando refresh...");
                    const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                    session = refreshData?.session;

                    if (refreshError || !session) {
                        console.warn("[executeSync] Refresh falhou. Tentando recuperação manual do localStorage...");
                        try {
                            const storageData = JSON.parse(localStorage.getItem('agenda-ccb-auth') || '{}');
                            if (storageData.access_token && storageData.refresh_token) {
                                console.log("[executeSync] Token encontrado. Recriando sessão...");
                                const { data: setData, error: setError } = await supabaseClient.auth.setSession({
                                    access_token: storageData.access_token,
                                    refresh_token: storageData.refresh_token
                                });
                                session = setData?.session;
                            }
                        } catch (e) {
                            console.error("[executeSync] Erro ao ler localStorage p/ recuperação:", e);
                        }
                    }

                    if (!session) {
                        console.error("[executeSync] Falha crítica na sessão. Sincronização pausada.");
                        return; // Mantém na fila
                    }
                }

                // 2. Executa a operação
                let res;
                if (action === 'INSERT') res = await supabaseClient.from(table).insert(cleanData).select().single();
                else if (action === 'UPDATE') res = await supabaseClient.from(table).update(cleanData).eq('id', id).select().single();
                else if (action === 'DELETE') res = await supabaseClient.from(table).delete().eq('id', id);

                if (res && res.error) {
                    console.error(`[executeSync] Erro Supabase em ${table} (${action}):`, res.error);

                    // Se for erro de autenticação, tenta refresh e re-executa
                    if (res.error.code === 'PGRST301' || res.error.status === 401) {
                        const { error: rE } = await supabaseClient.auth.refreshSession();
                        if (!rE) return executeSync(item);
                    }

                    // Se for erro de coluna inexistente ou erro de dados (não auth/rede), 
                    // removemos da fila para não travar o app eternamente
                    const fatalErrors = ['42703', 'PGRST204', '23505', '23502', '23503']; // Coluna não existe, não encontrado, duplicado, nulo, FK
                    if (fatalErrors.includes(res.error.code) || res.error.status === 404 || res.error.status === 400) {
                        console.warn(`[executeSync] Erro fatal detectado (${res.error.code}). Removendo item da fila para evitar travamento.`);
                        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                        const newQueue = queue.filter(q => q.timestamp !== item.timestamp);
                        localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(newQueue));
                        if (newQueue.length > 0) processOfflineQueue(isRecovery);
                        return;
                    }

                    return; // Mantém na fila se for erro de rede temporário
                }

                console.log(`[executeSync] Sucesso! Atualizando IDs locais se necessário.`);

                // Se foi um INSERT, precisamos trocar o ID temporário pelo real em todo o app
                if (action === 'INSERT' && res.data && String(id).startsWith('temp_')) {
                    const realId = res.data.id;

                    // 1. Atualiza no state
                    state[stateKey] = state[stateKey].map(i => String(i.id) === String(id) ? res.data : i);
                    localStorage.setItem(`cache_${table}`, JSON.stringify(state[stateKey]));

                    // 2. Atualiza outros itens na fila que dependam desse ID (ex: um UPDATE logo após o INSERT)
                    const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                    const updatedQueue = queue.map(q => {
                        if (q.table === table && String(q.id) === String(id)) q.id = realId;
                        return q;
                    });
                    localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(updatedQueue));

                    // 3. Mantém o destaque visual se o item estiver selecionado
                    if (String(state.highlightedItemId) === String(id)) {
                        state.highlightedItemId = realId;
                    }

                    console.log(`[executeSync] ID mapeado: ${id} -> ${realId}`);
                }

                // Remove o item processado da fila
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                const newQueue = queue.filter(q => q.timestamp !== item.timestamp);

                // Atualiza o originalSnapshot de outros itens pendentes para o mesmo registro
                // Isso evita conflitos falsos em edições consecutivas offline
                const updatedQueue = newQueue.map(q => {
                    if (q.table === table && String(q.id) === String(id) && q.action === 'UPDATE') {
                        console.log(`[executeSync] Sincronizando originalSnapshot para item subsequente na fila (${q.timestamp})`);
                        q.originalSnapshot = res.data;
                    }
                    return q;
                });

                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(updatedQueue));

                if (updatedQueue.length > 0) {
                    processOfflineQueue(isRecovery);
                } else {
                    if (isRecovery) {
                        showConnStatus('online-recovered');
                        await refreshAllData();
                    }
                    if (window.updateHomeList) window.updateHomeList();
                }
            } catch (err) {
                console.error("[executeSync] Exceção na sincronização:", err);
            }
        }

        // Helper Unificado para Modais
        window.renderModalShell = ({ title, contentHtml, icon = '', type = 'default', size = 'max-w-md', centerContent = false, closeAction = 'window.closeModal()' }) => {
            const styles = {
                default: { border: '', iconColor: 'text-navy', iconBg: 'bg-blue-50' },
                danger: { border: 'border-t-[8px] border-red-500', iconColor: 'text-red-500', iconBg: 'bg-red-50' },
                warning: { border: 'border-t-[10px] border-orange-custom', iconColor: 'text-orange-custom', iconBg: 'bg-orange-50' },
                info: { border: 'border-t-8 border-navy/10', iconColor: 'text-navy', iconBg: 'bg-blue-50' }
            };
            const s = styles[type] || styles.default;

            if (centerContent) {
                return `
            <div class="bg-white rounded-3xl shadow-2xl w-full ${size} overflow-hidden ${s.border} relative animate-in fade-in zoom-in duration-200 mx-4">
                <div class="p-8 flex flex-col items-center text-center">
                    ${icon ? `<div class="w-16 h-16 ${s.iconBg} rounded-2xl flex items-center justify-center mb-6"><i data-lucide="${icon}" class="${s.iconColor} w-8 h-8"></i></div>` : ''}
                    <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3 leading-tight">${title}</h3>
                    <div class="w-full text-slate-500 text-sm leading-relaxed">${contentHtml}</div>
                </div>
            </div>`;
            }

            return `
        <div class="bg-white rounded-xl shadow-2xl w-full ${size} overflow-hidden flex flex-col max-h-[90vh] active:outline-none focus:outline-none mx-4" tabindex="-1">
            <div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white shrink-0">
                <div class="flex items-center gap-2 text-navy">
                    ${icon ? `<i data-lucide="${icon}" class="w-5 h-5 ${s.iconColor}"></i>` : ''}
                    <h3 class="font-black text-xs uppercase tracking-widest">${title}</h3>
                </div>
                <button onclick="${closeAction}" class="text-slate-300 hover:text-slate-500 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-none flex flex-col relative w-full">
                ${contentHtml}
            </div>
        </div>`;
        };

        function showConflictModal(item, serverRecord) {
            const { table } = item;
            const isDeleted = !serverRecord;
            const content = `
                <p class="mb-8">
                    ${isDeleted ? 'O registro que você estava modificando foi excluído por outro usuário.' : 'O registro que você estava modificando foi alterado por outro usuário.'}
                    <br><br>Você deseja descartar ou gravar as suas alterações?
                </p>
                <div class="w-full flex gap-3">
                    <button onclick="window.resolveConflict('descartar', ${JSON.stringify(item).replace(/"/g, '&quot;')}, ${JSON.stringify(serverRecord).replace(/"/g, '&quot;')})" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Descartar</button>
                    <button onclick="window.resolveConflict('gravar', ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="flex-1 py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Gravar</button>
                </div>`;

            showModal(renderModalShell({
                title: 'Houve alteração de dados',
                contentHtml: content,
                type: 'warning',
                icon: 'alert-triangle',
                centerContent: true
            }));
        }

        window.resolveConflict = async (decision, item, serverRecord) => {
            const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
            const newQueue = queue.filter(q => q.timestamp !== item.timestamp);
            localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(newQueue));

            if (decision === 'descartar') {
                const stateKey = item.table === 'agenda' ? 'events' : item.table;
                if (serverRecord) {
                    const currentList = [...state[stateKey]];
                    const idx = currentList.findIndex(i => String(i.id) === String(serverRecord.id));
                    if (idx !== -1) currentList[idx] = serverRecord;
                    state[stateKey] = currentList;
                    localStorage.setItem(`cache_${item.table}`, JSON.stringify(currentList));

                    // Destacar o registro atualizado
                    state.highlightedItemId = serverRecord.id;
                } else {
                    state[stateKey] = state[stateKey].filter(i => String(i.id) !== String(item.id));
                    localStorage.setItem(`cache_${item.table}`, JSON.stringify(state[stateKey]));
                }

                closeModal();

                // Atualizar a UI imediatamente antes de navegar
                const targetScreen = item.table === 'agenda' ? 'home' : (item.table === 'perfis' ? 'users' : item.table);

                if (item.table === 'agenda') {
                    if (window.updateHomeList) window.updateHomeList();
                } else {
                    if (window.updateManagerListUI) window.updateManagerListUI(item.table);
                }

                scheduleRender();

                if (newQueue.length > 0) processOfflineQueue();

                window.navigateTo(targetScreen);
            } else {
                closeModal();
                await executeSync(item);
                const targetScreen = item.table === 'agenda' ? 'home' : (item.table === 'perfis' ? 'users' : item.table);
                window.navigateTo(targetScreen);
            }
        };

        window.smartSave = async (table, action, data, id = null, callback = null) => {
            console.log(`[smartSave] Offline-First: ${table} | Ação: ${action}`);
            const isNew = action === 'INSERT';
            const tempId = isNew ? `temp_${Date.now()}` : id;
            const finalId = id || tempId;
            const stateKey = table === 'agenda' ? 'events' : table;

            if (state.user && data) data.alterado_por = state.user.id;

            let originalSnapshot = null;
            if (action === 'UPDATE' && id) {
                originalSnapshot = state[stateKey].find(i => String(i.id) === String(id));
            }

            // 1. SALVAR IMEDIATAMENTE NO NAVEGADOR (State + localStorage)
            console.log("[smartSave] Atualizando estado local do navegador...");
            let list = [...(state[stateKey] || [])];
            if (action === 'INSERT') {
                list.push({ id: tempId, ...data });
            } else if (action === 'UPDATE') {
                const idx = list.findIndex(i => String(i.id) === String(id));
                if (idx !== -1) list[idx] = { ...list[idx], ...data };
            } else if (action === 'DELETE') {
                list = list.filter(i => String(i.id) !== String(id));
            }

            state[stateKey] = list;
            localStorage.setItem(`cache_${table}`, JSON.stringify(list));

            // Aplica destaque e rolagem
            state.highlightedItemId = finalId;

            // Atualiza UI instantaneamente
            if (window.state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
            const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
            if (window.state.currentScreen === screenMap[table]) window.updateManagerListUI(table);

            // Se houver um callback (ex: closeModal, navigateTo), chama AGORA
            if (callback) callback();

            // 2. ADICIONAR NA FILA DE SINCRONIZAÇÃO
            const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
            queue.push({ table, action, data, id: finalId, timestamp: Date.now(), originalSnapshot });
            localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));

            // 3. DISPARAR SINCRONIZAÇÃO EM SEGUNDO PLANO (sem esperar pelo retorno)
            console.log("[smartSave] Disparando sincronização em segundo plano...");
            if (navigator.onLine) processOfflineQueue(false);
            else showConnStatus('offline');

            return { success: true, offline: true, tempId };
        };

        window.addEventListener('online', () => processOfflineQueue(true));

        const getCachedProfile = () => {
            try {
                const p = localStorage.getItem(USER_PROFILE_CACHE_KEY);
                return p ? JSON.parse(p) : { isAdmin: false, isAuthorized: false };
            } catch (e) { return { isAdmin: false, isAuthorized: false }; }
        };
        const initialProfile = getCachedProfile();

        const INITIAL_STATE = {
            user: null,
            isAdmin: initialProfile.isAdmin || false,
            isAuthorized: initialProfile.isAuthorized || false,
            currentScreen: 'home',
            events: [],
            types: [],
            locations: [],
            attendants: [],
            feriados: [],
            perfis: [],
            externalHolidays: [],
            fetchedYears: new Set(),
            isMenuOpen: false,
            editingEventId: null,
            searchTerm: '',
            managerSearchTerm: '',
            highlightedItemId: null,
            fastFilter: { active: false, dateStart: '', dateEnd: '', label: '' },
            ffTemp: {
                selected: 'today',
                baseDates: {
                    today: new Date(),
                    week: new Date(),
                    month: new Date(),
                    year: new Date()
                }
            },
            selectedDate: null,
            viewDate: new Date(),
            formTempDate: '', formTempTime: '08:00', formTempLoc: '', formTempType: '', formTempAtt: '',
            formTempIrmaos: '', formTempIrmas: '',
            isLoading: true,
            advancedFilter: {
                active: false,
                eventos: { enabled: false, status: 'ativos' },
                type: { enabled: false, id: '' },
                location: { enabled: false, id: '' },
                attendant: { enabled: false, id: '' },
                adm: { enabled: false, value: '' },
                setor: { enabled: false, value: '' },
                cidade: { enabled: false, value: '' },
                period: { enabled: false, start: '', end: '' },
                validationErrors: []
            },
            formErrors: [],
            clockMode: 'hour',
            clockTempHour: '08',
            clockTempMinute: '00',
            originalEventSnapshot: null,
            reportFilter: {
                table: 'agenda',
                type: { enabled: false, id: 'all' },
                location: { enabled: false, id: 'all' },
                attendant: { enabled: false, id: 'all' },
                adm: { enabled: false, id: 'all' },
                setor: { enabled: false, id: 'all' },
                cidade: { enabled: false, id: 'all' }
            }
        };

        const state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                if (target[property] === value) return true;
                target[property] = value;

                const silent = [
                    'searchTerm', 'managerSearchTerm', 'clockMode', 'clockTempHour', 'clockTempMinute',
                    'ffTemp', 'fetchedYears', 'formErrors',
                    'events', 'types', 'locations', 'attendants', 'feriados', 'perfis'
                ];
                if (!silent.includes(property)) {
                    scheduleRender();
                }

                if (property === 'searchTerm' && window.updateHomeList) {
                    window.updateHomeList();
                }

                if (property === 'currentScreen' && value === 'home') {
                    if (!state.highlightedItemId) state.highlightedItemId = null;
                }

                if (['clockMode', 'clockTempHour', 'clockTempMinute'].includes(property)) {
                    if (typeof window.renderClockUI === 'function') window.renderClockUI();
                }

                return true;
            }
        });
        window.state = state;

        async function loadExternalHolidays(year) {
            if (state.fetchedYears.has(year)) return;

            try {
                // Using apiClient (Step 4)
                const holidays = await apiClient.get(`https://brasilapi.com.br/api/feriados/v1/${year}`);

                const dateBA = `${year}-07-02`;
                if (!holidays.some((h) => h.date === dateBA)) {
                    holidays.push({ date: dateBA, name: "Independência da Bahia", type: "state" });
                }

                state.externalHolidays = [...state.externalHolidays, ...holidays];
                state.fetchedYears.add(year);
                scheduleRender();
            } catch (e) {
                console.warn("[loadExternalHolidays] Failed to fetch holidays:", e);
                // Fail silently, app continues working
            }
        }

        let renderTimer = null;
        function scheduleRender() {
            if (renderTimer) return;
            renderTimer = window.requestAnimationFrame(() => {
                renderApp();
                renderTimer = null;
            });
        }

        const formatDate = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`; };
        const formatDateFull = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0]}`; };
        const isEventPast = (date, time) => { return new Date(`${date}T${time}`) < new Date(); };

        function renderIcons() { if (window.lucide) window.lucide.createIcons(); }

        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            if (state.isLoading) {
                app.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><span class="loading-text">Conectando...</span></div>`;
                return;
            }

            switch (state.currentScreen) {
                case 'home': renderHome(); break;
                case 'event-form': renderEventForm(); break;
                case 'types': renderGenericManager('Tipos de Eventos', 'types'); break;
                case 'locations': renderGenericManager('Cidades / Localidades', 'locations'); break;
                case 'attendants': renderGenericManager('Atendentes', 'attendants'); break;
                case 'feriados': renderGenericManager('Feriados', 'feriados'); break;
                case 'users': renderGenericManager('Gestão de Usuários', 'perfis'); break;
                case 'about': renderAbout(); break;
            }
            renderIcons();
        }

        window.updateHomeList = () => {
            const container = document.getElementById('event-list-container');
            if (!container) return;

            if (!state.isAuthorized) {
                container.innerHTML = '';
                return;
            }

            const filtered = getFilteredEvents();
            container.innerHTML = `
                <div class="flex justify-between items-start px-1 mb-1 gap-2 min-h-[18px] overflow-visible">
                    <div id="home-filter-label" class="font-bold text-navy uppercase flex-1 min-w-0 leading-tight whitespace-normal break-words overflow-visible transition-all duration-200" style="font-size: 13px;">
                        ${getFilterDescription()}
                    </div>
                    <span class="text-[10px] font-medium text-slate-500 uppercase shrink-0 pt-0.5">${filtered.length} registros</span>
                </div>
                <div class="flex-1 bg-white rounded-xl shadow-md overflow-y-auto border border-slate-200 scrollbar-none">
                    ${filtered.length === 0 ? '<div class="p-12 text-center text-slate-400 flex flex-col items-center gap-4"><i data-lucide="calendar-x" class="w-10 h-10 opacity-20"></i><span>Nenhum evento encontrado.</span></div>' : `
                        <ul class="divide-y divide-slate-100">
                            ${filtered.map((e) => {
                const type = state.types.find((t) => t.id === e.type_id);
                const color = state.types.find(t => t.id === e.type_id)?.color || '#334155';
                const loc = state.locations.find((l) => l.id === e.location_id);
                const att = state.attendants.find((a) => a.id === e.attendant_id);
                const isPast = isEventPast(e.date, e.time);
                const isHighlighted = state.highlightedItemId === e.id;

                const typeNameLower = (type?.name || '').toLowerCase();
                const isBatismo = typeNameLower.includes('batismo');
                const isSantaCeia = typeNameLower.includes('santa ceia');
                const hasStats = isBatismo || isSantaCeia;
                const total = (e.irmaos || 0) + (e.irmas || 0);
                const isTemp = String(e.id).startsWith('temp_');

                return `
                                    <li id="item-${e.id}" onclick="${state.isAdmin ? `window.openEditEvent('${e.id}')` : ''}" class="relative p-3 transition-all ${isHighlighted ? 'bg-yellow-50 ring-2 ring-yellow-400 ring-inset z-10 highlight-item' : state.isAdmin ? 'active:bg-slate-50' : ''} ${isPast && !isHighlighted ? 'bg-slate-50/50 grayscale-[0.5] opacity-70' : ''}">
                                        
                                        <div class="absolute top-3 right-3 flex flex-col items-end gap-1.5 z-10">
                                            <div class="flex items-center gap-1.5">
                                                ${isTemp ? `<div class="temp-badge"><i data-lucide="cloud-off" class="w-2.5 h-2.5"></i> Pendente</div>` : ''}
                                                <span class="text-[9px] font-black bg-navy text-white px-1.5 py-0.5 rounded uppercase tracking-tighter shadow-sm">
                                                    ${type?.sigla || 'EVT'}
                                                </span>
                                            </div>
                                            ${hasStats ? `
                                                <div class="flex flex-col items-end text-[12.15px] font-semibold text-slate-400 leading-tight mt-1">
                                                    <div>Irmãs: ${e.irmas || 0}</div>
                                                    <div>Irmãos: ${e.irmaos || 0}</div>
                                                    <div>Total: ${total}</div>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${isPast ? 'bg-slate-200 text-slate-500' : 'bg-blue-50 text-navy border border-blue-100'}">
                                                <i data-lucide="${isPast ? 'check-circle' : 'calendar-clock'}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 pr-16 flex flex-col justify-center">
                                                <div class="font-bold text-navy text-[16.2px] leading-tight whitespace-normal">${type?.name || 'Evento'}</div>
                                                <div class="text-[12.15px] font-semibold text-slate-600 mt-1 leading-tight">${formatDate(e.date)} - ${e.time}</div>
                                                <div class="flex flex-col gap-1 mt-1 leading-tight">
                                                    <div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${loc?.localidade || ''}</span></div>
                                                    <div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${att?.name || ''}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `;
            }).join('')}
                        </ul>
                    `}
                </div>
            `;

            const labelEl = document.getElementById('home-filter-label');
            if (labelEl) {
                let currentSize = 13;
                labelEl.style.fontSize = currentSize + 'px';
                while (labelEl.scrollHeight > 34 && currentSize > 9) {
                    currentSize -= 0.2;
                    labelEl.style.fontSize = currentSize + 'px';
                }
            }
            renderIcons();

            if (state.highlightedItemId) {
                setTimeout(() => {
                    const el = document.getElementById(`item-${state.highlightedItemId}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        };

        window.updateManagerListUI = (coll) => {
            const container = document.getElementById('manager-items-container');
            const stats = document.getElementById('manager-list-stats');
            if (!container || !stats) return;

            let itemIcon = 'tag';
            if (coll === 'locations') itemIcon = 'map-pin';
            if (coll === 'attendants') itemIcon = 'user';
            if (coll === 'feriados') itemIcon = 'sun';
            if (coll === 'perfis') itemIcon = 'shield-check';

            const items = [...(state[coll] || [])];
            items.sort((a, b) => {
                if (coll === 'feriados') return (a.data || '').localeCompare(b.data || '');
                const nameA = (coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '';
                const nameB = (coll === 'locations' ? b.localidade : (coll === 'perfis' ? b.nome : b.name)) || '';
                return nameA.localeCompare(nameB, 'pt-BR', { sensitivity: 'base' });
            });
            const term = (state.managerSearchTerm || '').toLowerCase();
            const filtered = items.filter((i) => {
                if (coll === 'types') return (i.name || '').toLowerCase().includes(term) || (i.sigla || '').toLowerCase().includes(term);
                if (coll === 'locations') return (i.localidade || '').toLowerCase().includes(term) || (i.adm || '').toLowerCase().includes(term) || (i.setor || '').toLowerCase().includes(term) || (i.cidade || '').toLowerCase().includes(term);
                if (coll === 'attendants') return (i.name || '').toLowerCase().includes(term) || (i.ministerio || '').toLowerCase().includes(term);
                if (coll === 'feriados') return (i.nome_feriado || '').toLowerCase().includes(term) || (i.tipo_feriado || '').toLowerCase().includes(term) || (i.data || '').toLowerCase().includes(term);
                if (coll === 'perfis') return (i.nome || '').toLowerCase().includes(term) || (i.permissao || '').toLowerCase().includes(term);
                return false;
            });

            stats.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${filtered.length} REGISTROS</span>`;
            container.innerHTML = filtered.length === 0 ? '<div class="p-12 text-center text-slate-300 italic text-sm">Nenhum registro encontrado.</div>' : filtered.map((item) => {
                let badgesHtml = "";
                const mainName = (coll === 'locations' ? item.localidade : (coll === 'feriados' ? item.nome_feriado : (coll === 'perfis' ? item.nome : item.name))) || '';
                if (coll === 'locations') {
                    const line2 = [item.adm, item.setor, item.cidade].filter(Boolean).join(' | ');
                    const anciaes = [item.anciao_1, item.anciao_2, item.anciao_3].filter(Boolean).join(' - ');
                    const diaconos = [item.diacono_1, item.diacono_2, item.diacono_3].filter(Boolean).join(' - ');
                    const cooperadores = [item.com_1, item.com_2].filter(Boolean).join(' - ');
                    badgesHtml = `
                        <div class="text-[11px] text-slate-600 font-medium leading-tight mt-1">${line2}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-1">ANC: ${anciaes || '---'}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">DCN: ${diaconos || '---'}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">COM: ${cooperadores || '---'}</div>
                        ${item.cjm ? `<div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">CJE: ${item.cjm}</div>` : ''}
                    `;
                } else if (coll === 'types') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.sigla || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3"></div>`;
                } else if (coll === 'attendants') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.ministerio || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3"></div>`;
                } else if (coll === 'feriados') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.tipo_feriado || ''}</div><div class="text-[11px] text-slate-400 font-semibold leading-tight mt-0.5 h-3">${formatDateFull(item.data) || ''}</div>`;
                } else if (coll === 'perfis') {
                    const isAuth = item.autorizado === true;
                    const role = item.permissao === 'admin' ? 'Administrador' : 'Leitura';
                    badgesHtml = `<div class="text-[11px] font-bold leading-tight mt-1 ${isAuth ? 'text-green-600' : 'text-orange-500'}">${isAuth ? 'AUTORIZADO' : 'PENDENTE'}</div><div class="text-[10px] text-slate-400 font-semibold uppercase tracking-tighter mt-0.5">${role}</div>`;
                }
                const isHighlighted = state.highlightedItemId === item.id;
                const isTemp = String(item.id).startsWith('temp_');
                const safeMainName = (mainName || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");

                return `
                    <div id="item-${item.id}" class="p-4 flex items-center justify-between hover:bg-slate-50 transition-all ${isHighlighted ? 'bg-yellow-50 highlight-item ring-2 ring-yellow-400 ring-inset' : ''}">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center shrink-0 border border-blue-100 relative">
                                <i data-lucide="${itemIcon}" class="w-5 h-5 text-navy"></i>
                                ${isTemp ? `<div class="absolute -top-1 -right-1 bg-orange-500 text-white rounded-full p-0.5"><i data-lucide="cloud-off" class="w-2 h-2"></i></div>` : ''}
                            </div>
                            <div class="min-w-0 flex flex-col justify-center">
                                <div class="font-bold text-navy text-sm leading-tight flex items-center gap-2">
                                    ${mainName}
                                </div>
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="flex gap-1 ml-4 shrink-0">
                            ${state.isAdmin ? `
                                <button onclick="window.openRowModal('${coll}', '${item.id}')" class="p-2.5 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="window.requestDeleteRow('${item.id}', '${coll}', '${safeMainName}')" class="p-2.5 text-red-400 hover:bg-red-100 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            ` : ''}
                        </div>
                    </div>`;
            }).join('');
            renderIcons();
            if (state.highlightedItemId) {
                setTimeout(() => { const el = document.getElementById(`item-${state.highlightedItemId}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
            }
        };

        function renderHome() {
            const app = document.getElementById('app');
            if (!app) return;

            if (!state.user) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <div class="w-7 h-7"></div>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-blue-50 text-navy rounded-3xl flex items-center justify-center border border-blue-100 shadow-sm"><i data-lucide="lock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Acesso Restrito</h2>
                                <p class="text-sm text-slate-500 mt-2">Faça login para visualizar a agenda de eventos.</p>
                            </div>
                            <button onclick="window.showLoginModal()" class="bg-navy text-white px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Fazer Login</button>
                        </div>
                    </div>
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            if (!state.isAuthorized) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <button onclick="window.handleLogout()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-orange-50 text-orange-custom rounded-3xl flex items-center justify-center border border-orange-100 shadow-sm animate-pulse"><i data-lucide="clock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Aguardando Autorização</h2>
                                <p class="text-sm text-slate-500 mt-2">Seu cadastro foi realizado com sucesso. Aguarde até que um administrador aprove seu acesso.</p>
                            </div>
                            <div class="p-4 bg-white border border-slate-200 rounded-2xl w-full max-w-xs shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Status Atual</span>
                                <span class="text-xs font-bold text-orange-500 uppercase">Pendente</span>
                            </div>
                            <button onclick="window.handleLogout()" class="mt-8 px-8 py-3 bg-red-600 text-white rounded-xl text-xs font-black uppercase tracking-widest flex items-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</button>
                        </div>
                    </div>
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            app.innerHTML = `
                <div id="home-container" class="flex flex-col h-full bg-slate-100 relative">
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                    <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                        <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                        <button onclick="window.resetAllFilters()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="flex gap-2">
                            <button onclick="window.startOpenAgenda()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> AGENDA</button>
                            <button onclick="window.resetAllFilters()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="list" class="w-3.5 h-3.5"></i> TODOS</button>
                            <button onclick="window.openFastFilterModal()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="filter" class="w-3.5 h-3.5"></i> FILTRO</button>
                            <button onclick="window.openPDFPreview()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> EXPORTAR</button>
                        </div>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input id="homeSearch" type="text" placeholder="Pesquisar evento, local ou atendente..." class="w-full pl-10 pr-3 h-10 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-navy/10" value="${state.searchTerm || ''}">
                                <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            </div>
                            <button onclick="window.renderAdvancedFilterModal()" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-navy shadow-sm active:bg-slate-50 relative">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                                ${state.advancedFilter.active ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-orange-custom rounded-full border-2 border-white"></span>' : ''}
                            </button>
                        </div>
                        <div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div>
                    </div>
                    ${state.isAdmin ? `<button onclick="window.startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center z-50 border-2 border-white/20"><i data-lucide="plus" class="w-8 h-8"></i></button>` : ''}
                </div>
            `;

            document.getElementById('homeSearch')?.addEventListener('input', (e) => { state.searchTerm = e.target.value; });
            window.updateHomeList();
        }

        function getFilteredEvents() {
            if (!state.isAuthorized) return [];
            let filtered = [...(state.events || [])];

            if (state.selectedDate) {
                filtered = filtered.filter((e) => e.date === state.selectedDate);
            } else if (state.fastFilter?.active) {
                if (state.fastFilter.dateStart) filtered = filtered.filter((e) => e.date >= state.fastFilter.dateStart);
                if (state.fastFilter.dateEnd) filtered = filtered.filter((e) => e.date <= state.fastFilter.dateEnd);
            }

            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                if (af.eventos.enabled) {
                    filtered = filtered.filter((e) => {
                        const isPast = isEventPast(e.date, e.time);
                        return af.eventos.status === 'ativos' ? !isPast : isPast;
                    });
                }
                if (af.type.enabled && af.type.id) {
                    filtered = filtered.filter((e) => e.type_id === af.type.id);
                }
                if (af.attendant.enabled && af.attendant.id) {
                    filtered = filtered.filter((e) => e.attendant_id === af.attendant.id);
                }
                if (af.adm.enabled && af.adm.value) {
                    const validLocs = state.locations.filter((l) => l.adm === af.adm.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.setor.enabled && af.setor.value) {
                    const validLocs = state.locations.filter((l) => l.setor === af.setor.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.cidade.enabled && af.cidade.value) {
                    const validLocs = state.locations.filter((l) => l.cidade === af.cidade.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.location.enabled && af.location.id) {
                    filtered = filtered.filter((e) => e.location_id === af.location.id);
                }
                if (af.period.enabled) {
                    if (af.period.start) filtered = filtered.filter((e) => e.date >= af.period.start);
                    if (af.period.end) filtered = filtered.filter((e) => e.date <= af.period.end);
                }
            }

            if (state.searchTerm) {
                const term = (state.searchTerm || '').toLowerCase();
                filtered = filtered.filter((e) => {
                    const typeObj = state.types.find((t) => t.id === e.type_id);
                    const typeName = (typeObj?.name || '').toLowerCase();
                    const typeSigla = (typeObj?.sigla || '').toLowerCase();
                    const locObj = state.locations.find((l) => l.id === e.location_id);
                    const loc = (locObj?.localidade || '').toLowerCase();
                    const termAtt = state.attendants.find((a) => a.id === e.attendant_id)?.name?.toLowerCase() || '';
                    return typeName.includes(term) || typeSigla.includes(term) || loc.includes(term) || termAtt.includes(term);
                });
            }

            return filtered.sort((a, b) => (a.date || '').localeCompare(b.date || '') || (a.time || '').localeCompare(b.time || ''));
        }

        function getFilterDescription() {
            if (state.selectedDate) return `Agenda: ${formatDateFull(state.selectedDate)}`;
            if (state.fastFilter?.active) return state.fastFilter.label || 'Filtro Ativo';

            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                const parts = [];
                if (af.eventos.enabled) parts.push(af.eventos.status === 'ativos' ? 'Ativos' : 'Inativos');
                if (af.type.enabled && af.type.id) {
                    const type = state.types.find((t) => t.id === af.type.id);
                    if (type) parts.push(type.name);
                }
                if (af.attendant.enabled && af.attendant.id) {
                    const att = state.attendants.find((a) => a.id === af.attendant.id);
                    if (att) parts.push(att.name);
                }
                const locChain = [];
                if (af.adm.enabled && af.adm.value) locChain.push(af.adm.value);
                if (af.setor.enabled && af.setor.value) {
                    const cleanSetor = af.setor.value.replace(/setor\s+/gi, '');
                    locChain.push(`Setor ${cleanSetor}`);
                }
                if (af.cidade.enabled && af.cidade.value) locChain.push(af.cidade.value);
                if (af.location.enabled && af.location.id) {
                    const loc = state.locations.find((l) => l.id === af.location.id);
                    if (loc) locChain.push(loc.localidade);
                }
                if (locChain.length > 0) parts.push(locChain.join(' > '));
                if (af.period.enabled && af.period.start && af.period.end) {
                    parts.push(`${formatDate(af.period.start)} a ${formatDate(af.period.end)}`);
                }
                return parts.length > 0 ? parts.join(' | ') : 'Todos os Eventos';
            }

            if (state.searchTerm) return `Busca: ${state.searchTerm}`;
            return 'Todos os Eventos';
        }

        function renderNavMenu() {
            if (!state.isMenuOpen) return '';

            const baseItems = [
                { id: 'home', icon: 'home', label: 'Início' }
            ];

            if (state.isAuthorized) {
                baseItems.push(
                    { id: 'types', icon: 'tag', label: 'Tipos de Evento' },
                    { id: 'locations', icon: 'map-pin', label: 'Localidades' },
                    { id: 'attendants', icon: 'users', label: 'Atendentes' },
                    { id: 'feriados', icon: 'sun', label: 'Feriados' }
                );
            }

            const adminItems = (state.isAdmin && state.isAuthorized) ? [
                { id: 'users', icon: 'shield-check', label: 'Gestão de Usuários' }
            ] : [];

            const footerItems = [
                { id: 'about', icon: 'info', label: 'Sobre' }
            ];

            const menuItems = [...baseItems, ...adminItems, ...footerItems];

            const userName = state.user?.user_metadata?.full_name || state.user?.email || 'Usuário';

            return `
                <div class="fixed inset-0 z-50 flex">
                    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeMenu()"></div>
                    <div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl">
                        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#002855]">
                            <h2 class="text-xl font-bold tracking-tight">Menu</h2>
                            <button onclick="window.closeMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="x"></i></button>
                        </div>
                        <nav class="flex-1 py-4 flex flex-col gap-1 overflow-y-auto scrollbar-none">
                            ${menuItems.map(item => `
                                <button onclick="window.navigateTo('${item.id}')" class="w-full flex items-center px-6 py-4 hover:bg-white/10 gap-4 border-l-4 border-transparent hover:border-orange-custom transition-all">
                                    <i data-lucide="${item.icon}" class="text-orange-custom w-5 h-5"></i>
                                    <span class="font-medium">${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        <div class="p-4 border-t border-white/10 bg-[#002244]">
                            ${state.user ? `
                                <div class="mb-4 px-2">
                                    ${state.isAdmin ? `<div class="text-[9px] font-black text-orange-custom uppercase tracking-widest mb-0.5">Administrador</div>` : ''}
                                    <div class="text-sm font-bold text-white truncate max-w-full">${userName}</div>
                                </div>
                                <button onclick="window.handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600/20 text-red-200 rounded-lg font-bold border border-red-500/30 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</button>
                            ` : `
                                <button onclick="window.showLoginModal()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg font-bold hover:bg-white/20 border border-white/10"><i data-lucide="lock" class="w-4 h-4"></i> Login </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Helpers de Otimização (Passo 4) ---

        const apiClient = {
            get: async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    return await response.json();
                } catch (e) {
                    console.error("[apiClient] Fetch error:", e);
                    throw e;
                }
            }
        };

        function renderFormFields(schema, values = {}, validationErrors = []) {
            let html = '';
            const fields = Object.entries(schema.fields)
                .filter(([k, f]) => !f.readonly && f.type !== 'system')
                .sort((a, b) => (a[1].listPriority || 99) - (b[1].listPriority || 99));

            // Custom ordering for Agenda if needed, or rely on schema definition order
            // For Agenda: Date, Time, Local, Type, Attendant, (Irmaos/Irmas)

            fields.forEach(([key, field]) => {
                const val = values[key] ?? field.defaultValue ?? '';
                const errClass = validationErrors.includes(key) ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-slate-50';
                let input = '';

                if (key === 'irmaos' || key === 'irmas') return; // Special handling for counters

                if (field.type === 'ref') {
                    const relatedTable = field.refTable;
                    const relatedItem = state[relatedTable]?.find(i => String(i.id) === String(val));
                    let displayLabel = `Selecionar ${field.label}`;
                    if (relatedItem) {
                        displayLabel = relatedItem.name || relatedItem.localidade || relatedItem.nome || relatedItem.nome_feriado;
                    }

                    input = `<button onclick="window.openSelectPicker('${relatedTable}', '${field.label}', '${key === 'location_id' ? 'formTempLoc' : (key === 'type_id' ? 'formTempType' : 'formTempAtt')}')" class="flex items-center gap-2 border ${errClass} p-3 rounded-lg text-left text-sm font-medium text-navy w-full transition-colors group active:scale-[0.98]">
                                 <i data-lucide="${relatedTable === 'locations' ? 'map-pin' : (relatedTable === 'types' ? 'tag' : 'users')}" class="w-4 h-4 opacity-50 group-hover:text-orange-custom transition-colors"></i>
                                 <span class="truncate">${displayLabel}</span>
                                 <i data-lucide="chevron-down" class="w-4 h-4 opacity-30 ml-auto"></i>
                               </button>`;
                }
                else if (field.type === 'date') {
                    input = `<button onclick="window.openFormDate()" class="flex items-center gap-2 border ${errClass} p-3 rounded-lg text-left text-sm font-medium text-navy w-full transition-colors active:scale-[0.98]">
                                 <i data-lucide="calendar" class="w-4 h-4 opacity-50"></i>
                                 <span>${val ? formatDate(val) : 'Selecionar Data'}</span>
                               </button>`;
                }
                else if (field.type === 'time') {
                    input = `<button onclick="window.openTimePickerModal()" class="flex items-center gap-2 border ${errClass} p-3 rounded-lg text-left text-sm font-medium text-navy w-full transition-colors active:scale-[0.98]">
                                 <i data-lucide="clock" class="w-4 h-4 opacity-50"></i>
                                 <span>${val || '00:00'}</span>
                               </button>`;
                }
                else {
                    input = `<input id="event-${key}" type="${field.type}" class="w-full border p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${val}" placeholder="${field.label}">`;
                }

                html += `<div class="flex flex-col gap-1 mb-3">
                             <label class="label-sm">${field.label} ${field.required === false ? '<span class="text-slate-300 font-bold normal-case text-[9px]">(opcional)</span>' : ''}</label>
                             ${input}
                          </div>`;
            });
            return html;
        }

        function renderEventForm() {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const isEditing = !!state.editingEventId;
            const app = document.getElementById('app');
            if (!app) return;

            // Prepare Data for Helper
            const schema = { ...TableSchema.agenda };
            // Paranoid filter to ensure no Type fields leak into Event form (addressing user report)
            const cleanFields = {};
            Object.entries(schema.fields).forEach(([k, v]) => {
                if (!['color', 'icon', 'cor'].includes(k)) cleanFields[k] = v;
            });
            schema.fields = cleanFields;
            const values = {
                date: state.formTempDate,
                time: state.formTempTime,
                location_id: state.formTempLoc,
                type_id: state.formTempType,
                attendant_id: state.formTempAtt,
                irmaos: state.formTempIrmaos,
                irmas: state.formTempIrmas
            };

            // Logic for Stats Visibility
            const selectedType = state.types.find((t) => t.id === state.formTempType);
            const typeName = (selectedType?.name || '').toLowerCase();
            const showCounters = typeName.includes('batismo') || typeName.includes('santa ceia');

            // Dirty Check
            let hasChanges = !isEditing;
            if (isEditing && state.originalEventSnapshot) {
                const snap = state.originalEventSnapshot;
                if (values.date !== snap.date || values.time !== snap.time ||
                    String(values.location_id) !== String(snap.location_id) ||
                    String(values.type_id) !== String(snap.type_id) ||
                    String(values.attendant_id || '') !== String(snap.attendant_id || '') ||
                    parseInt(values.irmaos || '0') !== (snap.irmaos || 0) ||
                    parseInt(values.irmas || '0') !== (snap.irmas || 0)) {
                    hasChanges = true;
                }
            }

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide text-sm">${isEditing ? 'Editar' : 'Novo'} Evento</h1>
                    </div>
                    <div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="bg-white p-5 rounded-xl shadow-md flex flex-col">
                            ${renderFormFields(schema, values, state.formErrors)}
                            
                            <div class="${showCounters ? '' : 'hidden'} grid grid-cols-2 gap-3 transition-all duration-300 mt-1">
                                <div class="flex flex-col gap-1">
                                    <label class="label-sm">Irmãos</label>
                                    <input type="number" oninput="window.state.formTempIrmaos = this.value" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${values.irmaos || ''}" placeholder="0">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="label-sm">Irmãs</label>
                                    <input type="number" oninput="window.state.formTempIrmas = this.value" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${values.irmas || ''}" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2 mt-6">
                                ${isEditing ? `
                                    ${hasChanges ? `
                                        <button onclick="window.saveEvent()" class="btn-primary">SALVAR ALTERAÇÕES ${!navigator.onLine ? '(OFFLINE)' : ''}</button>
                                    ` : `
                                        <button onclick="window.navigateTo('home')" class="btn-secondary">CANCELAR E VOLTAR</button>
                                    `}
                                    <button onclick="window.requestDeleteEvent('${state.editingEventId}')" class="text-red-600 p-3 text-xs font-bold border border-red-100 rounded-lg bg-red-50/30 flex items-center justify-center gap-2 active:bg-red-100 transition-colors uppercase tracking-widest"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir Evento</button>
                                ` : `
                                    <button onclick="window.saveEvent()" class="btn-primary">SALVAR EVENTO ${!navigator.onLine ? '(OFFLINE)' : ''}</button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderGenericManager(title, collection) {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const app = document.getElementById('app');
            if (!app) return;

            let searchPlaceholder = "Buscar...";
            if (collection === 'locations') searchPlaceholder = "Pesq. por adm, setor, cidade, localidade";
            else if (collection === 'types') searchPlaceholder = "Pesquisar por nome ou sigla...";
            else if (collection === 'attendants') searchPlaceholder = "Pesquisar por nome ou ministério...";
            else if (collection === 'feriados') searchPlaceholder = "Pesquisar por nome ou tipo...";
            else if (collection === 'perfis') searchPlaceholder = "Pesquisar por nome ou permissão...";

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm">${title}</h1>
                        </div>
                        <button onclick="window.resetAllFilters(); window.navigateTo('home')" class="p-2 hover:bg-white/10 rounded"><i data-lucide="home" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4 flex flex-col gap-4 flex-1 overflow-hidden max-w-xl mx-auto w-full">
                        <div class="relative">
                            <input id="managerSearch" type="text" placeholder="${searchPlaceholder}" class="w-full pl-10 pr-4 py-2.5 border-2 border-blue-200 rounded-xl text-sm font-medium shadow-sm transition-all focus:border-blue-500 bg-white" value="${state.managerSearchTerm || ''}">
                            <i data-lucide="search" class="absolute left-3.5 top-3.5 text-blue-300 w-4 h-4"></i>
                        </div>
                        <div id="manager-list-stats" class="flex justify-end pr-1 -mt-2"></div>
                        <div id="manager-items-container" class="flex-1 overflow-y-auto mb-1 bg-white rounded-2xl border border-slate-200 shadow-sm divide-y divide-slate-100 scrollbar-none"></div>
                        ${(state.isAdmin && collection !== 'perfis') ? `
                            <div class="flex justify-center pb-2">
                                <button onclick="window.openRowModal('${collection}')" class="bg-navy text-white px-8 py-2.5 rounded-xl font-black shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all border-2 border-white/10 w-full text-xs uppercase tracking-widest">
                                    <i data-lucide="${!navigator.onLine ? 'cloud-off' : 'plus'}" class="w-4 h-4"></i> ADICIONAR ${!navigator.onLine ? 'OFFLINE' : ''}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('managerSearch')?.addEventListener('input', (e) => {
                state.managerSearchTerm = e.target.value;
                state.highlightedItemId = null;
                window.updateManagerListUI(collection);
            });
            window.updateManagerListUI(collection);
        }

        function renderAbout() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide text-sm">Sobre</h1>
                    </div>
                    <div class="p-8 flex flex-col items-center text-center flex-1 justify-center">
                        <div class="w-20 h-20 bg-navy rounded-3xl flex items-center justify-center shadow-lg mb-6"><i data-lucide="calendar" class="w-10 h-10 text-white"></i></div>
                        <h2 class="text-2xl font-black text-navy uppercase tracking-tighter">Agenda CCB</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">v1.4.0 Vanilla JS</p>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mt-8 max-w-xs">
                            <p class="text-sm text-slate-600">Sistema oficial de agenda administrativa para controle de eventos e localidades com suporte a gestão de ADM e Setores.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendar(mode) {
            const viewDate = new Date(state.viewDate);
            const month = viewDate.getMonth();
            const year = viewDate.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            loadExternalHolidays(year);
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);
            const fmt = (d) => `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            let currentSelected = '';
            if (mode === 'filter') currentSelected = state.selectedDate || '';
            else if (mode === 'picker') currentSelected = state.formTempDate || '';
            else if (mode === 'adv_start') currentSelected = state.advancedFilter.period.start || '';
            else if (mode === 'adv_end') currentSelected = state.advancedFilter.period.end || '';
            else if (mode === 'feriado_picker') currentSelected = document.getElementById('feriado-date-val')?.value || '';

            const eventDots = {};
            state.events.forEach((e) => {
                const datePart = e.date.substring(0, 7);
                if (datePart === `${year}-${String(month + 1).padStart(2, '0')}`) eventDots[e.date] = (eventDots[e.date] || 0) + 1;
            });

            const monthHolidays = [...state.externalHolidays.filter((h) => {
                const d = new Date(h.date + 'T00:00:00');
                return d.getMonth() === month && d.getFullYear() === year;
            }), ...state.feriados.filter((f) => {
                const d = new Date(f.data + 'T00:00:00');
                return d.getMonth() === month && d.getFullYear() === year;
            })].sort((a, b) => (a.date || a.data).localeCompare(b.date || b.data));

            const holidayLegendItems = monthHolidays.map(h => {
                const dateStr = h.date || h.data;
                const day = parseInt(dateStr.split('-')[2]);
                return `<span class="whitespace-nowrap"><span class="font-bold text-red-500">${day}</span> - ${h.name || h.nome_feriado}</span>`;
            }).join(' <span class="text-slate-300 mx-2">|</span> ');

            let title = mode === 'filter' ? 'Agenda' : 'Selecionar Data';
            if (mode === 'adv_start') title = 'Data de Início';
            if (mode === 'adv_end') title = 'Data do Fim';

            let contentHtml = `<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col max-h-[95vh]"><div class="p-3 flex justify-between items-center border-b border-slate-50 bg-white shrink-0"><div class="flex items-center gap-2 text-navy"><i data-lucide="calendar" class="w-4 h-4"></i><h3 class="text-base font-black tracking-tight uppercase">${title}</h3></div><button onclick="${(mode === 'adv_start' || mode === 'adv_end') ? 'window.renderAdvancedFilterModal()' : mode === 'feriado_picker' ? 'window.returnToFeriadoModal()' : 'window.closeModal()'}" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-3 overflow-y-auto scrollbar-none"><div class="flex justify-between items-center mb-3 px-1"><button onclick="window.changeMonth(-1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex gap-2 font-black text-[14px] uppercase tracking-widest text-navy"><button onclick="window.openMonthPicker('${mode}')" class="hover:text-orange-custom">${monthNames[month]}</button><button onclick="window.openYearPicker('${mode}')" class="hover:text-orange-custom">${year}</button></div><button onclick="window.changeMonth(1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 text-center text-[11px] font-black uppercase tracking-widest text-slate-400 mb-2"><span class="text-red-500">D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span></div><div class="grid grid-cols-7 gap-y-1.5 text-center items-center justify-items-center">${days.map(d => { if (!d) return '<div></div>'; const fullDate = fmt(d); const isToday = fullDate === new Date().toISOString().split('T')[0]; const isHoliday = state.externalHolidays.some((h) => h.date === fullDate) || state.feriados.some((f) => f.data === fullDate); return `<div class="flex flex-col items-center gap-0.5"><button onclick="window.selectCalendarDate('${fullDate}', '${mode}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-xs font-bold transition-all relative ${fullDate === currentSelected ? 'bg-navy text-white shadow-md' : isToday ? 'text-green-600 border border-green-100' : (new Date(year, month, d).getDay() === 0 || isHoliday) ? 'text-red-500' : 'text-slate-600 hover:bg-slate-50'}">${d}</button><div class="flex gap-0.5 h-1.5 items-center justify-center">${(eventDots[fullDate] || 0) > 0 ? Array(Math.min(eventDots[fullDate], 4)).fill(0).map(() => `<span class="w-1 h-1 rounded-full ${fullDate === currentSelected ? 'bg-orange-custom' : 'bg-navy'}"></span>`).join('') : ''}</div></div>`; }).join('')}</div></div>${holidayLegendItems ? `<div class="px-4 py-2 border-t border-slate-50 bg-slate-50/40 shrink-0"><div class="flex flex-wrap gap-y-1 text-[11px] items-center">${holidayLegendItems}</div></div>` : ''}`;

            if (mode === 'filter' && state.selectedDate) {
                const dayEvents = state.events.filter((e) => e.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
                contentHtml += `<div class="flex flex-col border-t border-slate-100 shrink-0"><div class="px-4 py-1.5 flex justify-between items-center bg-slate-50/50"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">EVENTOS: ${formatDate(state.selectedDate)}</span></div><div class="flex flex-col divide-y divide-slate-100 max-h-[160px] overflow-y-auto scrollbar-none bg-white">${dayEvents.length === 0 ? '<div class="text-center text-slate-300 py-6 text-[10px] font-medium italic">Nenhum evento programado</div>' : dayEvents.map((e) => {
                    const loc = state.locations.find((l) => l.id === e.location_id)?.localidade || '';
                    const att = state.attendants.find((a) => a.id === e.attendant_id)?.name || '';
                    return `<div class="p-2.5 flex flex-col gap-0.5 active:bg-slate-50 transition-colors relative group"><div class="flex items-center gap-2"><span class="text-[11px] font-black text-navy shrink-0">${e.time}</span><span class="text-[11px] font-bold text-slate-800 leading-tight">${state.types.find((t) => t.id === e.type_id)?.name || 'Evento'}</span></div><div class="flex items-center gap-3 pr-10"><div class="text-[9px] text-slate-400 font-medium flex items-center gap-1"><i data-lucide="map-pin" class="w-2 h-2 shrink-0"></i> <span>${loc} ${att ? '| ' + att : ''}</span></div></div><div class="absolute bottom-2 right-3 bg-navy text-white text-[7px] font-black px-1 py-0.5 rounded uppercase tracking-tighter shrink-0 shadow-sm">${state.types.find((t) => t.id === e.type_id)?.sigla || 'EVT'}</div></div>`;
                }).join('')}</div><div class="p-3 bg-white border-t border-slate-50"><button onclick="window.applyCalendarAndClose()" class="w-full bg-navy text-white py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg shadow-navy/20 active:scale-95 transition-all"><i data-lucide="list" class="w-3.5 h-3.5"></i> Ver na Lista</button></div></div>`;
            }
            contentHtml += `</div>`;
            showModal(contentHtml);
        }

        function renderClockUI() {
            const isH = state.clockMode === 'hour';
            const values = isH ? ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'] : ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
            showModal(`<div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md overflow-hidden"><div class="flex justify-center items-center gap-4 mb-8"><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'hour'" class="text-4xl font-black ${isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempHour || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Hora</span></div><span class="text-4xl font-black text-slate-200 mb-5">:</span><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'minute'" class="text-4xl font-black ${!isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempMinute || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Min</span></div></div><div class="grid grid-cols-4 gap-3">${values.map(v => `<button onclick="window.selectClockValue('${v}')" class="aspect-square flex items-center justify-center rounded-2xl font-bold text-sm transition-all ${(isH ? state.clockTempHour === v : state.clockTempMinute === v) ? 'bg-navy text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}">${v}</button>`).join('')}</div><div class="flex gap-3 mt-8"><button onclick="window.closeModal()" class="flex-1 py-4 text-slate-400 font-bold text-xs uppercase tracking-widest">Cancelar</button><button onclick="window.confirmClockTime()" class="flex-2 bg-navy text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">OK</button></div></div>`);
        }

        function renderAdvancedFilterModal() {
            const af = state.advancedFilter;
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const errs = af.validationErrors || [];

            let selMonthLabel = 'Mês';
            let selYearLabel = 'Ano';
            if (af.period.enabled && af.period.start) {
                const d = new Date(af.period.start + 'T00:00:00');
                const dEnd = new Date(af.period.end + 'T00:00:00');
                const isFullMonth = d.getDate() === 1 && dEnd.getDate() === new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate() && d.getMonth() === dEnd.getMonth();
                const isFullYear = d.getDate() === 1 && d.getMonth() === 0 && dEnd.getDate() === 31 && dEnd.getMonth() === 11;
                if (isFullYear) { selYearLabel = d.getFullYear().toString(); selMonthLabel = 'Mês'; }
                else if (isFullMonth) { selMonthLabel = monthNames[d.getMonth()]; selYearLabel = d.getFullYear().toString(); }
            }

            state.searchTerm = '';
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-center gap-2 text-navy"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i><h3 class="text-lg font-black tracking-tight uppercase">Filtros Avançados</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="adv-filter-scroll-container" class="p-6 flex flex-col gap-5 overflow-y-auto scrollbar-none"><div id="adv-sec-eventos" class="flex flex-col gap-3"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('eventos')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status dos Eventos</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.eventos.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.eventos.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.eventos.enabled ? `<div class="flex bg-slate-100 p-1 rounded-xl"><button onclick="window.setAdvFilterStatus('ativos'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'ativos' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">ATIVOS</button><button onclick="window.setAdvFilterStatus('passados'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'passados' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">INATIVOS</button></div>` : ''}</div><div id="adv-sec-type" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('type')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Tipo</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.type.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.type.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.type.enabled ? `<button onclick="window.openSelectPicker('types', 'Tipo', 'adv_type')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('type') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span class="truncate">${state.types.find((t) => t.id === af.type.id)?.name || 'Selecionar Tipo...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div id="adv-sec-adm" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('adm')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por ADM</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.adm.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.adm.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.adm.enabled ? `<button onclick="window.openDistinctPicker('adm')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('adm') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors mb-2"><span>${af.adm.value || 'Selecionar ADM...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.adm.value ? `<div id="adv-sec-setor" class="flex flex-col gap-2 mt-2 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('setor')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Setor</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.setor.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.setor.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.setor.enabled ? `<button onclick="window.openDistinctPicker('setor')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('setor') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.setor.value || 'Selecionar Setor...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.setor.value ? `<div id="adv-sec-cidade" class="flex flex-col gap-2 mt-4 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('cidade')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Cidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.cidade.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.cidade.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.cidade.enabled ? `<button onclick="window.openDistinctPicker('cidade')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('cidade') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.cidade.value || 'Selecionar Cidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>` : ''}` : ''}</div>` : ''}` : ''}</div><div id="adv-sec-location" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('location')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Localidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.location.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.location.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.location.enabled ? `<button onclick="window.openSelectPicker('locations', 'Local', 'adv_location')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('location') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.locations.find((l) => l.id === af.location.id)?.localidade || 'Selecionar Localidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div id="adv-sec-attendant" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('attendant')"><label class="text-[10px] font-black text-slate-400 uppercase ml-1 block uppercase tracking-widest">Filtrar por Atendente</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.attendant.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.attendant.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.attendant.enabled ? `<button onclick="window.openSelectPicker('attendants', 'Atendente', 'adv_attendant')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('attendant') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.attendants.find((a) => a.id === af.attendant.id)?.name || 'Selecionar Atendente...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div id="adv-sec-period" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('period')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Período</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.period.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.period.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.period.enabled ? `<div class="flex flex-col gap-2"><div class="grid grid-cols-2 gap-2"><button onclick="window.openDateRangePicker('start')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.start ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">Início</span><span class="truncate">${af.period.start ? formatDate(af.period.start) : 'Data...'}</span></button><button onclick="window.openDateRangePicker('end')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.end ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">Fim</span><span class="truncate">${af.period.end ? formatDate(af.period.end) : 'Data...'}</span></button></div><div class="grid grid-cols-2 gap-2"><button onclick="state.viewDate = (state.advancedFilter.period.start ? new Date(state.advancedFilter.period.start + 'T00:00:00') : new Date()); window.openMonthPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selMonthLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button><button onclick="window.openYearPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selYearLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button></div></div>` : ''}</div></div><div class="p-6 border-t border-slate-50 flex gap-3"><button onclick="window.clearAdvancedFilters()" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpar Filtro</button><button onclick="window.applyAdvancedFilters()" class="flex-1 bg-navy text-white py-2.5 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg shadow-navy/20 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
        }

        function openDistinctPicker(f) {
            const af = state.advancedFilter; let locs = [...state.locations];
            if (f === 'setor') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); }
            else if (f === 'cidade') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); if (af.setor.enabled && af.setor.value) locs = locs.filter(l => l.setor === af.setor.value); }
            const values = [...new Set(locs.map((l) => l[f]).filter((v) => v))].sort();
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${f.toUpperCase()}</h3></div><button onclick="window.renderAdvancedFilterModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="distinctItemsList" class="flex-1 overflow-y-auto px-2 pb-4 pt-2 scrollbar-none">${values.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum dado encontrado.</div>' : values.map(val => `<button onclick="window.handleAdvFilterSelect('${f}', '${val.replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="font-bold text-sm text-navy leading-tight">${val}</span>${af[f].value === val ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0"></i>' : ''}</button>`).join('')}</div></div>`);
            renderIcons();
        }

        function openInputPicker(coll, tit, targetId, fk, fv) {
            let items = [...state[coll]];
            if (fk && fv) {
                items = items.filter(i => (i[fk] || '').toLowerCase().includes(fv.toLowerCase()));
            }
            items.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="users" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${tit}</h3></div><div class="flex gap-2"><button onclick="window.selectInputPicker('${targetId}', '')" class="text-red-500 hover:text-red-700 font-bold text-xs uppercase tracking-wider px-2 py-1 border border-red-100 rounded-lg hover:bg-red-50 transition-colors">Limpar</button><button onclick="window.returnToRowModal()" class="text-slate-400 p-1"><i data-lucide="arrow-left" class="w-5 h-5"></i></button></div></div><div class="px-5 py-4"><div class="relative group"><input id="inpPickerSearch" type="text" placeholder="Buscar por nome..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium"><i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i></div></div><div id="inpPickerList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none">${items.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum registro encontrado.</div>' : items.map(i => `<button onclick="window.selectInputPicker('${targetId}', '${(i.name || '').replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-bold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="group-hover:text-navy transition-colors">${i.name}</span><i data-lucide="plus" class="w-4 h-4 text-slate-300 group-hover:text-orange-custom"></i></button>`).join('')}</div></div>`);

            document.getElementById('inpPickerSearch')?.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = items.filter(i => (i.name || '').toLowerCase().includes(term));
                document.getElementById('inpPickerList').innerHTML = filtered.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum registro encontrado.</div>' : filtered.map(i => `<button onclick="window.selectInputPicker('${targetId}', '${(i.name || '').replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-bold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="group-hover:text-navy transition-colors">${i.name}</span><i data-lucide="plus" class="w-4 h-4 text-slate-300 group-hover:text-orange-custom"></i></button>`).join('');
                renderIcons();
            });
            renderIcons();
        }

        function selectInputPicker(targetId, val) {
            // Update cache item directly because DOM elements are gone!
            const c = window.__row_modal_cache;
            if (c && c.item) {
                const key = targetId.replace('field-', '');
                c.item[key] = val;
            }
            // Set flag to focus this element upon return
            window.__focus_target_id = 'display-' + targetId;
            window.returnToRowModal();
        }

        function returnToRowModal() {
            const c = window.__row_modal_cache;
            if (c) window.openRowModal(c.table, c.id, c.item);
        }

        function openRowModal(table, id = null, item = null) {
            const schema = TableSchema[table];
            if (!schema) return;

            const isNew = !id || id === 'undefined' || id === '';
            const data = (item && Object.keys(item).length > 0) ? item : (isNew ? {} : state[table === 'agenda' ? 'events' : table].find(i => String(i.id) === String(id)));
            if (!data && !isNew) return;

            // Feriado Cache Logic (Original feature preservation)
            if (table === 'feriados') window.__feriado_modal_cache = { safeId: id, item: data };

            let fieldsHtml = '';

            // Grouping logic
            // Cache current form state for restoring after picker
            window.__row_modal_cache = { table, id, item: data };

            const groups = { default: [] };
            Object.entries(schema.fields).forEach(([key, field]) => {
                const g = field.group || 'default';
                if (!groups[g]) groups[g] = [];
                groups[g].push({ key, ...field });
            });

            // Sort Default Fields
            groups.default.sort((a, b) => (a.listPriority || 99) - (b.listPriority || 99));

            // Render Default Fields
            groups.default.forEach(field => {
                if (field.key === schema.pk || field.type === 'system') return;

                const val = data[field.key] || field.defaultValue || '';
                let inputHtml = '';

                if (field.readonly) {
                    inputHtml = `<input type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-400 cursor-not-allowed" value="${val}" disabled>`;
                } else if (field.type === 'select') {
                    inputHtml = `
                        <div class="relative">
                            <select id="field-${field.key}" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10 appearance-none bg-white">
                                ${field.options.map(opt => `<option value="${opt}" ${val === opt ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join('')}
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>`;
                } else if (field.type === 'boolean') {
                    inputHtml = `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                            <span class="text-xs font-bold text-navy uppercase">${field.label}</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="field-${field.key}" class="sr-only peer" ${val ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-custom"></div>
                            </label>
                        </div>`;
                } else if (field.type === 'color') {
                    inputHtml = `<input id="field-${field.key}" type="color" class="w-full h-12 p-1 border border-slate-200 rounded-xl cursor-pointer" value="${val}">`;
                } else if (field.type === 'date') {
                    // Using special feriado button style if it's feriados, or standard date
                    if (table === 'feriados') {
                        inputHtml = `<button id="feriado-btn" onclick="window.openFeriadoDatePicker()" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors"><span id="feriado-date-display">${val ? formatDateFull(val) : 'Selecionar Data...'}</span><i data-lucide="calendar" class="w-4 h-4 opacity-40"></i><input type="hidden" id="feriado-date-val" value="${val || ''}"></button>`;
                        // Note: saveRow must handle reading this specific ID or we map 'field-data' to it. 
                        // Actually, generic saveRow looks for 'field-key'. 
                        // So I should map ID 'field-data' to the HIDDEN input.
                        inputHtml = `<button onclick="window.openFeriadoDatePicker()" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors"><span id="feriado-date-display">${val ? formatDateFull(val) : 'Selecionar Data...'}</span><i data-lucide="calendar" class="w-4 h-4 opacity-40"></i></button><input type="hidden" id="field-${field.key}" value="${val || ''}">`;
                        // Wait, openFeriadoDatePicker updates 'feriado-date-val' ID HARDCODED in 'selectCalendarDate' (Line 2161).
                        // I should update 'selectCalendarDate' or shim it. 
                        // Simplest: ID 'feriado-date-val' AND 'field-data' (generic). Or make saveRow read 'feriado-date-val' for feriados.
                        // For Generic purity, I'll use id="field-${field.key}" (field-data) and update the helper to write to it?
                        // No, helper is existing code. I'll stick to standard date input for GENERIC tables, but Feriados used a picker.
                        // I will use standard date input for robustness unless 'feriados' specifically.
                        // Actually, standard date input is much easier.
                        // I will use standard date input.
                        inputHtml = `<input id="field-${field.key}" type="date" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${val}">`;
                    } else {
                        inputHtml = `<input id="field-${field.key}" type="date" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${val}">`;
                    }
                } else if (field.type === 'picker') {
                    inputHtml = `
                        <button onclick="window.cacheRowFormState(); window.openInputPicker('${field.refTable}', '${field.label}', 'field-${field.key}', '${field.filterKey || ''}', '${field.filterVal || ''}')" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors hover:bg-white hover:border-orange-custom/50 group">
                            <span id="display-field-${field.key}" class="truncate">${val || 'Selecionar...'}</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 opacity-40 group-hover:text-orange-custom"></i>
                        </button>
                        <input type="hidden" id="field-${field.key}" value="${val}">
                    `;
                } else {
                    // Default Text
                    inputHtml = `<input id="field-${field.key}" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10 transition-colors" value="${val}" ${field.required ? 'required' : ''} placeholder="${field.label}">`;
                }

                if (field.type !== 'boolean') {
                    fieldsHtml += `
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">${field.label}</label>
                            ${inputHtml}
                        </div>`;
                } else {
                    fieldsHtml += `<div class="mb-4">${inputHtml}</div>`;
                }
            });

            // Handle Specific Groups (Locations)
            const groupDefinitions = [
                { id: 'anciaes', label: 'Anciães' },
                { id: 'diaconos', label: 'Diáconos' },
                { id: 'cooperadores', label: 'Cooperadores' },
                { id: 'ministry', label: 'Ministério Local' } // Keep generic fallback just in case
            ];

            groupDefinitions.forEach(grp => {
                if (groups[grp.id] && groups[grp.id].length > 0) {
                    fieldsHtml += `<div class="border-t border-slate-100 my-4 pt-2"><span class="text-[10px] font-black text-orange-custom uppercase tracking-widest block mb-4">${grp.label}</span>`;
                    groups[grp.id].forEach(field => {
                        const val = data[field.key] || field.defaultValue || '';
                        fieldsHtml += `
                            <div class="mb-4">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">${field.label}</label>
                                ${field.type === 'picker' ? `
                                <button onclick="window.cacheRowFormState(); window.openInputPicker('${field.refTable}', '${field.label}', 'field-${field.key}', '${field.filterKey || ''}', '${field.filterVal || ''}')" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors hover:bg-white hover:border-orange-custom/50 group">
                                    <span id="display-field-${field.key}" class="truncate">${val || 'Selecionar...'}</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 opacity-40 group-hover:text-orange-custom"></i>
                                </button>
                                <input type="hidden" id="field-${field.key}" value="${val}">
                                ` : `<input id="field-${field.key}" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${val}" placeholder="${field.label}">`}
                            </div>`;
                    });
                    fieldsHtml += `</div>`;
                }
            });

            const content = `
                <div id="form-scroll-container" class="flex flex-col max-h-[75vh] overflow-y-auto px-1 scrollbar-none pb-2">
                    ${fieldsHtml}
                    <div class="mt-4 pt-4 border-t border-slate-50 flex flex-col gap-3">
                        <button onclick="window.saveRow('${table}', '${id || ''}')" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">
                            SALVAR
                        </button>
                         ${!isNew ? `<button onclick="window.requestDeleteRow('${id}', '${table}', '${(data.name || data.localidade || data.nome || data.nome_feriado || '').replace(/'/g, "\\'")}')" class="w-full py-4 bg-red-50 text-red-500 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all border border-red-100">Excluir Registro</button>` : ''}
                    </div>
                </div>
            `;
            showModal(renderModalShell({ title: isNew ? (schema.label === 'Feriados' ? 'Novo Feriado' : `Novo ${schema.label.replace(/s$/, '')}`) : `Editar ${schema.label.replace(/s$/, '')}`, contentHtml: content, centerContent: false }));

            // Restore scroll position
            if (window.__focus_target_id) {
                setTimeout(() => {
                    const el = document.getElementById(window.__focus_target_id);
                    if (el) {
                        el.scrollIntoView({ block: 'center', behavior: 'auto' });
                        // Also update scrollTop cache to match new position
                        const c = document.getElementById('form-scroll-container');
                        if (c && window.__row_modal_cache) window.__row_modal_cache.scrollTop = c.scrollTop;
                    }
                    window.__focus_target_id = null;
                }, 50);
            } else if (window.__row_modal_cache && window.__row_modal_cache.scrollTop) {
                setTimeout(() => {
                    const el = document.getElementById('form-scroll-container');
                    if (el) el.scrollTop = window.__row_modal_cache.scrollTop;
                }, 10);
            }
        }

        async function saveRow(table, id) {
            const schema = TableSchema[table];
            if (!schema) return;

            const btn = document.querySelector(`button[onclick*="saveRow('${table}'"]`);
            if (btn) { btn.innerText = "Salvando..."; btn.disabled = true; }

            let payload = {};
            let hasError = false;

            Object.entries(schema.fields).forEach(([key, field]) => {
                if (key === schema.pk || field.type === 'system' || field.readonly) return;

                const el = document.getElementById(`field-${key}`);
                if (!el) return;

                let val = null;
                if (field.type === 'boolean') {
                    val = el.checked;
                } else {
                    val = el.value.trim();
                }

                if (field.required && !val && val !== false) {
                    el.classList.add('input-error');
                    if (el.parentElement) el.parentElement.classList.add('animate-shake');
                    hasError = true;
                } else {
                    el.classList.remove('input-error');
                    if (el.parentElement) el.parentElement.classList.remove('animate-shake');
                }

                if (field.uppercase && val) val = val.toUpperCase();

                payload[key] = val;
            });

            if (hasError) {
                if (btn) { btn.innerText = "Salvar"; btn.disabled = false; }
                return;
            }

            // Client-side duplication check (Generic)
            if (table !== 'perfis') {
                const nameKey = Object.keys(schema.fields).find(k => k === 'name' || k === 'localidade' || k === 'nome' || k === 'nome_feriado');
                if (nameKey && payload[nameKey]) {
                    const duplicate = state[table].find(i => String(i.id) !== String(id) && (i[nameKey] || '').toLowerCase() === payload[nameKey].toLowerCase());
                    if (duplicate) {
                        showDuplicateModal(payload[nameKey], table, duplicate.id, id, payload);
                        if (btn) { btn.innerText = "Salvar"; btn.disabled = false; }
                        return;
                    }
                }
            }

            const action = (!id || id === 'undefined' || id === '') ? 'INSERT' : 'UPDATE';
            await smartSave(table, action, payload, id, () => {
                if (!state.pendingConflict) {
                    closeModal();
                    if (window.updateManagerListUI) window.updateManagerListUI(table);
                }
            });
        }

        function showDuplicateModal(name, coll, dupId, edId, curVals) {
            window.__duplicate_temp_data = curVals;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Registro Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Já existe um registro com este nome ou sigla:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dupId}', '${coll}')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.openRowModal('${coll}', '${edId}', window.__duplicate_temp_data)" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showEventDuplicateModal(dup) {
            const type = state.types.find((t) => t.id === dup.type_id);
            const loc = state.locations.find((l) => l.id === dup.location_id);
            const name = `${type?.name || 'Evento'} em ${loc?.localidade || 'Local'} (${formatDate(dup.date)} às ${dup.time})`;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Evento Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Já existe um evento idêntico cadastrado:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dup.id}', 'agenda')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.closeModal()" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showDeleteConfirmModal(id, coll, name) {
            if (!state.isAdmin) return;
            const isUser = coll === 'perfis';
            const content = `
                <p class="mb-8 px-2">Deseja realmente excluir ${isUser ? 'o usuário' : 'o registro'} <br><strong class="text-slate-700">"${name || ''}"</strong>?</p>
                <div class="w-full flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold active:scale-95 transition-all text-sm uppercase">Não</button>
                    <button onclick="window.confirmarExclusaoColecao('${id}', '${coll}')" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all text-sm uppercase">Sim, Excluir</button>
                </div>
            `;
            showModal(renderModalShell({ title: 'Confirmação', contentHtml: content, icon: isUser ? 'user-minus' : 'alert-triangle', type: 'danger', centerContent: true }));
        }

        async function confirmarExclusaoColecao(id, coll) {
            if (!state.isAdmin) return;
            await window.smartSave(coll, 'DELETE', null, id, () => {
                closeModal();
                if (window.updateManagerListUI) window.updateManagerListUI(coll);
            });
        }

        async function confirmarEDeletar(id) {
            console.log("[confirmarEDeletar] Iniciando exclusão do ID:", id);
            if (!id || !state.isAdmin) return;
            await window.smartSave('agenda', 'DELETE', null, id, () => {
                console.log("[confirmarEDeletar] UI atualizada para exclusão.");
                closeModal();
                navigateTo('home');
            });
        }

        function navigateTo(screen, push = true) {
            if (push && state.currentScreen !== screen) window.history.pushState({ screen }, "");
            state.currentScreen = screen;
            state.isMenuOpen = false;
            state.managerSearchTerm = '';
            state.formErrors = [];
        }

        function openMenu() { state.isMenuOpen = true; }
        function closeMenu() { state.isMenuOpen = false; }
        function closeModal() { const m = document.getElementById('modal-container'); if (m) { m.classList.add('hidden'); m.innerHTML = ''; } }
        function showModal(html) { const m = document.getElementById('modal-container'); if (m) { m.innerHTML = html; m.classList.remove('hidden'); } renderIcons(); }

        function showLoginModal(startWithSignUp = false) {
            const t = document.getElementById('login-modal-template');
            const m = document.getElementById('modal-container');
            if (m && t) {
                m.innerHTML = ''; m.appendChild(t.content.cloneNode(true)); m.classList.remove('hidden');
                let isSignUp = startWithSignUp;
                const toggleBtn = document.getElementById('toggle-auth-mode');
                const nameField = document.getElementById('name-field');
                const submitBtn = document.getElementById('login-submit-btn');
                const titleEl = document.getElementById('modal-login-title');

                const updateUI = () => {
                    if (isSignUp) { titleEl.innerText = "Novo Cadastro"; nameField.classList.remove('hidden'); submitBtn.innerText = "Cadastrar"; toggleBtn.innerText = "Já tem conta? Entre"; }
                    else { titleEl.innerText = "Faça Login ou Cadastro"; nameField.classList.add('hidden'); submitBtn.innerText = "Entrar"; toggleBtn.innerText = "Não tem conta? Cadastre-se"; }
                };

                updateUI();

                toggleBtn?.addEventListener('click', () => {
                    isSignUp = !isSignUp;
                    updateUI();
                });
                document.getElementById('login-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); const errD = document.getElementById('login-error');
                    if (btn) { btn.disabled = true; btn.innerText = isSignUp ? 'Cadastrando...' : 'Entrando...'; }
                    const name = document.getElementById('login-name').value.trim();
                    const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
                    try {
                        if (isSignUp) {
                            if (!name) throw new Error("O nome é obrigatório para cadastro.");
                            const { data, error } = await supabaseClient.auth.signUp({
                                email,
                                password,
                                options: {
                                    data: {
                                        full_name: name
                                    }
                                }
                            });
                            if (error) throw error;
                            alert("Cadastro realizado! Aguarde a aprovação de um administrador."); closeModal();
                        } else {
                            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            closeModal();
                        }
                    } catch (err) {
                        if (errD) {
                            errD.innerText = translateAuthError(err.message);
                            errD.classList.remove('hidden');
                        }
                        if (btn) {
                            btn.disabled = false;
                            btn.innerText = isSignUp ? 'Cadastrar' : 'Entrar';
                        }
                    }
                });
            }
            renderIcons();
        }

        function renderFFRow(l, v, t, c) {
            const isS = c === t;
            return `<div class="flex flex-col gap-1.5 p-3 rounded-2xl border-2 transition-all h-full ${isS ? 'border-orange-custom bg-orange-50/30' : 'border-slate-100 bg-slate-50/50'}" onclick="window.state.ffTemp.selected = '${t}'; window.renderFastFilterUI();"><div class="flex justify-between items-center px-1"><span class="text-[9px] font-black uppercase tracking-tight ${isS ? 'text-orange-custom' : 'text-slate-400'}">${l}</span><div class="flex gap-2"><button onclick="event.stopPropagation(); window.shiftFF('${t}', -1)" class="p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white"><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i></button><button onclick="event.stopPropagation(); window.shiftFF('${t}', 1)" class="p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white"><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button></div></div><div class="text-[11px] font-bold text-navy px-1 leading-tight">${v}</div></div>`;
        }

        function renderFastFilterUI() {
            const bD = state.ffTemp.baseDates; const sel = state.ffTemp.selected;
            const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            const todayT = `${bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).charAt(0).toUpperCase() + bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).slice(1)}, dia ${fBR(bD.today)}`;
            const dW1 = new Date(bD.week); dW1.setDate(bD.week.getDate() - bD.week.getDay()); const dW2 = new Date(dW1); dW2.setDate(dW1.getDate() + 6);
            showModal(`<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-gap-2 text-navy"><i data-lucide="filter" class="w-5 h-5 text-orange-custom"></i><h3 class="text-lg font-black tracking-tight uppercase">Filtro</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-4">${renderFFRow('Por dia', todayT, 'today', sel)}${renderFFRow('Semana', fBR(dW1) + ' a ' + fBR(dW2), 'week', sel)}<div class="flex gap-3"><div class="flex-1">${renderFFRow('Mês', `${["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][bD.month.getMonth()]} / ${bD.month.getFullYear()}`, 'month', sel)}</div><div class="flex-1">${renderFFRow('Ano', bD.year.getFullYear().toString(), 'year', sel)}</div></div></div><div class="p-4 bg-white border-t border-slate-50"><button onclick="window.applyNewFastFilter()" class="w-full bg-navy text-white py-4 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
            renderIcons();
        }

        function renderPickerItems(items, coll, isA, tar, prop) {
            if (items.length === 0) return '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum registro.</div>';
            const sorted = [...items].sort((a, b) => ((coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '').localeCompare((coll === 'locations' ? b.localidade : (coll === 'perfis' ? b.nome : b.name)) || ''));
            return sorted.map((i) => {
                const name = (coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '';
                const isS = isA ? state.advancedFilter?.[tar]?.id === i.id : state[prop] === i.id;
                return `<button onclick="${isA ? `window.state.advancedFilter.${tar}.id = '${i.id}'; window.state.advancedFilter.validationErrors = window.state.advancedFilter.validationErrors.filter(e => e !== '${tar}'); window.renderAdvancedFilterModal(); window.scrollToAdvSection('${tar}');` : `window.state.${prop} = '${i.id}'; window.state.formErrors = window.state.formErrors.filter(e => !'${prop}'.includes(e)); window.closeModal();`}" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><div class="flex flex-col min-w-0 flex-1"><span class="group-hover:text-navy transition-colors font-bold text-sm leading-tight">${name}</span></div>${isS ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0 ml-2"></i>' : ''}</button>`;
            }).join('');
        }

        async function refreshAllData() {
            if (!state.isAuthorized || !navigator.onLine) return;
            const tables = {
                'types': 'types',
                'locations': 'locations',
                'attendants': 'attendants',
                'agenda': 'events',
                'feriados': 'feriados',
                'perfis': 'perfis'
            };

            // Passo 1: Carregamento paralelo das tabelas
            try {
                const promises = Object.entries(tables).map(async ([table, key]) => {
                    const { data, error } = await supabaseClient.from(table).select('*');
                    if (!error && data) {
                        state[key] = data;
                        localStorage.setItem(`cache_${table}`, JSON.stringify(data));
                    }
                });
                await Promise.all(promises);
                scheduleRender();
                if (window.updateHomeList) window.updateHomeList();
            } catch (e) { }
        }

        function showConnStatus(status) {
            const el = document.getElementById('conn-status');
            if (!el) return;
            el.className = '';
            if (status === 'offline') { el.innerHTML = '<i data-lucide="wifi-off" class="w-3.5 h-3.5"></i> Sem internet - Modo Offline'; el.classList.add('offline'); }
            else if (status === 'online-recovered') { el.innerHTML = '<i data-lucide="wifi" class="w-3.5 h-3.5"></i> Online Sincronizando...'; el.classList.add('online-recovered'); setTimeout(() => { el.classList.remove('online-recovered'); }, 3000); }
            renderIcons();
        }



        Object.assign(window, {
            renderApp, scheduleRender, navigateTo, openMenu, closeMenu, closeModal, showModal,
            openInputPicker, selectInputPicker, returnToRowModal,
            cacheRowFormState: () => {
                // Save current inputs to cache item so we don't lose them
                const c = window.__row_modal_cache;
                if (!c || !c.item) return;

                // Cache Scroll Position
                const scrollEl = document.getElementById('form-scroll-container');
                if (scrollEl) c.scrollTop = scrollEl.scrollTop;

                // Iterate fields and update c.item
                const schema = TableSchema[c.table];
                Object.entries(schema.fields).forEach(([k, f]) => {
                    const El = document.getElementById('field-' + k);
                    if (El) {
                        if (f.type === 'boolean') c.item[k] = El.checked;
                        else c.item[k] = El.value;
                    }
                });
            },
            handleLogout: () => {
                state.isLoading = true;
                cleanupListeners();
                localStorage.clear();
                sessionStorage.clear();
                supabaseClient.auth.signOut().then(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                });
            },
            showLoginModal, saveRow, openRowModal, requestDeleteRow: (id, coll, name) => showDeleteConfirmModal(id, coll, name), confirmarExclusaoColecao, renderCalendar, renderClockUI, renderAdvancedFilterModal, openDistinctPicker, openAdvancedFilterModal: () => renderAdvancedFilterModal(), resetAllFilters: () => { state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; state.highlightedItemId = null; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; window.updateHomeList(); },
            startOpenAgenda: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; const t = new Date().toISOString().split('T')[0]; if (!state.selectedDate) state.selectedDate = t; state.viewDate = new Date(state.selectedDate + 'T00:00:00'); renderCalendar('filter'); },
            changeMonth: (o, m) => { const d = new Date(state.viewDate); d.setMonth(d.getMonth() + o); state.viewDate = d; if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); },
            changePickerYear: (o, m) => { const d = new Date(state.viewDate); d.setFullYear(d.getFullYear() + o); state.viewDate = d; if (m.includes('month') || m === 'adv_period') window.openMonthPicker(m); else window.openYearPicker(m); },
            selectMonth: (i, m) => { const d = new Date(state.viewDate); d.setMonth(i); state.viewDate = d; if (m === 'adv_period') { const first = new Date(d.getFullYear(), i, 1); const last = new Date(d.getFullYear(), i + 1, 0); state.advancedFilter.period.start = first.toISOString().split('T')[0]; state.advancedFilter.period.end = last.toISOString().split('T')[0]; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(i + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            selectYear: (y, m) => { const d = new Date(state.viewDate); d.setFullYear(y); state.viewDate = d; if (m === 'adv_period') { state.advancedFilter.period.start = `${y}-01-01`; state.advancedFilter.period.end = `${y}-12-31`; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${y}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            openMonthPicker: (m) => { const names = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"]; const year = state.viewDate.getFullYear(); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-6 h-6"></i></button><div class="flex items-center justify-center gap-3 w-full mb-6"><button onclick="window.changePickerYear(-1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><span class="text-sm font-black text-navy uppercase tracking-widest">${year}</span><button onclick="window.changePickerYear(1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div><div class="grid grid-cols-3 gap-3 w-full">${names.map((n, i) => `<button onclick="window.selectMonth(${i}, '${m}')" class="py-4 text-[11px] font-black rounded-xl border transition-all ${state.viewDate.getMonth() === i ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${n.slice(0, 3)}</button>`).join('')}</div></div>`); },
            openYearPicker: (m) => { const currentYear = new Date().getFullYear(); const selectedYear = (m === 'adv_period' && state.advancedFilter.period.start) ? new Date(state.advancedFilter.period.start + 'T00:00:00').getFullYear() : currentYear; state.viewDate = new Date(selectedYear, 0, 1); const years = []; for (let i = currentYear - 30; i < currentYear + 30; i++) years.push(i); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button><div class="flex items-center justify-center w-full mb-6"><span class="text-sm font-black text-navy uppercase tracking-widest">ANO</span></div><div id="year-scroll-container" class="grid grid-cols-3 gap-3 w-full max-h-[224px] overflow-y-auto scrollbar-none py-2">${years.map(y => `<button id="year-btn-${y}" onclick="window.selectYear(${y}, '${m}')" class="py-4 text-xs font-black rounded-xl border transition-all ${y === selectedYear ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${y}</button>`).join('')}</div></div>`); setTimeout(() => { const btn = document.getElementById(`year-btn-${selectedYear}`); if (btn) btn.scrollIntoView({ block: 'center' }); }, 10); },
            selectCalendarDate: (d, m = 'filter') => { if (m === 'filter') { state.selectedDate = d; renderCalendar('filter'); } else if (m === 'picker') { state.formTempDate = d; state.formErrors = state.formErrors.filter(e => e !== 'date'); closeModal(); } else if (m === 'adv_start' || m === 'adv_end') { state.advancedFilter.period[m === 'adv_start' ? 'start' : 'end'] = d; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); window.scrollToAdvSection('period'); } else if (m === 'feriado_picker') { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, { ...c.item, data: d }); } },
            applyCalendarAndClose: () => { state.fastFilter = { active: false }; state.advancedFilter.active = false; window.updateHomeList(); closeModal(); },
            openFormDate: () => { state.viewDate = new Date((state.formTempDate || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('picker'); },
            openFeriadoDatePicker: () => { state.viewDate = new Date((document.getElementById('feriado-date-val')?.value || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('feriado_picker'); },
            returnToFeriadoModal: () => { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, c.item); },
            renderFastFilterUI,
            openFastFilterModal: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; state.ffTemp.baseDates = { today: new Date(), week: new Date(), month: new Date(), year: new Date() }; renderFastFilterUI(); },
            shiftFF: (t, o) => { const d = new Date(state.ffTemp.baseDates[t]); if (t === 'today') d.setDate(d.getDate() + o); else if (t === 'week') d.setDate(d.getDate() + (o * 7)); else if (t === 'month') d.setMonth(d.getMonth() + o); else if (t === 'year') d.setFullYear(d.getFullYear() + o); state.ffTemp.baseDates[t] = d; state.ffTemp.selected = t; renderFastFilterUI(); },
            applyNewFastFilter: () => { const b = new Date(state.ffTemp.baseDates[state.ffTemp.selected]); let st = '', en = '', la = ''; const f = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; if (state.ffTemp.selected === 'today') { st = en = f(b); let w = b.toLocaleDateString('pt-BR', { weekday: 'long' }); la = `${w.charAt(0).toUpperCase() + w.slice(1)}, dia ${fBR(b)}`; } else if (state.ffTemp.selected === 'week') { const d1 = new Date(b); d1.setDate(b.getDate() - b.getDay()); const d2 = new Date(d1); d2.setDate(d1.getDate() + 6); st = f(d1); en = f(d2); la = `Semana ${fBR(d1)} a ${fBR(d2)}`; } else if (state.ffTemp.selected === 'month') { const d1 = new Date(b.getFullYear(), b.getMonth(), 1); const d2 = new Date(b.getFullYear(), b.getMonth() + 1, 0); st = f(d1); en = f(d2); la = `${["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][b.getMonth()]} / ${b.getFullYear()}`; } else if (state.ffTemp.selected === 'year') { st = `${b.getFullYear()}-01-01`; en = `${b.getFullYear()}-12-31`; la = `Ano de ${b.getFullYear()}`; } state.selectedDate = null; state.advancedFilter.active = false; state.fastFilter = { active: true, dateStart: st, dateEnd: en, label: la }; closeModal(); window.updateHomeList(); },
            toggleAdvFilterSection: (sec) => { const af = state.advancedFilter; af[sec].enabled = !af[sec].enabled; af.validationErrors = af.validationErrors.filter(e => e !== sec); if (sec === 'adm' && !af.adm.enabled) { af.adm.value = ''; af.setor.enabled = false; af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'setor' && !af.setor.enabled) { af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'cidade' && !af.cidade.enabled) { af.cidade.value = ''; af.location.id = ''; } window.renderAdvancedFilterModal(); if (af[sec].enabled) window.scrollToAdvSection(sec); },
            handleAdvFilterSelect: (f, v) => { const af = state.advancedFilter; af[f].value = v; af.validationErrors = af.validationErrors.filter(e => e !== f); if (f === 'adm') { af.setor.value = ''; af.cidade.value = ''; af.location.id = ''; } else if (f === 'setor') { af.cidade.value = ''; af.location.id = ''; } else if (f === 'cidade') af.location.id = ''; window.renderAdvancedFilterModal(); window.scrollToAdvSection(f); },
            setAdvFilterStatus: (s) => { state.advancedFilter.eventos.status = s; },
            clearAdvancedFilters: () => { state.advancedFilter = { active: false, eventos: { enabled: false, status: 'ativos' }, type: { enabled: false, id: '' }, location: { enabled: false, id: '' }, attendant: { enabled: false, id: '' }, adm: { enabled: false, value: '' }, setor: { enabled: false, value: '' }, cidade: { enabled: false, value: '' }, period: { enabled: false, start: '', end: '' }, validationErrors: [] }; window.updateHomeList(); window.renderAdvancedFilterModal(); },
            applyAdvancedFilters: () => { const af = state.advancedFilter; const errs = []; if (af.type.enabled && !af.type.id) errs.push('type'); if (af.location.enabled && !af.location.id) errs.push('location'); if (af.attendant.enabled && !af.attendant.id) errs.push('attendant'); if (af.adm.enabled && !af.adm.value) errs.push('adm'); if (af.setor.enabled && !af.setor.value) errs.push('setor'); if (af.cidade.enabled && !af.cidade.value) errs.push('cidade'); if (af.period.enabled && (!af.period.start || !af.period.end)) errs.push('period'); if (errs.length > 0) { state.advancedFilter.validationErrors = errs; window.renderAdvancedFilterModal(); return; } state.selectedDate = null; state.fastFilter.active = false; state.advancedFilter.active = true; state.advancedFilter.validationErrors = []; closeModal(); window.updateHomeList(); },
            openDateRangePicker: (t) => { state.viewDate = new Date((state.advancedFilter.period[t] || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar(t === 'start' ? 'adv_start' : 'adv_end'); },
            openPDFPreview: () => window.renderReportCriteriaModal(),
            renderReportCriteriaModal: () => {
                const rf = state.reportFilter;
                const isAgenda = rf.table === 'agenda';

                // Helper to get labels
                const getLabel = (k, id) => {
                    if (id === 'all') return 'Todos';
                    if (k === 'type') return state.types.find(t => t.id === id)?.name || 'Desconhecido';
                    if (k === 'location') return state.locations.find(l => l.id === id)?.localidade || 'Desconhecido';
                    if (k === 'attendant') return state.attendants.find(a => a.id === id)?.name || 'Desconhecido';
                    if (k === 'adm' || k === 'setor' || k === 'cidade') return id;
                    return '';
                };

                // Helper to render row
                const renderRow = (key, label, collection) => {
                    const isEnabled = rf[key].enabled;
                    const currentId = rf[key].id; // 'all' or ID/Value
                    const currentLabel = getLabel(key, currentId);

                    return `
                        <div class="flex items-center gap-3 p-4 bg-white hover:bg-slate-50 transition-all border-b border-slate-100 last:border-b-0">
                            <label class="relative inline-flex items-center cursor-pointer shrink-0">
                                <input type="checkbox" class="sr-only peer" ${isEnabled ? 'checked' : ''} onchange="window.toggleReportCriteria('${key}')">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-navy"></div>
                            </label>
                            
                            <div class="flex-1 min-w-0 ${isEnabled ? 'opacity-100' : 'opacity-40 pointer-events-none'}">
                                <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5">${label}</div>
                                <button onclick="window.openReportSelector('${key}', '${collection}')" class="w-full text-left font-bold text-navy text-sm flex justify-between items-center bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 shadow-sm active:bg-slate-100 transition-colors">
                                    <span class="truncate">${currentLabel}</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>
                        </div>
                   `;
                };

                const fieldsHtml = isAgenda ? `
                    ${renderRow('type', 'Filtrar por Evento', 'types')}
                    ${renderRow('location', 'Filtrar por Localidade', 'locations')}
                    ${renderRow('attendant', 'Filtrar por Atendente', 'attendants')}
                ` : `
                    ${renderRow('adm', 'Filtrar por ADM', 'locations')}
                    ${renderRow('setor', 'Filtrar por Setor', 'locations')}
                    ${renderRow('cidade', 'Filtrar por Cidade', 'locations')}
                `;

                showModal(`
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                        <div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white shadow-sm z-10 shrink-0">
                            <div class="flex items-center gap-2 text-navy">
                                <i data-lucide="file-text" class="w-5 h-5"></i>
                                <h3 class="text-lg font-black tracking-tight uppercase">Critérios para Relatório</h3>
                            </div>
                            <button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        
                        <div class="p-4 bg-slate-50 border-b border-slate-100 shrink-0">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">Tabela de Dados</label>
                            <button onclick="window.toggleReportTable()" class="w-full bg-white border border-slate-200 rounded-xl p-3 flex justify-between items-center shadow-sm active:scale-[0.99] transition-all">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg ${isAgenda ? 'bg-blue-50 text-blue-600' : 'bg-emerald-50 text-emerald-600'} flex items-center justify-center">
                                        <i data-lucide="${isAgenda ? 'calendar' : 'map-pin'}" class="w-4 h-4"></i>
                                    </div>
                                    <div class="text-left">
                                        <div class="text-xs font-bold text-navy uppercase tracking-wide">${isAgenda ? 'Eventos (Agenda)' : 'Localidades'}</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                        
                        <div class="flex flex-col overflow-y-auto scrollbar-none bg-white divide-y divide-slate-50">
                            ${fieldsHtml}
                        </div>
                        
                        <div class="p-4 border-t border-slate-50 bg-white grid grid-cols-2 gap-3 shrink-0">
                            <button onclick="window.closeModal()" class="py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs uppercase tracking-widest active:scale-95 transition-all">Cancelar</button>
                            <button class="py-3 bg-navy text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Preview</button>
                        </div>
                    </div>
                `);
                renderIcons();
            },
            toggleReportTable: () => {
                const rf = state.reportFilter;
                rf.table = rf.table === 'agenda' ? 'locations' : 'agenda';
                // Reset dynamic filters when switching tables
                if (rf.table === 'agenda') {
                    rf.adm.enabled = false; rf.setor.enabled = false; rf.cidade.enabled = false;
                } else {
                    rf.type.enabled = false; rf.location.enabled = false; rf.attendant.enabled = false;
                }
                window.renderReportCriteriaModal();
            },
            toggleReportCriteria: (key) => {
                const rf = state.reportFilter;
                rf[key].enabled = !rf[key].enabled;
                if (!rf[key].enabled) rf[key].id = 'all';
                window.renderReportCriteriaModal();
            },
            openReportSelector: (key, collection) => {
                let items = [];
                if (collection === 'locations' && (key === 'adm' || key === 'setor' || key === 'cidade')) {
                    // Extract distinct values for localidade fields
                    const rawValues = new Set(state.locations.map(l => l[key]).filter(v => v));
                    items = [{ id: 'all', name: 'Todos' }, ...[...rawValues].sort().map(v => ({ id: v, name: v }))];
                } else {
                    items = [{ id: 'all', name: 'Todos', localidade: 'Todas', adm: 'Todos' }, ...state[collection]];
                }

                const renderItems = (list) => list.map(i => {
                    const name = i.name || i.localidade || 'Sem Nome';
                    const isSelected = state.reportFilter[key].id === i.id;
                    return `
                        <button onclick="window.selectReportCriteria('${key}', '${i.id.replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                            <span class="group-hover:text-navy transition-colors font-bold text-sm leading-tight">${name}</span>
                            ${isSelected ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0 ml-2"></i>' : ''}
                        </button>
                    `;
                }).join('');

                showModal(`
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
                        <div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0">
                            <div class="flex items-center gap-3 text-navy">
                                <i data-lucide="list" class="w-5 h-5"></i>
                                <h3 class="font-bold text-lg">Selecionar Opção</h3>
                            </div>
                            <button onclick="window.renderReportCriteriaModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="px-5 py-4 shrink-0">
                            <div class="relative group">
                                <input id="repPickerSearch" type="text" placeholder="Filtrar..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium">
                                <i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i>
                            </div>
                        </div>
                        <div id="repPickerList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none">
                            ${renderItems(items)}
                        </div>
                    </div>
                `);

                document.getElementById('repPickerSearch')?.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = items.filter(i => (i.name || i.localidade || '').toLowerCase().includes(term));
                    document.getElementById('repPickerList').innerHTML = renderItems(filtered);
                    renderIcons();
                });
                renderIcons();
            },
            selectReportCriteria: (key, id) => {
                state.reportFilter[key].id = id;
                window.renderReportCriteriaModal();
            },
            startCreateEvent: () => { state.editingEventId = null; state.formTempDate = new Date().toISOString().split('T')[0]; state.formTempTime = '08:00'; state.formTempLoc = ''; state.formTempType = ''; state.formTempAtt = ''; state.formTempIrmaos = ''; state.formTempIrmas = ''; state.formErrors = []; state.originalEventSnapshot = null; state.highlightedItemId = null; navigateTo('event-form'); },
            openEditEvent: (id) => { const ev = state.events.find((e) => String(e.id) === String(id)); if (ev) { state.editingEventId = id; state.formTempDate = ev.date; state.formTempTime = ev.time; state.formTempLoc = ev.location_id; state.formTempType = ev.type_id; state.formTempAtt = ev.attendant_id || ''; state.formTempIrmaos = ev.irmaos || ''; state.formTempIrmas = ev.irmas || ''; state.formErrors = []; state.originalEventSnapshot = JSON.parse(JSON.stringify(ev)); state.highlightedItemId = null; navigateTo('event-form'); } },
            openTimePickerModal: () => { const [h, m] = (state.formTempTime || '08:00').split(':'); state.clockTempHour = h; state.clockTempMinute = m; state.clockMode = 'hour'; showModal(''); renderClockUI(); },
            selectClockValue: (v) => { if (state.clockMode === 'hour') { state.clockTempHour = v.padStart(2, '0'); state.clockMode = 'minute'; } else state.clockTempMinute = v.padStart(2, '0'); renderClockUI(); },
            confirmClockTime: () => { state.formTempTime = `${state.clockTempHour}:${state.clockTempMinute}`; closeModal(); },
            openSelectPicker: (coll, tit, pr) => { let items = [...state[coll]]; if (coll === 'locations' && pr === 'adv_location') { const af = state.advancedFilter; if (af.adm.enabled && af.adm.value) items = items.filter(l => l.adm === af.adm.value); if (af.setor.enabled && af.setor.value) items = items.filter(l => l.setor === af.setor.value); if (af.cidade.enabled && af.cidade.value) items = items.filter(l => l.cidade === af.cidade.value); } const isA = pr.startsWith('adv_'); const target = isA ? pr.replace('adv_', '') : pr; showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${tit}</h3></div><button onclick="${isA ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="px-5 py-4"><div class="relative group"><input id="pickerSearch" type="text" placeholder="Filtrar..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium"><i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i></div></div><div id="pickerItemsList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none"></div></div>`); const listEl = document.getElementById('pickerItemsList'); if (listEl) listEl.innerHTML = renderPickerItems(items, coll, isA, target, pr); document.getElementById('pickerSearch')?.addEventListener('input', (e) => { const term = (e.target.value || '').toLowerCase(); const filtered = items.filter((i) => ((coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '').toLowerCase().includes(term)); document.getElementById('pickerItemsList').innerHTML = renderPickerItems(filtered, coll, isA, target, pr); renderIcons(); }); renderIcons(); },
            saveEvent: async () => {
                console.log("[saveEvent] Botão Salvar clicado.");
                const btn = document.querySelector('button[onclick="window.saveEvent()"]');
                if (btn) { btn.disabled = true; btn.innerText = "Salvando..."; }
                try {
                    const errs = [];
                    if (!state.formTempDate) errs.push('date');
                    if (!state.formTempLoc) errs.push('loc');
                    if (!state.formTempType) errs.push('type');
                    if (errs.length > 0) { state.formErrors = errs; return; }
                    const eventData = { date: state.formTempDate, time: state.formTempTime, location_id: state.formTempLoc, type_id: state.formTempType, attendant_id: state.formTempAtt || null, irmaos: parseInt(state.formTempIrmaos || '0'), irmas: parseInt(state.formTempIrmas || '0') };
                    const duplicate = state.events.find(e => e.date === eventData.date && e.time === eventData.time && e.location_id === eventData.location_id && e.type_id === eventData.type_id && String(e.id) !== String(state.editingEventId));
                    if (duplicate) { showEventDuplicateModal(duplicate); return; }
                    const action = state.editingEventId ? 'UPDATE' : 'INSERT';
                    await window.smartSave('agenda', action, eventData, state.editingEventId, () => {
                        window.navigateTo('home');
                        state.editingEventId = null;
                    });
                } catch (e) {
                    alert("Erro inesperado: " + e.message);
                } finally {
                    if (btn) { btn.disabled = false; btn.innerText = `SALVAR EVENTO ${!navigator.onLine ? '(OFFLINE)' : ''}`; }
                    if (state.formErrors && state.formErrors.length > 0) scheduleRender();
                }
            },
            requestDeleteEvent: (id) => {
                const ev = state.events.find((e) => String(e.id) === String(id));
                const type = state.types.find((t) => t.id === ev?.type_id);
                const loc = state.locations.find((l) => l.id === ev?.location_id);
                const content = `
                <p class="mb-8 px-2">Deseja excluir este evento?<br><strong class="text-slate-700">${type?.name || ''} em ${loc?.localidade || ''}</strong></p>
                <div class="w-full flex gap-3">
                    <button onclick="window.closeModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-sm text-slate-600">Não</button>
                    <button onclick="window.confirmarEDeletar('${id}')" class="flex-1 bg-red-600 py-3 rounded-xl font-black uppercase text-sm text-white shadow-lg">Sim</button>
                </div>`;
                showModal(renderModalShell({ title: 'Excluir?', contentHtml: content, icon: 'alert-triangle', type: 'danger', centerContent: true }));
            },
            confirmarEDeletar,
            locateDuplicate: (id, coll) => { const targetScreen = coll === 'agenda' ? 'home' : (coll === 'perfis' ? 'users' : coll); closeModal(); navigateTo(targetScreen); state.managerSearchTerm = ''; state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; state.highlightedItemId = id; if (targetScreen === 'home') window.updateHomeList(); else if (window.updateManagerListUI) window.updateManagerListUI(coll); },
            showExitConfirmation: () => {
                const content = `
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">Você deseja realmente encerrar sua sessão e sair do aplicativo agora?</p>
                            <div class="w-full flex flex-col gap-3">
                                <button onclick="window.closeModal()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Continuar no App</button>
                                <button onclick="window.handleLogout()" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Sim, Sair</button>
                            </div>`;
                showModal(renderModalShell({ title: 'Sair do App?', contentHtml: content, icon: 'log-out', type: 'info', centerContent: true }));
            },
            showInstallPromptModal: () => {
                const content = `
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">Deseja instalar a Agenda?</p>
                            <div class="w-full flex flex-col gap-3">
                                <button onclick="window.confirmInstall()" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Sim, instalar</button>
                                <button onclick="window.rejectInstall()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Não</button>
                            </div>`;
                showModal(renderModalShell({ title: 'Agenda CCB', contentHtml: content, icon: 'calendar', type: 'warning', centerContent: true }));
            },
            showInstallingStatusModal: () => {
                const content = `<div class="loading-spinner mb-6"></div><p class="text-sm font-medium text-slate-500 mb-4 leading-relaxed">Instalando...</p>`;
                showModal(renderModalShell({ title: 'Agenda CCB', contentHtml: content, centerContent: true }));
            },
            confirmInstall: async () => {
                const promptEvent = window.deferredPrompt;
                if (promptEvent) {
                    await promptEvent.prompt();
                    const { outcome } = await promptEvent.userChoice;

                    if (outcome === 'accepted') {
                        window.showInstallingStatusModal();
                    } else {
                        closeModal();
                    }
                    window.deferredPrompt = null;
                } else {
                    closeModal();
                }
            },
            rejectInstall: () => {
                closeModal();
                window.close();
                setTimeout(() => {
                    document.body.innerHTML = "";
                    window.location.href = "about:blank";
                }, 100);
            },
            scrollToAdvSection: (sec) => {
                setTimeout(() => {
                    const el = document.getElementById(`adv-sec-${sec}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 50);
            },




        });

        function loadCachedData() {
            const tablesToCache = ['types', 'locations', 'attendants', 'agenda', 'feriados', 'perfis'];
            let hasInitialData = false;
            tablesToCache.forEach(table => {
                const cachedData = localStorage.getItem(`cache_${table}`);
                if (cachedData) {
                    const key = table === 'agenda' ? 'events' : table;
                    state[key] = JSON.parse(cachedData);
                    hasInitialData = true;
                }
            });
            return hasInitialData;
        }

        async function init() {
            let hasInitialData = loadCachedData();

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.user = session.user;
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();

                const cachedProfile = getCachedProfile();
                if (isMasterAdmin || cachedProfile.isAuthorized) {
                    state.isAdmin = isMasterAdmin || cachedProfile.isAdmin;
                    state.isAuthorized = isMasterAdmin || cachedProfile.isAuthorized;
                }

                if (state.isAuthorized && hasInitialData) {
                    state.isLoading = false;
                }

                if (navigator.onLine) {
                    try {
                        const { data: profile, error } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        if (!error && profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);

                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({
                                isAdmin: state.isAdmin,
                                isAuthorized: state.isAuthorized
                            }));
                        }
                    } catch (e) { }
                    if (state.isAuthorized) await refreshAllData();
                }
            }

            state.isLoading = false;

            window.history.replaceState({ screen: 'home' }, "");
            window.addEventListener('popstate', (event) => {
                if (state.isMenuOpen) { state.isMenuOpen = false; return; }
                const modal = document.getElementById('modal-container');
                if (modal && !modal.classList.contains('hidden')) {
                    closeModal();
                    if (state.currentScreen === 'home') window.history.pushState({ screen: 'home' }, "");
                    return;
                }
                if (event.state && event.state.screen) navigateTo(event.state.screen, false);
                else {
                    if (state.currentScreen === 'home') { window.showExitConfirmation(); window.history.pushState({ screen: 'home' }, ""); }
                    else navigateTo('home', false);
                }
            });

            window.addEventListener('offline', () => { showConnStatus('offline'); });
            window.addEventListener('online', () => processOfflineQueue(true));

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'TOKEN_REFRESHED' && session) {
                    state.user = session.user;
                    console.log("Token refreshed");
                    return;
                }

                if (event === 'SIGNED_OUT' || !session) {
                    cleanupListeners();
                    state.user = null; state.isAuthorized = false; state.isAdmin = false; state.currentScreen = 'home';
                    localStorage.removeItem(USER_PROFILE_CACHE_KEY); scheduleRender(); return;
                }

                state.user = session?.user || null;
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();

                if (session?.user && navigator.onLine) {
                    try {
                        const { data: profile } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        if (profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);
                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({ isAdmin: state.isAdmin, isAuthorized: state.isAuthorized }));
                        }
                    } catch (e) { }
                }

                if (state.isAuthorized) {
                    await refreshAllData();
                    cleanupListeners();
                    setupListener('types', 'types');
                    setupListener('locations', 'locations');
                    setupListener('attendants', 'attendants');
                    setupListener('agenda', 'events');
                    setupListener('feriados', 'feriados');
                    setupListener('perfis', 'perfis');
                }
                if (event === 'SIGNED_IN') closeModal();
                scheduleRender();
            });

            if (state.isAuthorized) {
                setupListener('types', 'types');
                setupListener('locations', 'locations');
                setupListener('attendants', 'attendants');
                setupListener('agenda', 'events');
                setupListener('feriados', 'feriados');
                setupListener('perfis', 'perfis');
            }

            loadExternalHolidays(new Date().getFullYear());



            // Tenta sincronizar pendências logo ao abrir o app
            if (navigator.onLine) processOfflineQueue(true);
        }

        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); window.deferredPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches) window.showInstallPromptModal();
        });

        window.addEventListener('appinstalled', (evt) => {
            setTimeout(() => { closeModal(); showLoginModal(true); }, 8000);
        });

        let lastHiddenTime = 0;
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                lastHiddenTime = Date.now();
                console.log("[Visibility] App invisível às:", new Date(lastHiddenTime).toLocaleTimeString());
            } else if (document.visibilityState === 'visible' && lastHiddenTime > 0) {
                const now = Date.now();
                const diffMinutes = (now - lastHiddenTime) / 1000 / 60;
                console.log(`[Visibility] App visível novamente. Ficou invisível por ${diffMinutes.toFixed(2)} minutos.`);

                if (diffMinutes >= 1) {
                    if (navigator.onLine) {
                        console.log("[Visibility] Online e >= 1 min: Forçando recarregamento da página...");
                        window.location.reload(true);
                    } else {
                        console.log("[Visibility] Offline e >= 1 min: Recarregando dados do cache...");
                        loadCachedData();
                        scheduleRender();
                    }
                }
                lastHiddenTime = 0;
            }
        });

        init();
    </script>

</body>

</html>
