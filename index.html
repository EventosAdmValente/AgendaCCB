<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda CCB</title>
    <meta name="description" content="Agenda CCB">
    <meta name="theme-color" content="#003366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Agenda CCB">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #334155;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        html,
        body,
        * {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .bg-navy {
            background-color: #003366;
        }

        .text-navy {
            color: #003366;
        }

        .border-navy {
            border-color: #003366;
        }

        .bg-orange-custom {
            background-color: #FF8C00;
        }

        .text-orange-custom {
            color: #FF8C00;
        }

        .border-orange-custom {
            border-color: #FF8C00;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
        }

        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
        }

        .disabled-area {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(1);
        }

        .input-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            border-width: 2px !important;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background-color: #f1f5f9;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #003366;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #94a3b8;
        }

        #report-capture-area {
            width: 794px;
            min-height: 1123px;
            background: white;
            padding: 50px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            transform-origin: top center;
        }

        .highlight-item {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b !important;
        }

        #conn-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            transition: all 0.3s ease;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
        }

        #conn-status.offline {
            background: #ef4444;
            color: white;
            opacity: 1;
            visibility: visible;
        }

        #conn-status.online-recovered {
            background: #10b981;
            color: white;
            opacity: 1;
            visibility: visible;
        }

        .sync-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #f59e0b;
            color: white;
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .temp-badge {
            background-color: #fff7ed;
            border: 1px solid #ffedd5;
            color: #9a3412;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        @keyframes highlight-pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .highlight-item {
            animation: highlight-pulse 1s ease-in-out;
        }
    </style>
    <link rel="manifest" href="./manifest.json">

</head>

<body class="h-screen w-full flex flex-col bg-slate-100">

    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <span class="loading-text">Carregando Agenda...</span>
        </div>
    </div>

    <div id="conn-status"></div>

    <div id="modal-container"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm"></div>

    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 id="modal-login-title" class="font-bold text-lg text-navy uppercase tracking-tight">Fa√ßa Login ou
                    Cadastro</h3>
                <button type="button" onclick="window.closeModal()" class="text-slate-400 p-1 hover:text-slate-600"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div id="name-field" class="hidden">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Nome Completo</label>
                    <input type="text" id="login-name"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="Seu nome">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Email</label>
                    <input type="email" id="login-email"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="exemplo@email.com" required>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Senha</label>
                    <input type="password" id="login-password"
                        class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div id="login-error"
                    class="text-red-500 text-[11px] hidden font-bold bg-red-50 p-2 rounded-lg border border-red-100">
                </div>
                <button type="submit" id="login-submit-btn"
                    class="w-full py-4 rounded-xl bg-navy text-white font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Entrar</button>
                <div class="text-center pt-2">
                    <button type="button" id="toggle-auth-mode"
                        class="text-[11px] font-bold text-slate-500 hover:text-navy uppercase tracking-tight underline">N√£o
                        tem conta? Cadastre-se</button>
                </div>
            </form>
        </div>
    </template>

    <script type="module">
        const SUPABASE_URL = "https://gcsvapoqpbrrqubxawkd.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdjc3ZhcG9xcGJycnF1Ynhhd2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTgyMzYsImV4cCI6MjA4MDQ3NDIzNn0.QtIldObznGEYTXyEf0MS4mIgIDgbMKmS0M2FBVInTZQ";
        const ADMIN_EMAIL = "eventosadmvalente@gmail.com";
        // Singleton: Garante que n√£o criaremos m√∫ltiplos clientes se o script rodar de novo
        if (!window.supabaseInstance) {
            window.supabaseInstance = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true,
                    storageKey: 'agenda-ccb-auth'
                },
                realtime: {
                    timeout: 20000 // Aumentado para 20s conforme solicitado
                }
            });

            // Monitoramento Heartbeat para detectar falhas de conex√£o
            window.supabaseInstance.realtime.onHeartbeat(() => {
                console.log("[Realtime] Heartbeat recebido - Conex√£o ativa.");
            });
        }
        const supabaseClient = window.supabaseInstance;

        // Gerenciamento de canais com prote√ß√£o contra duplicidade
        const activeChannels = new Map();

        // Centraliza a cria√ß√£o de todos os listeners do Realtime
        function setupAllListeners() {
            console.log("[Realtime] Iniciando subscri√ß√£o de todos os canais...");
            const listeners = [
                { table: 'agenda', stateKey: 'events' },
                { table: 'types', stateKey: 'types' },
                { table: 'locations', stateKey: 'locations' },
                { table: 'attendants', stateKey: 'attendants' },
                { table: 'feriados', stateKey: 'feriados' },
                { table: 'perfis', stateKey: 'perfis' }
            ];

            listeners.forEach(l => setupListener(l.table, l.stateKey));
        }

        // Monitora quando o app volta a ficar vis√≠vel (mobile-friendly)
        let lastVisibleTime = Date.now();
        const handleFocusOrVisible = async () => {
            if (document.visibilityState === "hidden") {
                lastVisibleTime = Date.now();
                console.log("[App] App ficou invis√≠vel");
                return;
            }

            // Flag radical: voltamos do foco
            state.returnedFromFocus = true;

            const minutesHidden = (Date.now() - lastVisibleTime) / 1000 / 60;
            console.log(`[App] App vis√≠vel novamente ap√≥s ${minutesHidden.toFixed(2)} minutos`);

            // Se houver pend√™ncias na fila ao voltar do foco, recarrega IMEDIATAMENTE
            const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
            if (queue.length > 0) {
                console.log("[App] Pend√™ncias detectadas no retorno do foco. For√ßando recarregamento...");
                window.location.reload();
            }
        };

        document.addEventListener("visibilitychange", handleFocusOrVisible);
        window.addEventListener("focus", handleFocusOrVisible);

        window.loadFromCache = () => {
            console.log("[App] Carregando dados do cache local...");
            const tables = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'agenda': 'events', 'feriados': 'feriados', 'perfis': 'perfis' };
            Object.entries(tables).forEach(([table, key]) => {
                try {
                    const cached = localStorage.getItem(`cache_${table}`);
                    if (cached) state[key] = JSON.parse(cached);
                } catch (e) { }
            });
            state.isLoading = false;
            scheduleRender();
        };


        const setupListener = (table, stateKey) => {
            const channelName = `public:${table}`;

            if (activeChannels.has(channelName)) {
                const oldChannel = activeChannels.get(channelName);
                supabaseClient.removeChannel(oldChannel);
                activeChannels.delete(channelName);
            }


            const cacheSaveTimers = {};
            const debouncedSave = (table, data) => {
                if (cacheSaveTimers[table]) clearTimeout(cacheSaveTimers[table]);
                cacheSaveTimers[table] = setTimeout(() => {
                    localStorage.setItem(`cache_${table}`, JSON.stringify(data));
                    delete cacheSaveTimers[table];
                }, 2000);
            };

            const uiUpdateTimers = {};
            const requestUIUpdate = (table) => {
                if (uiUpdateTimers[table]) cancelAnimationFrame(uiUpdateTimers[table]);
                uiUpdateTimers[table] = requestAnimationFrame(() => {
                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);
                    delete uiUpdateTimers[table];
                });
            };

            const isSameRecord = (r1, r2, table) => {
                if (table === 'agenda') {
                    return r1.date === r2.date && r1.time === r2.time && String(r1.location_id) === String(r2.location_id) && String(r1.type_id) === String(r2.type_id);
                } else if (table === 'locations') {
                    return r1.localidade === r2.localidade && r1.setor === r2.setor && r1.adm === r2.adm;
                } else if (table === 'types' || table === 'attendants' || table === 'feriados' || table === 'perfis') {
                    const name1 = r1.name || r1.nome || r1.nome_feriado;
                    const name2 = r2.name || r2.nome || r2.nome_feriado;
                    return name1 === name2;
                }
                return false;
            };

            const channel = supabaseClient.channel(channelName)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table }, (payload) => {
                    const current = [...(state[stateKey] || [])];
                    if (current.find(item => String(item.id) === String(payload.new.id))) return;

                    // Tenta encontrar um registro tempor√°rio que corresponda a este novo registro real
                    const tempItem = current.find(item => String(item.id).startsWith('temp_') && isSameRecord(item, payload.new, table));

                    if (tempItem) {
                        console.log(`[setupListener] Mesclando INSERT real ${payload.new.id} sobre tempor√°rio ${tempItem.id}`);
                        state[stateKey] = current.map(item => item.id === tempItem.id ? payload.new : item);
                    } else {
                        state[stateKey] = [...current, payload.new];
                    }

                    debouncedSave(table, state[stateKey]);
                    requestUIUpdate(table);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table }, async (payload) => {
                    const current = [...(state[stateKey] || [])];
                    state[stateKey] = current.map(item => String(item.id) === String(payload.new.id) ? payload.new : item);
                    debouncedSave(table, state[stateKey]);

                    // Atualiza a UI para refletir as mudan√ßas
                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);

                    if (table === 'perfis' && state.user && payload.new.id === state.user.id) {
                        const isMasterAdmin = (state.user.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase());
                        const wasAuthorized = state.isAuthorized;

                        state.isAdmin = isMasterAdmin || (payload.new.permissao === 'admin');
                        state.isAuthorized = isMasterAdmin || (payload.new.autorizado === true);

                        localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({
                            isAdmin: state.isAdmin,
                            isAuthorized: state.isAuthorized
                        }));

                        if (state.isAuthorized && !wasAuthorized) await refreshAllData();
                    }
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table }, (payload) => {
                    const current = [...(state[stateKey] || [])];
                    state[stateKey] = current.filter(item => String(item.id) !== String(payload.old.id));
                    debouncedSave(table, state[stateKey]);

                    if (state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
                    const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
                    if (state.currentScreen === screenMap[table]) window.updateManagerListUI(table);
                })
                .subscribe((status) => {
                    console.log(`[Realtime] ${table} - Status: ${status}`);
                    if (status === 'SUBSCRIBED') {
                        console.log(`‚úÖ [Realtime] Monitorando tabela: ${table}`);
                    }
                    if (status === 'CHANNEL_ERROR') {
                        console.error(`‚ùå [Realtime] Erro no canal ${table}, tentando reconectar em 3s...`);
                        setTimeout(() => {
                            if (navigator.onLine) {
                                console.log(`üîÑ [Realtime] Reconectando ${table}...`);
                                setupListener(table, stateKey);
                            }
                        }, 3000);
                    }
                    if (status === 'TIMED_OUT') {
                        console.error(`‚è±Ô∏è [Realtime] Timeout no canal ${table}, tentando reconectar em 3s...`);
                        setTimeout(() => {
                            if (navigator.onLine) {
                                console.log(`üîÑ [Realtime] Reconectando ${table}...`);
                                setupListener(table, stateKey);
                            }
                        }, 3000);
                    }
                });

            activeChannels.set(channelName, channel);
        };

        // Helper para evitar que chamadas ao Supabase fiquem presas indefinidamente em redes inst√°veis
        function withTimeout(promise, ms = 15000) {
            let timeoutId;
            const timeoutPromise = new Promise((_, reject) => {
                timeoutId = setTimeout(() => reject(new Error('TIMEOUT_EXCEEDED')), ms);
            });
            return Promise.race([
                promise,
                timeoutPromise
            ]).finally(() => clearTimeout(timeoutId));
        }

        function translateAuthError(message) {
            const msg = message.toLowerCase();
            if (msg.includes('invalid login credentials')) return "E-mail ou senha incorretos.";
            if (msg.includes('user already registered')) return "Este e-mail j√° est√° cadastrado no sistema.";
            if (msg.includes('password should be at least 6 characters')) return "A senha deve ter pelo menos 6 caracteres.";
            if (msg.includes('signup requires a valid email')) return "Por favor, insira um endere√ßo de e-mail v√°lido.";
            if (msg.includes('email not confirmed')) return "E-mail ainda n√£o confirmado. Verifique sua caixa de entrada.";
            if (msg.includes('invalid email or password')) return "E-mail ou senha inv√°lidos.";
            return message;
        }

        const SYNC_QUEUE_KEY = 'adm_valente_sync_queue';
        const USER_PROFILE_CACHE_KEY = 'cache_user_profile';

        let isProcessingQueue = false;
        async function processOfflineQueue(isRecovery = false) {
            console.log(`[processOfflineQueue] Iniciando... (onLine=${navigator.onLine}, alreadyProcessing=${isProcessingQueue})`);
            if (!navigator.onLine || isProcessingQueue) return;
            isProcessingQueue = true;

            try {
                if (isRecovery) showConnStatus('online-recovered');
                await new Promise(resolve => setTimeout(resolve, 500));

                while (navigator.onLine) {
                    const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                    console.log(`[processOfflineQueue] Itens na fila: ${queue.length}`);
                    if (queue.length === 0) break;

                    const item = queue[0];
                    const { table, action, id, originalSnapshot } = item;
                    console.log(`[processOfflineQueue] Processando item: ${action} em ${table} (id=${id})`);

                    // Verifica√ß√£o de Conflito para Updates com Timeout e Retentativas
                    if (action === 'UPDATE' && id && originalSnapshot) {
                        let serverRecord = null;
                        let conflictErr = null;
                        let retries = 0;
                        const MAX_RETRIES = 3;

                        while (retries <= MAX_RETRIES) {
                            console.log(`[processOfflineQueue] Verificando conflitos para ${table}:${id} (Tentativa ${retries + 1}/${MAX_RETRIES + 1})...`);
                            const startTime = Date.now();

                            try {
                                const result = await withTimeout(
                                    supabaseClient.from(table).select('*').eq('id', id).single(),
                                    20000
                                );
                                serverRecord = result.data;
                                conflictErr = result.error;
                                console.log(`[processOfflineQueue] Resposta recebida em ${((Date.now() - startTime) / 1000).toFixed(2)}s`);
                                break;
                            } catch (err) {
                                console.error(`[processOfflineQueue] Tentativa ${retries + 1} falhou/timeout:`, err);
                                retries++;
                                if (retries <= MAX_RETRIES) {
                                    console.log("[processOfflineQueue] Aguardando 2s para nova tentativa...");
                                    await new Promise(r => setTimeout(r, 2000));
                                } else {
                                    conflictErr = err;
                                }
                            }
                        }

                        if (conflictErr && (conflictErr.message === 'TIMEOUT_EXCEEDED' || !conflictErr.code)) {
                            console.warn("[processOfflineQueue] Rede permanentemente inst√°vel. Abortando fila.");
                            break;
                        }

                        const serverString = serverRecord ? JSON.stringify(serverRecord) : null;
                        const snapshotString = JSON.stringify(originalSnapshot);

                        if (!serverRecord || (serverString !== snapshotString && serverRecord.alterado_por !== state.user.id)) {
                            console.log("[processOfflineQueue] Conflito detectado, abrindo modal.");
                            showConflictModal(item, serverRecord);
                            return;
                        }
                    }

                    const success = await executeSync(item, isRecovery);
                    console.log(`[processOfflineQueue] Resultado do executeSync: ${success}`);
                    if (!success) break;
                }
            } catch (err) {
                console.error("[processOfflineQueue] Erro fatal na fila:", err);
            } finally {
                console.log("[processOfflineQueue] Finalizado.");
                isProcessingQueue = false;
            }
        }

        async function executeSync(item, isRecovery = false) {
            const { table, action, data, id } = item;
            const cleanData = { ...data };
            delete cleanData.id;
            const stateKey = table === 'agenda' ? 'events' : table;

            try {
                console.log(`[executeSync] Sincronizando ${action} para ${table}...`);

                // 1. Verifica√ß√£o proativa da sess√£o com Timeout e renova√ß√£o for√ßada
                let { data: { session }, error: sessionError } = await withTimeout(supabaseClient.auth.getSession(), 5000).catch(() => ({ data: { session: null } }));
                if (!session || sessionError) {
                    console.log("[executeSync] Sess√£o inv√°lida ou expirada. Tentando renovar...");
                    const refresh = await withTimeout(supabaseClient.auth.refreshSession(), 8000).catch(() => ({ data: { session: null } }));
                    session = refresh.data?.session;
                }

                if (!session) {
                    console.warn("[executeSync] N√£o foi poss√≠vel obter uma sess√£o v√°lida.");
                    return false;
                }

                // 2. Garantir que o canal est√° de p√© se estivermos online
                if (navigator.onLine && (!supabaseClient.realtime || !supabaseClient.realtime.isConnected())) {
                    console.log("[executeSync] Socket desconectado. For√ßando conex√£o antes do envio...");
                    supabaseClient.realtime.connect();
                }

                // 3. Executa a opera√ß√£o com Timeout e l√≥gica de retentativa para erros de rede
                let res;
                const dbOp = async () => {
                    if (action === 'INSERT') return supabaseClient.from(table).insert(cleanData).select().single();
                    if (action === 'UPDATE') return supabaseClient.from(table).update(cleanData).eq('id', id).select().single();
                    if (action === 'DELETE') return supabaseClient.from(table).delete().eq('id', id);
                };

                res = await withTimeout(dbOp(), 15000).catch(err => {
                    return { error: { message: 'Network Failure/Timeout', details: err, status: 0 } };
                });

                if (res && res.error) {
                    console.error(`[executeSync] Erro Supabase em ${table} (${action}):`, res.error);

                    // Se erro de autoriza√ß√£o (401), limpa login e para.
                    if (res.error.status === 401) {
                        console.error("[executeSync] Erro 401: Usu√°rio deslogado ou token inv√°lido.");
                        return false;
                    }

                    // Se erro de rede/timeout (status 0 ou sem status), tenta reconectar para a pr√≥xima tentativa
                    if (!res.error.status || res.error.status === 0 || res.error.message?.includes('Timeout')) {
                        console.warn("[executeSync] Erro de rede detectado. For√ßando reconex√£o do socket.");
                        if (supabaseClient.realtime) supabaseClient.realtime.disconnect();
                        setTimeout(() => supabaseClient.realtime.connect(), 500);
                        return false;
                    }

                    // Erros Fatais de valida√ß√£o/banco (Remover da fila para n√£o travar o resto)
                    const fatalErrors = ['42703', 'PGRST204', '23505', '23502', '23503'];
                    if (fatalErrors.includes(res.error.code) || res.error.status === 404 || res.error.status === 400) {
                        console.warn("[executeSync] Erro fatal detectado. Removendo item inv√°lido da fila.");
                        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                        const newQueue = queue.filter(q => q.timestamp !== item.timestamp);
                        localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(newQueue));
                        return true;
                    }
                    return false;
                }

                // 3. Sucesso: Mapear IDs tempor√°rios se necess√°rio
                if (action === 'INSERT' && res.data && String(id).startsWith('temp_')) {
                    const realId = res.data.id;
                    state[stateKey] = (state[stateKey] || []).map(i => String(i.id) === String(id) ? res.data : i);
                    localStorage.setItem(`cache_${table}`, JSON.stringify(state[stateKey]));

                    const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                    const updatedQueue = queue.map(q => {
                        if (q.table === table && String(q.id) === String(id)) q.id = realId;
                        return q;
                    });
                    localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(updatedQueue));
                    if (String(state.highlightedItemId) === String(id)) state.highlightedItemId = realId;
                }

                // 4. Remover da fila e atualizar snapshots subsequentes
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                const newQueue = queue.filter(q => q.timestamp !== item.timestamp);
                const finalQueue = newQueue.map(q => {
                    if (q.table === table && String(q.id) === String(id) && q.action === 'UPDATE') {
                        q.originalSnapshot = res.data;
                    }
                    return q;
                });
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(finalQueue));
                return true; // Continua loop
            } catch (err) {
                console.error("[executeSync] Exce√ß√£o:", err);
                return false;
            }
        }

        function showConflictModal(item, serverRecord) {
            const { table, data } = item;
            const isDeleted = !serverRecord;

            showModal(`
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border-t-8 border-orange-custom">
                        <div class="p-8 flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6 text-orange-custom">
                                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3">Houve altera√ß√£o de dados</h3>
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">
                                ${isDeleted ? 'O registro que voc√™ estava modificando foi exclu√≠do por outro usu√°rio.' : 'O registro que voc√™ estava modificando foi alterado por outro usu√°rio.'}
                                <br><br>Voc√™ deseja descartar ou gravar as suas altera√ß√µes?
                            </p>
                            <div class="w-full flex gap-3">
                                <button onclick="window.resolveConflict('descartar', ${JSON.stringify(item).replace(/"/g, '&quot;')}, ${JSON.stringify(serverRecord).replace(/"/g, '&quot;')})" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Descartar</button>
                                <button onclick="window.resolveConflict('gravar', ${JSON.stringify(item).replace(/"/g, '&quot;')})" class="flex-1 py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Gravar</button>
                            </div>
                        </div>
                    </div>
                `);
        }

        window.resolveConflict = async (decision, item, serverRecord) => {
            const targetScreen = item.table === 'agenda' ? 'home' : (item.table === 'perfis' ? 'users' : item.table);

            if (decision === 'descartar') {
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                const newQueue = queue.filter(q => q.timestamp !== item.timestamp);
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(newQueue));

                const stateKey = item.table === 'agenda' ? 'events' : item.table;
                if (serverRecord) {
                    const currentList = [...(state[stateKey] || [])];
                    const idx = currentList.findIndex(i => String(i.id) === String(serverRecord.id));
                    if (idx !== -1) currentList[idx] = serverRecord;
                    state[stateKey] = currentList;
                    localStorage.setItem(`cache_${item.table}`, JSON.stringify(currentList));
                    state.highlightedItemId = serverRecord.id;
                } else {
                    state[stateKey] = (state[stateKey] || []).filter(i => String(i.id) !== String(item.id));
                    localStorage.setItem(`cache_${item.table}`, JSON.stringify(state[stateKey]));
                }
                closeModal();
                processOfflineQueue();
                window.navigateTo(targetScreen);
            } else {
                // Gravar: atualiza o snapshot original para bater com o servidor e permitir o overwrite
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                const updatedQueue = queue.map(q => {
                    if (q.timestamp === item.timestamp) q.originalSnapshot = serverRecord;
                    return q;
                });
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(updatedQueue));
                closeModal();
                processOfflineQueue();
                window.navigateTo(targetScreen);
            }
        };

        window.smartSave = async (table, action, data, id = null, callback = null) => {
            console.log(`[smartSave] Offline-First: ${table} | A√ß√£o: ${action}`);
            const isNew = action === 'INSERT';
            const tempId = isNew ? `temp_${Date.now()}` : id;
            const finalId = id || tempId;
            const stateKey = table === 'agenda' ? 'events' : table;

            if (state.user && data) data.alterado_por = state.user.id;

            let originalSnapshot = null;
            if (action === 'UPDATE' && id) {
                originalSnapshot = state[stateKey].find(i => String(i.id) === String(id));
            }

            // 1. SALVAR IMEDIATAMENTE NO NAVEGADOR (State + localStorage)
            console.log("[smartSave] Atualizando estado local do navegador...");
            let list = [...(state[stateKey] || [])];
            if (action === 'INSERT') {
                list.push({ id: tempId, ...data });
            } else if (action === 'UPDATE') {
                const idx = list.findIndex(i => String(i.id) === String(id));
                if (idx !== -1) list[idx] = { ...list[idx], ...data };
            } else if (action === 'DELETE') {
                list = list.filter(i => String(i.id) !== String(id));
            }

            state[stateKey] = list;
            localStorage.setItem(`cache_${table}`, JSON.stringify(list));

            // Aplica destaque e rolagem
            state.highlightedItemId = finalId;

            // Atualiza UI instantaneamente
            if (window.state.currentScreen === 'home' && table === 'agenda') window.updateHomeList();
            const screenMap = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'feriados': 'feriados', 'perfis': 'users' };
            if (window.state.currentScreen === screenMap[table]) window.updateManagerListUI(table);

            // Se houver um callback (ex: closeModal, navigateTo), chama AGORA
            if (callback) callback();

            // 2. ADICIONAR NA FILA DE SINCRONIZA√á√ÉO
            const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
            queue.push({ table, action, data, id: finalId, timestamp: Date.now(), originalSnapshot });
            localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));

            // 3. DISPARAR SINCRONIZA√á√ÉO EM SEGUNDO PLANO
            console.log("[smartSave] Disparando sincroniza√ß√£o...");

            // L√≥gica Radical: se acabamos de voltar do foco e tentamos salvar, recarregamos para garantir conex√£o
            if (state.returnedFromFocus) {
                state.returnedFromFocus = false;
                console.log("[smartSave] Salvamento detectado ap√≥s retorno de foco. For√ßando recarregamento de limpeza...");
                setTimeout(() => window.location.reload(), 100);
            } else {
                if (navigator.onLine) processOfflineQueue(false);
                else showConnStatus('offline');
            }

            return { success: true, offline: true, tempId };
        };

        window.addEventListener('online', () => processOfflineQueue(true));

        const getCachedProfile = () => {
            try {
                const p = localStorage.getItem(USER_PROFILE_CACHE_KEY);
                return p ? JSON.parse(p) : { isAdmin: false, isAuthorized: false };
            } catch (e) { return { isAdmin: false, isAuthorized: false }; }
        };
        const initialProfile = getCachedProfile();

        const INITIAL_STATE = {
            user: null,
            isAdmin: initialProfile.isAdmin || false,
            isAuthorized: initialProfile.isAuthorized || false,
            currentScreen: 'home',
            events: [],
            types: [],
            locations: [],
            attendants: [],
            feriados: [],
            perfis: [],
            externalHolidays: [],
            fetchedYears: new Set(),
            isMenuOpen: false,
            editingEventId: null,
            searchTerm: '',
            managerSearchTerm: '',
            highlightedItemId: null,
            fastFilter: { active: false, dateStart: '', dateEnd: '', label: '' },
            ffTemp: {
                selected: 'today',
                baseDates: {
                    today: new Date(),
                    week: new Date(),
                    month: new Date(),
                    year: new Date()
                }
            },
            selectedDate: null,
            viewDate: new Date(),
            formTempDate: '', formTempTime: '08:00', formTempLoc: '', formTempType: '', formTempAtt: '', formTempAtt2: '',
            formTempIrmaos: '', formTempIrmas: '',
            isLoading: true,
            advancedFilter: {
                active: false,
                eventos: { enabled: false, status: 'ativos' },
                type: { enabled: false, id: '' },
                location: { enabled: false, id: '' },
                attendant: { enabled: false, id: '' },
                adm: { enabled: false, value: '' },
                setor: { enabled: false, value: '' },
                cidade: { enabled: false, value: '' },
                period: { enabled: false, start: '', end: '' },
                validationErrors: []
            },
            formErrors: [],
            clockMode: 'hour',
            clockTempHour: '08',
            clockTempMinute: '00',
            originalEventSnapshot: null,
            masterEventFilter: localStorage.getItem('masterEventFilter') || 'ativos',
            returnedFromFocus: false
        };

        const state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                if (target[property] === value) return true;
                target[property] = value;

                const silent = [
                    'searchTerm', 'managerSearchTerm', 'clockMode', 'clockTempHour', 'clockTempMinute',
                    'ffTemp', 'fetchedYears', 'formErrors',
                    'events', 'types', 'locations', 'attendants', 'feriados', 'perfis'
                ];
                if (!silent.includes(property)) {
                    scheduleRender();
                }

                if (property === 'searchTerm' && window.updateHomeList) {
                    window.updateHomeList();
                }

                if (property === 'currentScreen' && value === 'home') {
                    if (!state.highlightedItemId) state.highlightedItemId = null;
                }

                if (['clockMode', 'clockTempHour', 'clockTempMinute'].includes(property)) {
                    if (typeof window.renderClockUI === 'function') window.renderClockUI();
                }

                return true;
            }
        });
        window.state = state;

        async function loadExternalHolidays(year) {
            if (state.fetchedYears.has(year)) return;

            try {
                const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${year}`);
                if (!response.ok) throw new Error("Erro API");
                const holidays = await response.json();

                const dateBA = `${year}-07-02`;
                if (!holidays.some((h) => h.date === dateBA)) {
                    holidays.push({ date: dateBA, name: "Independ√™ncia da Bahia", type: "state" });
                }

                state.externalHolidays = [...state.externalHolidays, ...holidays];
                state.fetchedYears.add(year);
                scheduleRender();
            } catch (e) { }
        }

        let renderTimer = null;
        function scheduleRender() {
            if (renderTimer) return;
            renderTimer = window.requestAnimationFrame(() => {
                renderApp();
                renderTimer = null;
            });
        }

        const formatDate = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`; };
        const formatDateFull = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0]}`; };
        const isEventPast = (date, time) => { return new Date(`${date}T${time}`) < new Date(); };

        function renderIcons() { if (window.lucide) window.lucide.createIcons(); }

        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            if (state.isLoading) {
                app.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><span class="loading-text">Conectando...</span></div>`;
                return;
            }

            switch (state.currentScreen) {
                case 'home': renderHome(); break;
                case 'event-form': renderEventForm(); break;
                case 'types': renderGenericManager('Tipos de Eventos', 'types'); break;
                case 'locations': renderGenericManager('Cidades / Localidades', 'locations'); break;
                case 'attendants': renderGenericManager('Atendentes', 'attendants'); break;
                case 'feriados': renderGenericManager('Feriados', 'feriados'); break;
                case 'users': renderGenericManager('Gest√£o de Usu√°rios', 'perfis'); break;
                case 'options': renderOptions(); break;
                case 'about': renderAbout(); break;
            }
            renderIcons();
        }

        window.updateHomeList = () => {
            const container = document.getElementById('event-list-container');
            if (!container) return;

            if (!state.isAuthorized) {
                container.innerHTML = '';
                return;
            }

            const filtered = getFilteredEvents();
            container.innerHTML = `
                <div class="flex justify-between items-start px-1 mb-1 gap-2 min-h-[18px] overflow-visible">
                    <div id="home-filter-label" class="font-bold text-navy uppercase flex-1 min-w-0 leading-tight whitespace-normal break-words overflow-visible transition-all duration-200" style="font-size: 13px;">
                        ${getFilterDescription()}
                    </div>
                    <span class="text-[10px] font-medium text-slate-500 uppercase shrink-0 pt-0.5">${filtered.length} registros</span>
                </div>
                <div class="flex-1 bg-white rounded-xl shadow-md overflow-y-auto border border-slate-200 scrollbar-none">
                    ${filtered.length === 0 ? '<div class="p-12 text-center text-slate-400 flex flex-col items-center gap-4"><i data-lucide="calendar-x" class="w-10 h-10 opacity-20"></i><span>Nenhum evento encontrado.</span></div>' : `
                        <ul class="divide-y divide-slate-100">
                            ${filtered.map((e) => {
                const type = state.types.find((t) => t.id === e.type_id);
                const loc = state.locations.find((l) => l.id === e.location_id);
                const att = state.attendants.find((a) => a.id === e.attendant_id);
                const att2 = state.attendants.find((a) => a.id === e.attendant2_id);
                const isPast = isEventPast(e.date, e.time);
                const isHighlighted = state.highlightedItemId === e.id;

                const typeNameLower = (type?.name || '').toLowerCase();
                const isBatismo = typeNameLower.includes('batismo');
                const isSantaCeia = typeNameLower.includes('santa ceia');
                const hasStats = isBatismo || isSantaCeia;
                const total = (e.irmaos || 0) + (e.irmas || 0);
                const isTemp = String(e.id).startsWith('temp_');

                // Formatar exibi√ß√£o dos atendentes
                let attendantDisplay = att?.name || '';
                if (att2?.name) {
                    attendantDisplay = `${att?.name || ''} / ${att2.name}`;
                }

                return `
                                    <li id="item-${e.id}" onclick="${state.isAdmin ? `window.openEditEvent('${e.id}')` : ''}" class="relative p-3 transition-all ${isHighlighted ? 'bg-yellow-50 ring-2 ring-yellow-400 ring-inset z-10 highlight-item' : state.isAdmin ? 'active:bg-slate-50' : ''} ${isPast && !isHighlighted ? 'bg-slate-50/50 grayscale-[0.5] opacity-70' : ''}">
                                        
                                        <div class="absolute top-3 right-3 flex flex-col items-end gap-1.5 z-10">
                                            <div class="flex items-center gap-1.5">
                                                ${isTemp ? `<div class="temp-badge"><i data-lucide="cloud-off" class="w-2.5 h-2.5"></i> Pendente</div>` : ''}
                                                <span class="text-[9px] font-black bg-navy text-white px-1.5 py-0.5 rounded uppercase tracking-tighter shadow-sm">
                                                    ${type?.sigla || 'EVT'}
                                                </span>
                                            </div>
                                            ${hasStats ? `
                                                <div class="flex flex-col items-end text-[12.15px] font-semibold text-slate-400 leading-tight mt-1">
                                                    <div>Irm√£s: ${e.irmas || 0}</div>
                                                    <div>Irm√£os: ${e.irmaos || 0}</div>
                                                    <div>Total: ${total}</div>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${isPast ? 'bg-slate-200 text-slate-500' : 'bg-blue-50 text-navy border border-blue-100'}">
                                                <i data-lucide="${isPast ? 'check-circle' : 'calendar-clock'}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 pr-16 flex flex-col justify-center">
                                                <div class="font-bold text-navy text-[16.2px] leading-tight whitespace-normal">${type?.name || 'Evento'}</div>
                                                <div class="text-[12.15px] font-semibold text-slate-600 mt-1 leading-tight">${formatDate(e.date)} - ${e.time}</div>
                                                <div class="flex flex-col gap-1 mt-1 leading-tight">
                                                    <div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${loc?.localidade || ''}</span></div>
                                                    ${attendantDisplay ? `<div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${attendantDisplay}</span></div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                `;
            }).join('')}
                        </ul>
                    `}
                </div >
                `;

            const labelEl = document.getElementById('home-filter-label');
            if (labelEl) {
                let currentSize = 13;
                labelEl.style.fontSize = currentSize + 'px';
                while (labelEl.scrollHeight > 34 && currentSize > 9) {
                    currentSize -= 0.2;
                    labelEl.style.fontSize = currentSize + 'px';
                }
            }
            renderIcons();

            if (state.highlightedItemId) {
                setTimeout(() => {
                    const el = document.getElementById(`item-${state.highlightedItemId}`);
                    if (el) el.scrollIntoView({ behavior: 'auto', block: 'center' });
                }, 100);
            }
        };

        window.updateManagerListUI = (coll) => {
            const container = document.getElementById('manager-items-container');
            const stats = document.getElementById('manager-list-stats');
            if (!container || !stats) return;

            let itemIcon = 'tag';
            if (coll === 'locations') itemIcon = 'map-pin';
            if (coll === 'attendants') itemIcon = 'user';
            if (coll === 'feriados') itemIcon = 'sun';
            if (coll === 'perfis') itemIcon = 'shield-check';

            const items = [...(state[coll] || [])];
            items.sort((a, b) => {
                if (coll === 'feriados') return (a.data || '').localeCompare(b.data || '');
                const nameA = (coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '';
                const nameB = (coll === 'locations' ? b.localidade : (coll === 'perfis' ? b.nome : b.name)) || '';
                return nameA.localeCompare(nameB, 'pt-BR', { sensitivity: 'base' });
            });
            const term = (state.managerSearchTerm || '').toLowerCase();
            const filtered = items.filter((i) => {
                let match = false;
                if (coll === 'types') match = (i.name || '').toLowerCase().includes(term) || (i.sigla || '').toLowerCase().includes(term);
                else if (coll === 'locations') {
                    const attendantsStr = [i.anciao_1, i.anciao_2, i.anciao_3, i.diacono_1, i.diacono_2, i.diacono_3, i.com_1, i.com_2, i.cjm].filter(Boolean).join(' ').toLowerCase();
                    match = (i.localidade || '').toLowerCase().includes(term) || (i.adm || '').toLowerCase().includes(term) || (i.setor || '').toLowerCase().includes(term) || (i.cidade || '').toLowerCase().includes(term) || attendantsStr.includes(term);

                    if (state.advancedFilter.active) {
                        const af = state.advancedFilter;
                        if (af.attendant.enabled && af.attendant.id) {
                            const att = state.attendants.find(a => a.id === af.attendant.id);
                            if (att) {
                                const attName = att.name.toLowerCase();
                                const hasAtt = [i.anciao_1, i.anciao_2, i.anciao_3, i.diacono_1, i.diacono_2, i.diacono_3, i.com_1, i.com_2, i.cjm].some(name => name && name.toLowerCase() === attName);
                                if (!hasAtt) match = false;
                            }
                        }
                        if (match && af.adm.enabled && af.adm.value && i.adm !== af.adm.value) match = false;
                        if (match && af.setor.enabled && af.setor.value && i.setor !== af.setor.value) match = false;
                        if (match && af.cidade.enabled && af.cidade.value && i.cidade !== af.cidade.value) match = false;
                        if (match && af.location.enabled && af.location.id && i.id !== af.location.id) match = false;
                    }
                }
                else if (coll === 'attendants') match = (i.name || '').toLowerCase().includes(term) || (i.ministerio || '').toLowerCase().includes(term) || (i.comum || '').toLowerCase().includes(term);
                else if (coll === 'feriados') match = (i.nome_feriado || '').toLowerCase().includes(term) || (i.tipo_feriado || '').toLowerCase().includes(term) || (i.data || '').toLowerCase().includes(term);
                else if (coll === 'perfis') match = (i.nome || '').toLowerCase().includes(term) || (i.permissao || '').toLowerCase().includes(term);
                return match;
            });

            if (coll === 'locations') {
                stats.innerHTML = `
                    <div class="flex justify-between items-start w-full gap-2 min-h-[18px] mb-1 overflow-visible">
                        <div id="manager-filter-label" class="font-bold text-navy uppercase flex-1 min-w-0 leading-tight whitespace-normal break-words overflow-visible transition-all duration-200" style="font-size: 13px;">
                            ${getFilterDescription('locations')}
                        </div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest pt-0.5 shrink-0">${filtered.length} REGISTROS</span>
                    </div>
                `;
                const labelEl = document.getElementById('manager-filter-label');
                if (labelEl) {
                    let currentSize = 13;
                    labelEl.style.fontSize = currentSize + 'px';
                    while (labelEl.scrollHeight > 34 && currentSize > 9) {
                        currentSize -= 0.2;
                        labelEl.style.fontSize = currentSize + 'px';
                    }
                }
            } else {
                stats.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${filtered.length} REGISTROS</span>`;
            }
            container.innerHTML = filtered.length === 0 ? '<div class="p-12 text-center text-slate-300 italic text-sm">Nenhum registro encontrado.</div>' : filtered.map((item) => {
                let badgesHtml = "";
                const mainName = (coll === 'locations' ? item.localidade : (coll === 'feriados' ? item.nome_feriado : (coll === 'perfis' ? item.nome : item.name))) || '';
                if (coll === 'locations') {
                    const line2 = [item.adm, item.setor, item.cidade].filter(Boolean).join(' | ');
                    const anciaes = [item.anciao_1, item.anciao_2, item.anciao_3].filter(Boolean).join(' - ');
                    const diaconos = [item.diacono_1, item.diacono_2, item.diacono_3].filter(Boolean).join(' - ');
                    const cooperadores = [item.com_1, item.com_2].filter(Boolean).join(' - ');
                    badgesHtml = `
                        <div class="text-[11px] text-slate-600 font-medium leading-tight mt-1">${line2}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-1">ANC: ${anciaes || '---'}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">DCN: ${diaconos || '---'}</div>
                        <div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">COM: ${cooperadores || '---'}</div>
                        ${item.cjm ? `<div class="text-[11px] text-slate-500 font-semibold leading-tight mt-0.5">CJE: ${item.cjm}</div>` : ''}
                    `;
                } else if (coll === 'types') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.sigla || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3">${item.quem_atende || ''}</div>`;
                } else if (coll === 'attendants') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.ministerio || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3">${item.comum || ''}</div>`;
                } else if (coll === 'feriados') {
                    badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.tipo_feriado || ''}</div><div class="text-[11px] text-slate-400 font-semibold leading-tight mt-0.5 h-3">${formatDateFull(item.data) || ''}</div>`;
                } else if (coll === 'perfis') {
                    const isAuth = item.autorizado === true;
                    const role = item.permissao === 'admin' ? 'Administrador' : 'Leitura';
                    badgesHtml = `<div class="text-[11px] font-bold leading-tight mt-1 ${isAuth ? 'text-green-600' : 'text-orange-500'}">${isAuth ? 'AUTORIZADO' : 'PENDENTE'}</div><div class="text-[10px] text-slate-400 font-semibold uppercase tracking-tighter mt-0.5">${role}</div>`;
                }
                const isHighlighted = state.highlightedItemId === item.id;
                const isTemp = String(item.id).startsWith('temp_');
                const safeMainName = (mainName || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");

                return `
                    <div id="item-${item.id}" class="p-4 flex items-center justify-between hover:bg-slate-50 transition-all ${isHighlighted ? 'bg-yellow-50 highlight-item ring-2 ring-yellow-400 ring-inset' : ''}">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center shrink-0 border border-blue-100 relative">
                                <i data-lucide="${itemIcon}" class="w-5 h-5 text-navy"></i>
                                ${isTemp ? `<div class="absolute -top-1 -right-1 bg-orange-500 text-white rounded-full p-0.5"><i data-lucide="cloud-off" class="w-2 h-2"></i></div>` : ''}
                            </div>
                            <div class="min-w-0 flex flex-col justify-center">
                                <div class="font-bold text-navy text-sm leading-tight flex items-center gap-2">
                                    ${mainName}
                                </div>
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="flex gap-1 ml-4 shrink-0">
                            ${state.isAdmin ? `
                                <button onclick="window.openRowModal('${coll}', '${item.id}')" class="p-2.5 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="window.requestDeleteRow('${item.id}', '${coll}', '${safeMainName}')" class="p-2.5 text-red-400 hover:bg-red-100 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            ` : ''}
                        </div>
                    </div>`;
            }).join('');
            renderIcons();
            if (state.highlightedItemId) {
                setTimeout(() => { const el = document.getElementById(`item-${state.highlightedItemId}`); if (el) el.scrollIntoView({ behavior: 'auto', block: 'center' }); }, 100);
            }
        };

        function renderHome() {
            const app = document.getElementById('app');
            if (!app) return;

            if (!state.user) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <div class="w-7 h-7"></div>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-blue-50 text-navy rounded-3xl flex items-center justify-center border border-blue-100 shadow-sm"><i data-lucide="lock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Acesso Restrito</h2>
                                <p class="text-sm text-slate-500 mt-2">Fa√ßa login para visualizar a agenda de eventos.</p>
                            </div>
                            <button onclick="window.showLoginModal()" class="bg-navy text-white px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Fazer Login</button>
                        </div>
                    </div>
                <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            if (!state.isAuthorized) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <button onclick="window.handleLogout()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-orange-50 text-orange-custom rounded-3xl flex items-center justify-center border border-orange-100 shadow-sm animate-pulse"><i data-lucide="clock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Aguardando Autoriza√ß√£o</h2>
                                <p class="text-sm text-slate-500 mt-2">Seu cadastro foi realizado com sucesso. Aguarde at√© que um administrador aprove seu acesso.</p>
                            </div>
                            <div class="p-4 bg-white border border-slate-200 rounded-2xl w-full max-w-xs shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Status Atual</span>
                                <span class="text-xs font-bold text-orange-500 uppercase">Pendente</span>
                            </div>
                            <button onclick="window.handleLogout()" class="mt-8 px-8 py-3 bg-red-600 text-white rounded-xl text-xs font-black uppercase tracking-widest flex items-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="log-out" class="w-4 h-4 text-white"></i> Logout</button>
                        </div>
                    </div>
                <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            app.innerHTML = `
                <div id="home-container" class="flex flex-col h-full bg-slate-100 relative">
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                    <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                        <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        <div class="flex flex-col items-center">
                            <h1 class="text-lg font-bold uppercase tracking-wide leading-none">Agenda CCB</h1>
                            ${state.masterEventFilter !== 'todos' ? `<span class="text-[9px] font-bold uppercase tracking-widest text-slate-300 mt-0.5">vendo eventos ${state.masterEventFilter}</span>` : ''}
                        </div>
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="flex gap-2">
                            <button onclick="window.startOpenAgenda()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> AGENDA</button>
                            <button onclick="window.resetAllFilters()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="list" class="w-3.5 h-3.5"></i> TODOS</button>
                            <button onclick="window.openFastFilterModal()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="filter" class="w-3.5 h-3.5"></i> FILTRO</button>
                            <button onclick="window.openReportPreview()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> RELAT√ìRIO</button>
                        </div>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input id="homeSearch" type="text" placeholder="Pesquisar evento, local ou atendente..." class="w-full pl-10 pr-3 h-10 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-navy/10" value="${state.searchTerm || ''}">
                                <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            </div>
                            <button onclick="window.renderAdvancedFilterModal()" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-navy shadow-sm active:bg-slate-50 relative">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                                ${state.advancedFilter.active ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-orange-custom rounded-full border-2 border-white"></span>' : ''}
                            </button>
                        </div>
                        <div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div>
                    </div>
                    ${state.isAdmin ? `<button onclick="window.startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center z-50 border-2 border-white/20"><i data-lucide="plus" class="w-8 h-8"></i></button>` : ''}
                </div >
                `;

            document.getElementById('homeSearch')?.addEventListener('input', (e) => { state.searchTerm = e.target.value; });
            window.updateHomeList();
        }

        function getFilteredEvents() {
            if (!state.isAuthorized) return [];
            let filtered = [...(state.events || [])];

            // FILTRO MESTRE: Primeiro crit√©rio de filtragem
            if (state.masterEventFilter !== 'todos') {
                filtered = filtered.filter((e) => {
                    const isPast = isEventPast(e.date, e.time);
                    return state.masterEventFilter === 'ativos' ? !isPast : isPast;
                });
            }

            if (state.selectedDate) {
                filtered = filtered.filter((e) => e.date === state.selectedDate);
            } else if (state.fastFilter?.active) {
                if (state.fastFilter.dateStart) filtered = filtered.filter((e) => e.date >= state.fastFilter.dateStart);
                if (state.fastFilter.dateEnd) filtered = filtered.filter((e) => e.date <= state.fastFilter.dateEnd);
            }

            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                if (af.eventos.enabled) {
                    filtered = filtered.filter((e) => {
                        const isPast = isEventPast(e.date, e.time);
                        return af.eventos.status === 'ativos' ? !isPast : isPast;
                    });
                }
                if (af.type.enabled && af.type.id) {
                    filtered = filtered.filter((e) => e.type_id === af.type.id);
                }
                if (af.attendant.enabled && af.attendant.id) {
                    filtered = filtered.filter((e) => e.attendant_id === af.attendant.id || e.attendant2_id === af.attendant.id);
                }
                if (af.adm.enabled && af.adm.value) {
                    const validLocs = state.locations.filter((l) => l.adm === af.adm.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.setor.enabled && af.setor.value) {
                    const validLocs = state.locations.filter((l) => l.setor === af.setor.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.cidade.enabled && af.cidade.value) {
                    const validLocs = state.locations.filter((l) => l.cidade === af.cidade.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.location.enabled && af.location.id) {
                    filtered = filtered.filter((e) => e.location_id === af.location.id);
                }
                if (af.period.enabled) {
                    if (af.period.start) filtered = filtered.filter((e) => e.date >= af.period.start);
                    if (af.period.end) filtered = filtered.filter((e) => e.date <= af.period.end);
                }
            }

            if (state.searchTerm) {
                const term = (state.searchTerm || '').toLowerCase();
                filtered = filtered.filter((e) => {
                    const typeObj = state.types.find((t) => t.id === e.type_id);
                    const typeName = (typeObj?.name || '').toLowerCase();
                    const typeSigla = (typeObj?.sigla || '').toLowerCase();
                    const locObj = state.locations.find((l) => l.id === e.location_id);
                    const loc = (locObj?.localidade || '').toLowerCase();
                    const termAtt = state.attendants.find((a) => a.id === e.attendant_id)?.name?.toLowerCase() || '';
                    const termAtt2 = state.attendants.find((a) => a.id === e.attendant2_id)?.name?.toLowerCase() || '';
                    return typeName.includes(term) || typeSigla.includes(term) || loc.includes(term) || termAtt.includes(term) || termAtt2.includes(term);
                });
            }

            return filtered.sort((a, b) => (a.date || '').localeCompare(b.date || '') || (a.time || '').localeCompare(b.time || ''));
        }

        function getFilterDescription(context = 'home') {
            if (context === 'home') {
                if (state.selectedDate) return `Agenda: ${formatDateFull(state.selectedDate)}`;
                if (state.fastFilter?.active) return state.fastFilter.label || 'Filtro Ativo';
            }

            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                const parts = [];
                if (context === 'home' && af.eventos.enabled) parts.push(af.eventos.status === 'ativos' ? 'Ativos' : 'Inativos');
                if (af.type.enabled && af.type.id) {
                    const type = state.types.find((t) => t.id === af.type.id);
                    if (type) parts.push(type.name);
                }
                if (af.attendant.enabled && af.attendant.id) {
                    const att = state.attendants.find((a) => a.id === af.attendant.id);
                    if (att) parts.push(context === 'locations' ? `Atendente: ${att.name}` : att.name);
                }
                const locChain = [];
                if (af.adm.enabled && af.adm.value) locChain.push(af.adm.value);
                if (af.setor.enabled && af.setor.value) {
                    const cleanSetor = af.setor.value.replace(/setor\s+/gi, '');
                    locChain.push(`Setor ${cleanSetor}`);
                }
                if (af.cidade.enabled && af.cidade.value) locChain.push(af.cidade.value);
                if (af.location.enabled && af.location.id) {
                    const loc = state.locations.find((l) => l.id === af.location.id);
                    if (loc) locChain.push(loc.localidade);
                }
                if (locChain.length > 0) parts.push(locChain.join(' > '));
                if (context === 'home' && af.period.enabled && af.period.start && af.period.end) {
                    parts.push(`${formatDate(af.period.start)} a ${formatDate(af.period.end)}`);
                }
                return parts.length > 0 ? parts.join(' | ') : (context === 'locations' ? 'Todas as Localidades' : 'Todos os Eventos');
            }

            if (context === 'home' && state.searchTerm) return `Busca: ${state.searchTerm}`;
            return context === 'locations' ? 'Todas as Localidades' : 'Todos os Eventos';
        }

        function renderNavMenu() {
            if (!state.isMenuOpen) return '';

            const baseItems = [];


            if (state.isAuthorized) {
                baseItems.push(
                    { id: 'types', icon: 'tag', label: 'Tipos de Evento' },
                    { id: 'locations', icon: 'map-pin', label: 'Localidades' },
                    { id: 'attendants', icon: 'users', label: 'Atendentes' },
                    { id: 'feriados', icon: 'sun', label: 'Feriados' }
                );
            }

            const adminItems = (state.isAdmin && state.isAuthorized) ? [
                { id: 'users', icon: 'shield-check', label: 'Gest√£o de Usu√°rios' }
            ] : [];

            const footerItems = [
                { id: 'options', icon: 'settings', label: 'Op√ß√µes' },
                { id: 'about', icon: 'info', label: 'Sobre' }
            ];

            const menuItems = [...baseItems, ...adminItems, ...footerItems];

            const userName = state.user?.user_metadata?.full_name || state.user?.email || 'Usu√°rio';

            return `
                <div class="fixed inset-0 z-50 flex">
                    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeMenu()"></div>
                    <div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl">
                        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#002855]">
                            <h2 class="text-xl font-bold tracking-tight">Menu</h2>
                            <button onclick="window.closeMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="x"></i></button>
                        </div>
                        <nav class="flex-1 py-4 flex flex-col gap-1 overflow-y-auto scrollbar-none">
                            ${menuItems.map(item => `
                                <button onclick="window.navigateTo('${item.id}')" class="w-full flex items-center px-6 py-4 hover:bg-white/10 gap-4 border-l-4 border-transparent hover:border-orange-custom transition-all">
                                    <i data-lucide="${item.icon}" class="text-orange-custom w-5 h-5"></i>
                                    <span class="font-medium">${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        <div class="p-4 border-t border-white/10 bg-[#002244]">
                            ${state.user ? `
                                <div class="mb-4 px-2">
                                    ${state.isAdmin ? `<div class="text-[9px] font-black text-orange-custom uppercase tracking-widest mb-0.5">Administrador</div>` : ''}
                                    <div class="text-sm font-bold text-white truncate max-w-full">${userName}</div>
                                </div>
                                <button onclick="window.handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600/20 text-red-200 rounded-lg font-bold border border-red-500/30 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</button>
                            ` : `
                                <button onclick="window.showLoginModal()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg font-bold hover:bg-white/20 border border-white/10"><i data-lucide="lock" class="w-4 h-4"></i> Login </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEventForm() {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const isEditing = !!state.editingEventId;
            const app = document.getElementById('app');
            if (!app) return;
            const selectedType = state.types.find((t) => t.id === state.formTempType);
            const typeName = (selectedType?.name || '').toLowerCase();
            const showCounters = typeName.includes('batismo') || typeName.includes('santa ceia');
            const errs = state.formErrors || [];

            // Dirty Check Logic
            let hasChanges = false;
            if (isEditing && state.originalEventSnapshot) {
                const snap = state.originalEventSnapshot;
                const currentIrmaos = parseInt(state.formTempIrmaos || '0');
                const currentIrmas = parseInt(state.formTempIrmas || '0');

                if (state.formTempDate !== snap.date) hasChanges = true;
                if (state.formTempTime !== snap.time) hasChanges = true;
                if (String(state.formTempLoc) !== String(snap.location_id)) hasChanges = true;
                if (String(state.formTempType) !== String(snap.type_id)) hasChanges = true;
                if (String(state.formTempAtt || '') !== String(snap.attendant_id || '')) hasChanges = true;
                if (String(state.formTempAtt2 || '') !== String(snap.attendant2_id || '')) hasChanges = true;
                if (currentIrmaos !== (snap.irmaos || 0)) hasChanges = true;
                if (currentIrmas !== (snap.irmas || 0)) hasChanges = true;
            } else if (!isEditing) {
                hasChanges = true; // New event always has "changes" to save
            }

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide text-sm">${isEditing ? 'Editar' : 'Novo'} Evento</h1>
                    </div>
                    <div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="bg-white p-5 rounded-xl shadow-md flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Data</label>
                                    <button onclick="window.openFormDate()" class="flex items-center gap-2 border ${errs.includes('date') ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                        <i data-lucide="calendar" class="w-4 h-4 opacity-50"></i>
                                        ${state.formTempDate ? formatDate(state.formTempDate) : 'Selecionar'}
                                    </button>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Hora</label>
                                    <button onclick="window.openTimePickerModal()" class="flex items-center gap-2 border border-slate-200 p-3 rounded-lg text-left text-sm bg-slate-50 font-medium text-navy transition-colors">
                                        <i data-lucide="clock" class="w-4 h-4 opacity-50"></i>
                                        ${state.formTempTime}
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Localidade</label>
                                <button onclick="window.openSelectPicker('locations', 'Local', 'formTempLoc')" class="flex items-center gap-2 border ${errs.includes('loc') ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                    <i data-lucide="map-pin" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.locations.find((l) => l.id === state.formTempLoc)?.localidade || 'Selecionar Localidade'}</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Evento</label>
                                <button onclick="window.openSelectPicker('types', 'Tipo', 'formTempType')" class="flex items-center gap-2 border ${errs.includes('type') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                    <i data-lucide="tag" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.types.find((t) => t.id === state.formTempType)?.name || 'Selecionar Tipo'}</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Atendente <span class="text-slate-300 font-bold normal-case">(opcional)</span></label>
                                <button onclick="window.openSelectPicker('attendants', 'Atendente', 'formTempAtt')" class="flex items-center gap-2 border border-slate-200 p-3 rounded-lg text-left text-sm bg-slate-50 font-medium text-navy transition-colors">
                                    <i data-lucide="users" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.attendants.find((a) => a.id === state.formTempAtt)?.name || 'Selecionar Atendente'}</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Atendente 2 <span class="text-slate-300 font-bold normal-case">(opcional)</span></label>
                                <button onclick="window.openSelectPicker('attendants', 'Atendente 2', 'formTempAtt2')" class="flex items-center gap-2 border border-slate-200 p-3 rounded-lg text-left text-sm bg-slate-50 font-medium text-navy transition-colors">
                                    <i data-lucide="users" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.attendants.find((a) => a.id === state.formTempAtt2)?.name || 'Selecionar Atendente 2'}</span>
                                </button>
                            </div>
                            <div class="${showCounters ? '' : 'hidden'} grid grid-cols-2 gap-3 transition-all duration-300">
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Irm√£os</label>
                                    <input id="event-irmaos" type="number" oninput="window.state.formTempIrmaos = this.value" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${state.formTempIrmaos || ''}" placeholder="0">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Irm√£s</label>
                                    <input id="event-irmas" type="number" oninput="window.state.formTempIrmas = this.value" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${state.formTempIrmas || ''}" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="flex flex-col gap-2 mt-2">
                                ${isEditing ? `
                                    ${hasChanges ? `
                                        <button onclick="window.saveEvent()" class="bg-navy text-white p-4 rounded-xl font-black shadow-lg active:scale-[0.98] transition-transform uppercase text-xs tracking-widest">SALVAR ALTERA√á√ïES ${!navigator.onLine ? '(OFFLINE)' : ''}</button>
                                    ` : `
                                        <button onclick="window.navigateTo('home')" class="bg-slate-100 text-slate-500 p-4 rounded-xl font-black shadow-sm active:scale-[0.98] transition-transform uppercase text-xs tracking-widest border border-slate-200">CANCELAR E VOLTAR</button>
                                    `}
                                    <button onclick="window.requestDeleteEvent('${state.editingEventId}')" class="text-red-600 p-3 text-xs font-bold border border-red-100 rounded-lg bg-red-50/30 flex items-center justify-center gap-2 active:bg-red-100 transition-colors uppercase tracking-widest"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir Evento</button>
                                ` : `
                                    <button onclick="window.saveEvent()" class="bg-navy text-white p-4 rounded-xl font-black shadow-lg active:scale-[0.98] transition-transform uppercase text-xs tracking-widest">SALVAR EVENTO ${!navigator.onLine ? '(OFFLINE)' : ''}</button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderGenericManager(title, collection) {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const app = document.getElementById('app');
            if (!app) return;

            let searchPlaceholder = "Buscar...";
            if (collection === 'locations') searchPlaceholder = "Pesq. por adm, setor, cidade, localidade";
            else if (collection === 'types') searchPlaceholder = "Pesquisar por nome ou sigla...";
            else if (collection === 'attendants') searchPlaceholder = "Pesquisar por nome ou minist√©rio...";
            else if (collection === 'feriados') searchPlaceholder = "Pesquisar por nome ou tipo...";
            else if (collection === 'perfis') searchPlaceholder = "Pesquisar por nome ou permiss√£o...";

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm">${title}</h1>
                        </div>
                        <button onclick="window.navigateTo('home')" class="p-2 hover:bg-white/10 rounded"><i data-lucide="home" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4 flex flex-col gap-4 flex-1 overflow-hidden max-w-xl mx-auto w-full">
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input id="managerSearch" type="text" placeholder="${searchPlaceholder}" class="w-full pl-10 pr-4 py-2.5 border-2 border-blue-200 rounded-xl text-sm font-medium shadow-sm transition-all focus:border-blue-500 bg-white" value="${state.managerSearchTerm || ''}">
                                <i data-lucide="search" class="absolute left-3.5 top-3.5 text-blue-300 w-4 h-4"></i>
                            </div>
                            ${collection === 'locations' ? `
                                <button onclick="window.renderAdvancedFilterModal()" class="w-11 h-11 bg-white border border-slate-300 rounded-xl flex items-center justify-center text-navy shadow-sm active:bg-slate-50 relative shrink-0">
                                    <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                                    ${state.advancedFilter.active ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-orange-custom rounded-full border-2 border-white"></span>' : ''}
                                </button>
                                <button onclick="window.openLocationsReportPreview()" class="flex items-center justify-center gap-2 h-11 bg-navy text-white text-[10px] font-bold rounded-xl shadow-sm uppercase px-4 active:scale-95 transition-all shrink-0">
                                    <i data-lucide="file-text" class="w-4 h-4"></i> 
                                </button>
                            ` : ''}
                        </div>
                        <div id="manager-list-stats" class="flex justify-end pr-1 -mt-2"></div>
                        <div id="manager-items-container" class="flex-1 overflow-y-auto mb-1 bg-white rounded-2xl border border-slate-200 shadow-sm divide-y divide-slate-100 scrollbar-none"></div>
                        ${(state.isAdmin && collection !== 'perfis') ? `
                            <div class="flex justify-center pb-2">
                                <button onclick="window.openRowModal('${collection}')" class="bg-navy text-white px-8 py-2.5 rounded-xl font-black shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all border-2 border-white/10 w-full text-xs uppercase tracking-widest">
                                    <i data-lucide="${!navigator.onLine ? 'cloud-off' : 'plus'}" class="w-4 h-4"></i> ADICIONAR ${!navigator.onLine ? 'OFFLINE' : ''}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('managerSearch')?.addEventListener('input', (e) => {
                state.managerSearchTerm = e.target.value;
                state.highlightedItemId = null;
                window.updateManagerListUI(collection);
            });
            window.updateManagerListUI(collection);
        }

        function renderAbout() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100 font-sans">
                    <!-- Header -->
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10 shrink-0">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full transition-colors"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm">SOBRE O APP</h1>
                        </div>
                        <button onclick="window.navigateTo('home')" class="p-2 hover:bg-white/10 rounded-xl transition-all"><i data-lucide="home" class="w-6 h-6"></i></button>
                    </div>

                    <div class="flex-1 overflow-y-auto scrollbar-none p-5 flex flex-col gap-4 animate-fade-in-up max-w-xl mx-auto w-full">
                        
                        <!-- Top Card: Identity -->
                        <div class="bg-white rounded-3xl p-8 flex flex-col items-center justify-center text-center shadow-sm">
                            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-4">
                                <i data-lucide="calendar-check-2" class="w-8 h-8 text-navy"></i>
                            </div>
                            <h2 class="text-xl font-black text-navy mb-1 tracking-tight">Agenda CCB</h2>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">AGENDA DE EVENTOS</p>
                        </div>

                        <!-- Middle Card: Functionalities -->
                        <div class="bg-white rounded-3xl p-6 shadow-sm flex flex-col gap-4">
                            <div class="flex items-center gap-2 mb-1">
                                <i data-lucide="zap" class="w-5 h-5 text-orange-400 fill-orange-400"></i>
                                <h3 class="text-xs font-black text-navy uppercase tracking-widest">FUNCIONALIDADES</h3>
                            </div>
                            
                            <div class="flex flex-col gap-3">
                                <div class="flex items-start gap-3">
                                    <i data-lucide="check" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></i>
                                    <span class="text-sm font-medium text-slate-600 leading-tight">Gest√£o de eventos, localidades e atendentes.</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i data-lucide="calendar" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></i>
                                    <span class="text-sm font-medium text-slate-600 leading-tight">Agenda anual, mensal e di√°ria interativa.</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i data-lucide="filter" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></i>
                                    <span class="text-sm font-medium text-slate-600 leading-tight">Filtros simples, avan√ßados e buscas precisas.</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i data-lucide="file-text" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></i>
                                    <span class="text-sm font-medium text-slate-600 leading-tight">Relat√≥rios em PDF e PNG de alta nitidez.</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i data-lucide="shield-check" class="w-4 h-4 text-green-500 shrink-0 mt-0.5"></i>
                                    <span class="text-sm font-medium text-slate-600 leading-tight">Gest√£o de usu√°rios e premiss√µes.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Card: Credits -->
                        <div class="bg-blue-50 rounded-3xl p-6 shadow-sm flex flex-col items-center justify-center text-center mt-auto">
                            <span class="text-xs text-slate-500 font-medium mb-1">Desenvolvido por:</span>
                            <strong class="text-[14px] font-black text-navy mb-1">Marcos de Lima</strong>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">VERS√ÉO 2.4.0</span>
                        </div>

                        <div class="h-4"></div> <!-- Spacer -->
                    </div>
                </div>
                <style>
                    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                    .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
                </style>
            `;
            renderIcons();
        }

        function renderOptions() {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const app = document.getElementById('app');
            if (!app) return;

            const filter = state.masterEventFilter;

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm">Op√ß√µes</h1>
                        </div>
                        <button onclick="window.navigateTo('home')" class="p-2 hover:bg-white/10 rounded"><i data-lucide="home" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4 flex flex-col gap-6 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Mostrar Eventos</h2>
                            <div class="flex flex-col gap-2">
                                <button onclick="window.setMasterFilter('ativos')" class="flex items-center justify-between p-[11px] rounded-xl border-2 transition-all ${filter === 'ativos' ? 'border-orange-custom bg-orange-50' : 'border-slate-100 bg-slate-50'}">
                                    <span class="font-bold text-navy text-[11px]">ATIVOS</span>
                                    ${filter === 'ativos' ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                                </button>
                                <button onclick="window.setMasterFilter('inativos')" class="flex items-center justify-between p-[11px] rounded-xl border-2 transition-all ${filter === 'inativos' ? 'border-orange-custom bg-orange-50' : 'border-slate-100 bg-slate-50'}">
                                    <span class="font-bold text-navy text-[11px]">INATIVOS</span>
                                    ${filter === 'inativos' ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                                </button>
                                <button onclick="window.setMasterFilter('todos')" class="flex items-center justify-between p-[11px] rounded-xl border-2 transition-all ${filter === 'todos' ? 'border-orange-custom bg-orange-50' : 'border-slate-100 bg-slate-50'}">
                                    <span class="font-bold text-navy text-[11px]">TODOS</span>
                                    ${filter === 'todos' ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderIcons();
        }

        window.setMasterFilter = (val) => {
            state.masterEventFilter = val;
            localStorage.setItem('masterEventFilter', val);
            renderOptions();
        };

        function renderCalendar(mode) {
            const viewDate = new Date(state.viewDate);
            const month = viewDate.getMonth();
            const year = viewDate.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            loadExternalHolidays(year);
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);
            const fmt = (d) => `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            let currentSelected = '';
            if (mode === 'filter') currentSelected = state.selectedDate || '';
            else if (mode === 'picker') currentSelected = state.formTempDate || '';
            else if (mode === 'adv_start') currentSelected = state.advancedFilter.period.start || '';
            else if (mode === 'adv_end') currentSelected = state.advancedFilter.period.end || '';
            else if (mode === 'feriado_picker') currentSelected = document.getElementById('feriado-date-val')?.value || '';

            let calendarEvents = state.events;
            if (state.masterEventFilter !== 'todos') {
                calendarEvents = calendarEvents.filter(e => {
                    const isPast = isEventPast(e.date, e.time);
                    return state.masterEventFilter === 'ativos' ? !isPast : isPast;
                });
            }

            const eventDots = {};
            calendarEvents.forEach((e) => {
                const datePart = e.date.substring(0, 7);
                if (datePart === `${year}-${String(month + 1).padStart(2, '0')}`) eventDots[e.date] = (eventDots[e.date] || 0) + 1;
            });

            const monthHolidays = [...state.externalHolidays.filter((h) => {
                const d = new Date(h.date + 'T00:00:00');
                return d.getMonth() === month && d.getFullYear() === year;
            }), ...state.feriados.filter((f) => {
                const d = new Date(f.data + 'T00:00:00');
                return d.getMonth() === month && d.getFullYear() === year;
            })].sort((a, b) => (a.date || a.data).localeCompare(b.date || b.data));

            const holidayLegendItems = monthHolidays.map(h => {
                const dateStr = h.date || h.data;
                const day = parseInt(dateStr.split('-')[2]);
                return `<span class="whitespace-nowrap"><span class="font-bold text-red-500">${day}</span> - ${h.name || h.nome_feriado}</span>`;
            }).join(' <span class="text-slate-300 mx-2">|</span> ');

            let title = mode === 'filter' ? 'Agenda' : 'Selecionar Data';
            if (mode === 'adv_start') title = 'Data de In√≠cio';
            if (mode === 'adv_end') title = 'Data do Fim';

            let contentHtml = `<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col max-h-[95vh]"><div class="p-3 flex justify-between items-center border-b border-slate-50 bg-white shrink-0"><div class="flex items-center gap-2 text-navy"><i data-lucide="calendar" class="w-4 h-4"></i><h3 class="text-base font-black tracking-tight uppercase">${title}</h3></div><button onclick="${(mode === 'adv_start' || mode === 'adv_end') ? 'window.renderAdvancedFilterModal()' : mode === 'feriado_picker' ? 'window.returnToFeriadoModal()' : 'window.closeModal()'}" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-3 overflow-y-auto scrollbar-none"><div class="flex justify-between items-center mb-3 px-1"><button onclick="window.changeMonth(-1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex gap-2 font-black text-[14px] uppercase tracking-widest text-navy"><button onclick="window.openMonthPicker('${mode}')" class="hover:text-orange-custom">${monthNames[month]}</button><button onclick="window.openYearPicker('${mode}')" class="hover:text-orange-custom">${year}</button></div><button onclick="window.changeMonth(1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 text-center text-[11px] font-black uppercase tracking-widest text-slate-400 mb-2"><span class="text-red-500">D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span></div><div class="grid grid-cols-7 gap-y-1.5 text-center items-center justify-items-center">${days.map(d => { if (!d) return '<div></div>'; const fullDate = fmt(d); const isToday = fullDate === new Date().toISOString().split('T')[0]; const isHoliday = state.externalHolidays.some((h) => h.date === fullDate) || state.feriados.some((f) => f.data === fullDate); return `<div class="flex flex-col items-center gap-0.5"><button onclick="window.selectCalendarDate('${fullDate}', '${mode}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-xs font-bold transition-all relative ${fullDate === currentSelected ? 'bg-navy text-white shadow-md' : isToday ? 'text-green-600 border border-green-100' : (new Date(year, month, d).getDay() === 0 || isHoliday) ? 'text-red-500' : 'text-slate-600 hover:bg-slate-50'}">${d}</button><div class="flex gap-0.5 h-1.5 items-center justify-center">${(eventDots[fullDate] || 0) > 0 ? Array(Math.min(eventDots[fullDate], 4)).fill(0).map(() => `<span class="w-1 h-1 rounded-full ${fullDate === currentSelected ? 'bg-orange-custom' : 'bg-navy'}"></span>`).join('') : ''}</div></div>`; }).join('')}</div></div>${holidayLegendItems ? `<div class="px-4 py-2 border-t border-slate-50 bg-slate-50/40 shrink-0"><div class="flex flex-wrap gap-y-1 text-[11px] items-center">${holidayLegendItems}</div></div>` : ''}`;

            if (mode === 'filter' && state.selectedDate) {
                const dayEvents = calendarEvents.filter((e) => e.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
                contentHtml += `<div class="flex flex-col border-t border-slate-100 shrink-0"><div class="px-4 py-1.5 flex justify-between items-center bg-slate-50/50"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">EVENTOS: ${formatDate(state.selectedDate)}</span></div><div class="flex flex-col divide-y divide-slate-100 max-h-[160px] overflow-y-auto scrollbar-none bg-white">${dayEvents.length === 0 ? '<div class="text-center text-slate-300 py-6 text-[10px] font-medium italic">Nenhum evento programado</div>' : dayEvents.map((e) => {
                    const loc = state.locations.find((l) => l.id === e.location_id)?.localidade || '';
                    const att = state.attendants.find((a) => a.id === e.attendant_id)?.name || '';
                    return `<div class="p-2.5 flex flex-col gap-0.5 active:bg-slate-50 transition-colors relative group"><div class="flex items-center gap-2"><span class="text-[11px] font-black text-navy shrink-0">${e.time}</span><span class="text-[11px] font-bold text-slate-800 leading-tight">${state.types.find((t) => t.id === e.type_id)?.name || 'Evento'}</span></div><div class="flex items-center gap-3 pr-10"><div class="text-[9px] text-slate-400 font-medium flex items-center gap-1"><i data-lucide="map-pin" class="w-2 h-2 shrink-0"></i> <span>${loc} ${att ? '| ' + att : ''}</span></div></div><div class="absolute bottom-2 right-3 bg-navy text-white text-[7px] font-black px-1 py-0.5 rounded uppercase tracking-tighter shrink-0 shadow-sm">${state.types.find((t) => t.id === e.type_id)?.sigla || 'EVT'}</div></div>`;
                }).join('')}</div><div class="p-3 bg-white border-t border-slate-50"><button onclick="window.applyCalendarAndClose()" class="w-full bg-navy text-white py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg shadow-navy/20 active:scale-95 transition-all"><i data-lucide="list" class="w-3.5 h-3.5"></i> Ver na Lista</button></div></div>`;
            }
            contentHtml += `</div>`;
            showModal(contentHtml);
        }

        function renderClockUI() {
            const isH = state.clockMode === 'hour';
            const values = isH ? ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'] : ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
            showModal(`<div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md overflow-hidden"><div class="flex justify-center items-center gap-4 mb-8"><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'hour'" class="text-4xl font-black ${isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempHour || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Hora</span></div><span class="text-4xl font-black text-slate-200 mb-5">:</span><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'minute'" class="text-4xl font-black ${!isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempMinute || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Min</span></div></div><div class="grid grid-cols-4 gap-3">${values.map(v => `<button onclick="window.selectClockValue('${v}')" class="aspect-square flex items-center justify-center rounded-2xl font-bold text-sm transition-all ${(isH ? state.clockTempHour === v : state.clockTempMinute === v) ? 'bg-navy text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}">${v}</button>`).join('')}</div><div class="flex gap-3 mt-8"><button onclick="window.closeModal()" class="flex-1 py-4 text-slate-400 font-bold text-xs uppercase tracking-widest">Cancelar</button><button onclick="window.confirmClockTime()" class="flex-2 bg-navy text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">OK</button></div></div>`);
        }

        function renderAdvancedFilterModal() {
            const af = state.advancedFilter;
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const errs = af.validationErrors || [];

            let selMonthLabel = 'M√™s';
            let selYearLabel = 'Ano';
            if (af.period.enabled && af.period.start) {
                const d = new Date(af.period.start + 'T00:00:00');
                const dEnd = new Date(af.period.end + 'T00:00:00');
                const isFullMonth = d.getDate() === 1 && dEnd.getDate() === new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate() && d.getMonth() === dEnd.getMonth();
                const isFullYear = d.getDate() === 1 && d.getMonth() === 0 && dEnd.getDate() === 31 && dEnd.getMonth() === 11;
                if (isFullYear) { selYearLabel = d.getFullYear().toString(); selMonthLabel = 'M√™s'; }
                else if (isFullMonth) { selMonthLabel = monthNames[d.getMonth()]; selYearLabel = d.getFullYear().toString(); }
            }

            state.searchTerm = '';
            const isMasterAtivos = state.masterEventFilter === 'ativos';
            const isMasterInativos = state.masterEventFilter === 'inativos';
            const isMasterTodos = state.masterEventFilter === 'todos';

            // Sync advanced filter status with master filter if not "todos"
            if (!isMasterTodos && af.eventos.enabled) {
                af.eventos.status = isMasterAtivos ? 'ativos' : 'passados';
            }

            const isLocations = state.currentScreen === 'locations';
            const title = isLocations ? 'Filtro de Localidades' : 'Filtros Avan√ßados';

            const sectionStatus = `<div id="adv-sec-eventos" class="flex flex-col gap-3"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('eventos')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status dos Eventos</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.eventos.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.eventos.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.eventos.enabled ? (isMasterTodos ? `<div class="flex bg-slate-100 p-1 rounded-xl"><button onclick="window.setAdvFilterStatus('ativos'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'ativos' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">ATIVOS</button><button onclick="window.setAdvFilterStatus('passados'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'passados' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">INATIVOS</button></div>` : `<div class="flex bg-slate-50 p-3 rounded-xl border border-slate-100 items-center justify-center gap-2"><i data-lucide="lock" class="w-3 h-3 text-slate-400"></i><span class="text-[10px] font-bold text-slate-500 uppercase">Travado em ${isMasterAtivos ? 'Ativos' : 'Inativos'} (Op√ß√µes)</span></div>`) : ''}</div>`;
            const sectionType = `<div id="adv-sec-type" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('type')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Tipo</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.type.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.type.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.type.enabled ? `<button onclick="window.openSelectPicker('types', 'Tipo', 'adv_type')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('type') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span class="truncate">${state.types.find((t) => t.id === af.type.id)?.name || 'Selecionar Tipo...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>`;
            const sectionAttendant = `<div id="adv-sec-attendant" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('attendant')"><label class="text-[10px] font-black text-slate-400 uppercase ml-1 block uppercase tracking-widest">Filtrar por Atendente</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.attendant.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.attendant.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.attendant.enabled ? `<button onclick="window.openSelectPicker('attendants', 'Atendente', 'adv_attendant')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('attendant') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.attendants.find((a) => a.id === af.attendant.id)?.name || 'Selecionar Atendente...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>`;
            const sectionAdm = `<div id="adv-sec-adm" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('adm')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por ADM</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.adm.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.adm.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.adm.enabled ? `<button onclick="window.openDistinctPicker('adm')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('adm') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors mb-2"><span>${af.adm.value || 'Selecionar ADM...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.adm.value ? `<div id="adv-sec-setor" class="flex flex-col gap-2 mt-2 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('setor')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Setor</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.setor.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.setor.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.setor.enabled ? `<button onclick="window.openDistinctPicker('setor')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('setor') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.setor.value || 'Selecionar Setor...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.setor.value ? `<div id="adv-sec-cidade" class="flex flex-col gap-2 mt-4 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('cidade')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Cidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.cidade.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.cidade.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.cidade.enabled ? `<button onclick="window.openDistinctPicker('cidade')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('cidade') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.cidade.value || 'Selecionar Cidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>` : ''}` : ''}</div>` : ''}` : ''}</div>`;
            const sectionLocation = `<div id="adv-sec-location" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('location')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Localidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.location.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.location.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.location.enabled ? `<button onclick="window.openSelectPicker('locations', 'Local', 'adv_location')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('location') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.locations.find((l) => l.id === af.location.id)?.localidade || 'Selecionar Localidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>`;
            const sectionPeriod = `<div id="adv-sec-period" class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('period')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Per√≠odo</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.period.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.period.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.period.enabled ? `<div class="flex flex-col gap-2"><div class="grid grid-cols-2 gap-2"><button onclick="window.openDateRangePicker('start')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.start ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">In√≠cio</span><span class="truncate">${af.period.start ? formatDate(af.period.start) : 'Data...'}</span></button><button onclick="window.openDateRangePicker('end')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.end ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">Fim</span><span class="truncate">${af.period.end ? formatDate(af.period.end) : 'Data...'}</span></button></div><div class="grid grid-cols-2 gap-2"><button onclick="state.viewDate = (state.advancedFilter.period.start ? new Date(state.advancedFilter.period.start + 'T00:00:00') : new Date()); window.openMonthPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selMonthLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button><button onclick="window.openYearPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selYearLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button></div></div>` : ''}</div>`;

            const sectionsHtml = isLocations
                ? `${sectionAttendant}${sectionAdm}${sectionLocation}`
                : `${sectionStatus}${sectionType}${sectionAdm}${sectionLocation}${sectionAttendant}${sectionPeriod}`;

            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-center gap-2 text-navy"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i><h3 class="text-lg font-black tracking-tight uppercase">${title}</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="adv-filter-scroll-container" class="p-6 flex flex-col gap-5 overflow-y-auto scrollbar-none">${sectionsHtml}</div><div class="p-6 border-t border-slate-50 flex gap-3"><button onclick="window.clearAdvancedFilters()" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpar Filtro</button><button onclick="window.applyAdvancedFilters()" class="flex-1 bg-navy text-white py-2.5 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg shadow-navy/20 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
        }

        function openDistinctPicker(f) {
            const af = state.advancedFilter; let locs = [...state.locations];
            if (af.attendant.enabled && af.attendant.id) {
                const att = state.attendants.find(a => a.id === af.attendant.id);
                if (att) {
                    const attName = att.name.toLowerCase();
                    locs = locs.filter(l => [l.anciao_1, l.anciao_2, l.anciao_3, l.diacono_1, l.diacono_2, l.diacono_3, l.com_1, l.com_2, l.cjm].some(name => name && name.toLowerCase() === attName));
                }
            }
            if (f === 'setor') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); }
            else if (f === 'cidade') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); if (af.setor.enabled && af.setor.value) locs = locs.filter(l => l.setor === af.setor.value); }
            const values = [...new Set(locs.map((l) => l[f]).filter((v) => v))].sort();
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${f.toUpperCase()}</h3></div><button onclick="window.renderAdvancedFilterModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="distinctItemsList" class="flex-1 overflow-y-auto px-2 pb-4 pt-2 scrollbar-none">${values.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum dado encontrado.</div>' : values.map(val => `<button onclick="window.handleAdvFilterSelect('${f}', '${val.replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="font-bold text-sm text-navy leading-tight">${val}</span>${af[f].value === val ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0"></i>' : ''}</button>`).join('')}</div></div>`);
            renderIcons();
        }

        function openRowModal(coll, id = '', initVals = {}) {
            if (!state.isAdmin) return;
            const safeId = (!id || id === 'undefined') ? '' : id;
            const isE = !!safeId;
            const item = (initVals && Object.keys(initVals).length > 0) ? initVals : (isE ? state[coll].find((i) => String(i.id) === String(safeId)) : {});
            const ctx = {
                types: { title: 'Tipo de Evento', name: 'Nome do Evento' },
                locations: { title: 'Cidade / Localidade', name: 'Nome da Localidade' },
                attendants: { title: 'Atendente', name: 'Nome Completo' },
                feriados: { title: 'Feriado', name: 'Nome do Feriado' },
                perfis: { title: 'Usu√°rio', name: 'Nome do Usu√°rio' }
            }[coll] || { title: 'Registro', name: 'Nome' };

            const mainV = (coll === 'locations' ? item.localidade : (coll === 'feriados' ? item.nome_feriado : (coll === 'perfis' ? item.nome : item.name))) || '';

            if (coll === 'feriados') window.__feriado_modal_cache = { safeId, item };

            if (coll === 'perfis') {
                showModal(`
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <h3 class="font-black text-navy text-xs uppercase tracking-widest">Gerenciar Usu√°rio</h3>
                            <button onclick="window.closeModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-6 flex flex-col gap-5">
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nome Completo</label>
                                <input type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-400 cursor-not-allowed" value="${mainV}" disabled>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-navy uppercase">Autorizado</span>
                                    <span class="text-[10px] text-slate-400 font-medium">Permitir acesso √† agenda</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="user-authorized" class="sr-only peer" ${item.autorizado ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-custom"></div>
                                </label>
                            </div>

                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">N√≠vel de Permiss√£o</label>
                                <button onclick="window.openPermissionPicker('${coll}', '${safeId}', '${item.permissao || 'leitura'}')" class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left">
                                    <span>${item.permissao === 'admin' ? 'Administrador' : 'Somente Leitura'}</span>
                                    <input type="hidden" id="user-permission" value="${item.permissao || 'leitura'}">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                </button>
                            </div>

                            <button onclick="window.saveRow('perfis', '${safeId}')" class="w-full bg-navy text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg mt-2 active:scale-95 transition-transform">SALVAR ALTERA√á√ïES</button>
                        </div>
                    </div>
                `);
                renderIcons();
                return;
            }

            const renderSel = (fieldId, label, requiredMinistry = '') => {
                const val = item[fieldId.replace('loc-', '').replace(/-/g, '_')] || '';
                return `
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">${label}</label>
                    <button onclick="window.openLocationStaffPicker('${coll}', '${safeId}', '${fieldId}', '${label.replace(/'/g, "\\'")}', '${requiredMinistry}')" 
                            class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left">
                        <span class="truncate">${val || 'Selecionar...'}</span>
                        <input type="hidden" id="${fieldId}" value="${val || ''}">
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 shrink-0"></i>
                    </button>
                </div>
            `;
            };



            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]"><div class="p-4 bg-slate-50 border-b flex justify-between items-center shrink-0"><h3 class="font-black text-navy text-xs uppercase tracking-widest">${isE ? 'Editar' : 'Novo'} ${ctx.title}</h3><button onclick="window.closeModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-4 overflow-y-auto scrollbar-none">
            ${coll === 'locations' ? `
                <div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">ADM</label><input id="loc-adm" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.adm || ''}" placeholder="Nome do ADM"></div>
                <div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Setor</label><input id="loc-setor" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.setor || ''}" placeholder="N√∫mero/Nome do Setor"></div>
                <div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Cidade</label><input id="loc-cidade" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.cidade || ''}" placeholder="Ex: Valente"></div>
                ${/* Moved Name Field here for Locations */ ''}
                <div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">${ctx.name}</label><input id="row-name" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy transition-colors" value="${mainV}" placeholder="Digite aqui..."></div>
                
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Eventos poss√≠veis</label>
                    <button onclick="window.openEventosPossiveisPicker('${safeId}')" 
                            class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left min-h-[50px]">
                        <span class="break-words flex-1">${item.eventos_que_pode_ter || 'Selecionar...'}</span>
                        <input type="hidden" id="loc-eventos-possiveis" value="${item.eventos_que_pode_ter || ''}">
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 shrink-0"></i>
                    </button>
                </div>
                
                <div class="border-t border-slate-100 my-2 pt-2">
                    <span class="text-[10px] font-black text-orange-custom uppercase tracking-widest block mb-2">Anci√£es</span>
                    <div class="flex flex-col gap-3">
                        ${renderSel('loc-anciao-1', 'Anci√£o 1', 'Anci√£o')}
                        ${renderSel('loc-anciao-2', 'Anci√£o 2', 'Anci√£o')}
                        ${renderSel('loc-anciao-3', 'Anci√£o 3', 'Anci√£o')}
                    </div>
                </div>
                <div class="border-t border-slate-100 my-2 pt-2">
                    <span class="text-[10px] font-black text-orange-custom uppercase tracking-widest block mb-2">Di√°conos</span>
                    <div class="flex flex-col gap-3">
                        ${renderSel('loc-diacono-1', 'Di√°cono 1', 'Di√°cono')}
                        ${renderSel('loc-diacono-2', 'Di√°cono 2', 'Di√°cono')}
                        ${renderSel('loc-diacono-3', 'Di√°cono 3', 'Di√°cono')}
                    </div>
                </div>
                <div class="border-t border-slate-100 my-2 pt-2">
                    <span class="text-[10px] font-black text-orange-custom uppercase tracking-widest block mb-2">Cooperadores</span>
                    <div class="flex flex-col gap-3">
                        ${renderSel('loc-com-1', 'Coop. Oficial 1', 'Coop. Oficial')}
                        ${renderSel('loc-com-2', 'Coop. Oficial 2', 'Coop. Oficial')}
                        ${renderSel('loc-cjm', 'Coop. Jovens', 'Coop. Jovens')}
                    </div>
                </div>
            ` : ''}${coll === 'feriados' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Data do Feriado</label><button id="feriado-btn" onclick="window.openFeriadoDatePicker()" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors"><span id="feriado-date-display">${item.data ? formatDateFull(item.data) : 'Selecionar Data...'}</span><i data-lucide="calendar" class="w-4 h-4 opacity-40"></i><input type="hidden" id="feriado-date-val" value="${item.data || ''}"></button></div><div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Tipo de Feriado</label><input id="feriado-tipo" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.tipo_feriado || ''}" placeholder="Ex: Nacional, Municipal..."></div>` : ''}${coll !== 'locations' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">${ctx.name}</label><input id="row-name" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy transition-colors" value="${mainV}" placeholder="Digite aqui..."></div>` : ''}${coll === 'types' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Sigla (EVT)</label><input id="row-extra" type="text" maxlength="5" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-black text-navy uppercase" value="${item.sigla || ''}"></div><div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Quem Atende</label><button onclick="window.openQuemAtendePicker('${safeId}')" class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left min-h-[50px]"><span class="break-words flex-1">${item.quem_atende || 'Selecionar...'}</span><input type="hidden" id="row-quem-atende" value="${item.quem_atende || ''}"><div class="flex gap-1 shrink-0 ml-2"><i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i></div></button></div>` : ''}${coll === 'attendants' ? `
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Minist√©rio</label>
                    <button onclick="window.openAttendantMinistryPicker('${safeId}')" class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left">
                        <span class="truncate">${item.ministerio || 'Selecionar Minist√©rio...'}</span>
                        <input type="hidden" id="row-extra" value="${item.ministerio || ''}">
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 shrink-0"></i>
                    </button>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Comum</label>
                    <button onclick="window.openAttendantComumPicker('${safeId}')" class="w-full flex justify-between items-center p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-white focus:ring-2 focus:ring-navy/10 text-left">
                        <span class="truncate">${item.comum || 'Selecionar Comum...'}</span>
                        <input type="hidden" id="row-comum" value="${item.comum || ''}">
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 shrink-0"></i>
                    </button>
                </div>
            ` : ''}<button onclick="window.saveRow('${coll}', '${safeId}')" class="w-full bg-navy text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg mt-2 active:scale-95 transition-transform">SALVAR REGISTRO ${!navigator.onLine ? '(OFFLINE)' : ''}</button></div></div>`);


        }

        async function saveRow(coll, id) {
            if (!state.isAdmin) return;
            const nameEl = document.getElementById('row-name');
            const name = nameEl?.value.trim();
            const dateVal = document.getElementById('feriado-date-val')?.value;
            const dateBtn = document.getElementById('feriado-btn');

            let hasError = false;
            if (coll !== 'perfis') {
                if (!name) { nameEl?.classList.add('input-error'); hasError = true; } else { nameEl?.classList.remove('input-error'); }
            }
            if (coll === 'feriados' && !dateVal) { dateBtn?.classList.add('input-error'); hasError = true; } else { dateBtn?.classList.remove('input-error'); }
            if (hasError) return;

            const p = {};
            if (coll === 'types') { const sigla = document.getElementById('row-extra')?.value.trim() || ""; const quemAtende = document.getElementById('row-quem-atende')?.value.trim() || ""; p.name = name; p.sigla = sigla.toUpperCase(); p.quem_atende = quemAtende; }
            else if (coll === 'locations') {
                p.localidade = name;
                p.adm = document.getElementById('loc-adm')?.value.trim();
                p.setor = document.getElementById('loc-setor')?.value.trim();
                p.cidade = document.getElementById('loc-cidade')?.value.trim();
                p.eventos_que_pode_ter = document.getElementById('loc-eventos-possiveis')?.value.trim() || null;

                // New Ministry Fields
                p.anciao_1 = document.getElementById('loc-anciao-1')?.value || null;
                p.anciao_2 = document.getElementById('loc-anciao-2')?.value || null;
                p.anciao_3 = document.getElementById('loc-anciao-3')?.value || null;
                p.diacono_1 = document.getElementById('loc-diacono-1')?.value || null;
                p.diacono_2 = document.getElementById('loc-diacono-2')?.value || null;
                p.diacono_3 = document.getElementById('loc-diacono-3')?.value || null;
                p.com_1 = document.getElementById('loc-com-1')?.value || null;
                p.com_2 = document.getElementById('loc-com-2')?.value || null;
                p.cjm = document.getElementById('loc-cjm')?.value || null;
            }
            else if (coll === 'attendants') {
                const min = document.getElementById('row-extra')?.value.trim() || "";
                const com = document.getElementById('row-comum')?.value || "";
                p.name = name;
                p.ministerio = min;
                p.comum = com;
            }
            else if (coll === 'feriados') { p.nome_feriado = name; p.data = dateVal; p.tipo_feriado = document.getElementById('feriado-tipo')?.value.trim(); }
            else if (coll === 'perfis') {
                p.autorizado = document.getElementById('user-authorized')?.checked;
                p.permissao = document.getElementById('user-permission')?.value;
            }

            if (coll !== 'perfis' && coll !== 'agenda') {
                let ext = null;
                if (coll === 'types') {
                    ext = state.types.find(i => String(i.id) !== String(id) && ((i.name || '').toLowerCase() === name.toLowerCase() || (i.sigla || '').toUpperCase() === p.sigla));
                } else if (coll === 'feriados') {
                    ext = state.feriados.find(i => String(i.id) !== String(id) && i.data === p.data && (i.nome_feriado || '').toLowerCase() === name.toLowerCase());
                } else {
                    const key = coll === 'locations' ? 'localidade' : 'name';
                    ext = state[coll].find(i => String(i.id) !== String(id) && (i[key] || '').toLowerCase() === name.toLowerCase());
                }
                if (ext) { showDuplicateModal(name, coll, ext.id, id, p); return; }
            }

            const isN = !id || id === 'undefined' || id === '';
            const action = isN ? 'INSERT' : 'UPDATE';

            await window.smartSave(coll, action, p, id, () => {
                if (!state.pendingConflict) {
                    closeModal();
                    if (window.updateManagerListUI) window.updateManagerListUI(coll);
                }
            });
        }

        function showDuplicateModal(name, coll, dupId, edId, curVals) {
            window.__duplicate_temp_data = curVals;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Registro Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">J√° existe um registro com este nome ou sigla:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dupId}', '${coll}')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.openRowModal('${coll}', '${edId}', window.__duplicate_temp_data)" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showEventDuplicateModal(dup) {
            const type = state.types.find((t) => t.id === dup.type_id);
            const loc = state.locations.find((l) => l.id === dup.location_id);
            const name = `${type?.name || 'Evento'} em ${loc?.localidade || 'Local'} (${formatDate(dup.date)} √†s ${dup.time})`;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Evento Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">J√° existe um evento id√™ntico cadastrado:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dup.id}', 'agenda')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.closeModal()" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showDeleteConfirmModal(id, coll, name) {
            if (!state.isAdmin) return;
            const isUser = coll === 'perfis';
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[8px] border-red-500"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mb-5"><i data-lucide="${isUser ? 'user-minus' : 'alert-triangle'}" class="text-red-500 w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3">Confirma√ß√£o</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Deseja realmente excluir ${isUser ? 'o usu√°rio e sua conta' : 'o registro'} <br><strong class="text-slate-700">"${name || ''}"</strong>?</p><div class="w-full flex gap-3"><button onclick="window.closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold active:scale-95 transition-all text-sm uppercase">N√£o</button><button onclick="window.confirmarExclusaoColecao('${id}', '${coll}')" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all text-sm uppercase">Sim, Excluir</button></div></div></div>`);
        }

        async function confirmarExclusaoColecao(id, coll) {
            if (!state.isAdmin) return;
            await window.smartSave(coll, 'DELETE', null, id, () => {
                closeModal();
                if (window.updateManagerListUI) window.updateManagerListUI(coll);
            });
        }

        async function confirmarEDeletar(id) {
            console.log("[confirmarEDeletar] Iniciando exclus√£o do ID:", id);
            if (!id || !state.isAdmin) return;
            await window.smartSave('agenda', 'DELETE', null, id, () => {
                console.log("[confirmarEDeletar] UI atualizada para exclus√£o.");
                closeModal();
                navigateTo('home');
            });
        }

        function navigateTo(screen, push = true) {
            if (push && state.currentScreen !== screen) window.history.pushState({ screen }, "");
            state.currentScreen = screen;
            state.isMenuOpen = false;
            state.managerSearchTerm = '';
            state.formErrors = [];
        }

        function openMenu() { state.isMenuOpen = true; }
        function closeMenu() { state.isMenuOpen = false; }
        function closeModal() { const m = document.getElementById('modal-container'); if (m) { m.classList.add('hidden'); m.innerHTML = ''; } }
        function showModal(html) { const m = document.getElementById('modal-container'); if (m) { m.innerHTML = html; m.classList.remove('hidden'); } renderIcons(); }

        function showLoginModal(startWithSignUp = false) {
            const t = document.getElementById('login-modal-template');
            const m = document.getElementById('modal-container');
            if (m && t) {
                m.innerHTML = ''; m.appendChild(t.content.cloneNode(true)); m.classList.remove('hidden');
                let isSignUp = startWithSignUp;
                const toggleBtn = document.getElementById('toggle-auth-mode');
                const nameField = document.getElementById('name-field');
                const submitBtn = document.getElementById('login-submit-btn');
                const titleEl = document.getElementById('modal-login-title');

                const updateUI = () => {
                    if (isSignUp) { titleEl.innerText = "Novo Cadastro"; nameField.classList.remove('hidden'); submitBtn.innerText = "Cadastrar"; toggleBtn.innerText = "J√° tem conta? Entre"; }
                    else { titleEl.innerText = "Fa√ßa Login ou Cadastro"; nameField.classList.add('hidden'); submitBtn.innerText = "Entrar"; toggleBtn.innerText = "N√£o tem conta? Cadastre-se"; }
                };

                updateUI();

                toggleBtn?.addEventListener('click', () => {
                    isSignUp = !isSignUp;
                    updateUI();
                });
                document.getElementById('login-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); const errD = document.getElementById('login-error');
                    if (btn) { btn.disabled = true; btn.innerText = isSignUp ? 'Cadastrando...' : 'Entrando...'; }
                    const name = document.getElementById('login-name').value.trim();
                    const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
                    try {
                        if (isSignUp) {
                            if (!name) throw new Error("O nome √© obrigat√≥rio para cadastro.");
                            const { data, error } = await supabaseClient.auth.signUp({
                                email,
                                password,
                                options: {
                                    data: {
                                        full_name: name
                                    }
                                }
                            });
                            if (error) throw error;
                            alert("Cadastro realizado! Aguarde a aprova√ß√£o de um administrador."); closeModal();
                        } else {
                            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            closeModal();
                        }
                    } catch (err) {
                        if (errD) {
                            errD.innerText = translateAuthError(err.message);
                            errD.classList.remove('hidden');
                        }
                        if (btn) {
                            btn.disabled = false;
                            btn.innerText = isSignUp ? 'Cadastrar' : 'Entrar';
                        }
                    }
                });
            }
            renderIcons();
        }

        function renderFFRow(l, v, t, c) {
            const isS = c === t;
            const currentDate = state.ffTemp.baseDates[t];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const compareDate = new Date(currentDate);
            compareDate.setHours(0, 0, 0, 0);

            // Determinar se os bot√µes devem ser desabilitados
            let disableLeft = false;
            let disableRight = false;

            if (state.masterEventFilter === 'ativos') {
                // Ativos: n√£o pode voltar para o passado
                disableLeft = compareDate <= today;
            } else if (state.masterEventFilter === 'inativos') {
                // Inativos: n√£o pode avan√ßar para o futuro
                disableRight = compareDate >= today;
            }
            // Se 'todos', ambos ficam habilitados

            const leftBtnClass = disableLeft ? 'p-1 rounded-full shadow-sm border border-slate-200 bg-slate-100 text-slate-300 cursor-not-allowed opacity-50' : 'p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white';
            const rightBtnClass = disableRight ? 'p-1 rounded-full shadow-sm border border-slate-200 bg-slate-100 text-slate-300 cursor-not-allowed opacity-50' : 'p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white';

            return `<div class="flex flex-col gap-1.5 p-3 rounded-2xl border-2 transition-all h-full ${isS ? 'border-orange-custom bg-orange-50/30' : 'border-slate-100 bg-slate-50/50'}" onclick="window.state.ffTemp.selected = '${t}'; window.renderFastFilterUI();"><div class="flex justify-between items-center px-1"><span class="text-[9px] font-black uppercase tracking-tight ${isS ? 'text-orange-custom' : 'text-slate-400'}">${l}</span><div class="flex gap-2"><button onclick="event.stopPropagation(); window.shiftFF('${t}', -1)" class="${leftBtnClass}" ${disableLeft ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i></button><button onclick="event.stopPropagation(); window.shiftFF('${t}', 1)" class="${rightBtnClass}" ${disableRight ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button></div></div><div class="text-[11px] font-bold text-navy px-1 leading-tight">${v}</div></div>`;
        }

        function renderFastFilterUI() {
            const bD = state.ffTemp.baseDates; const sel = state.ffTemp.selected;
            const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            const todayT = `${bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).charAt(0).toUpperCase() + bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).slice(1)}, dia ${fBR(bD.today)}`;
            const dW1 = new Date(bD.week); dW1.setDate(bD.week.getDate() - bD.week.getDay()); const dW2 = new Date(dW1); dW2.setDate(dW1.getDate() + 6);
            showModal(`<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-gap-2 text-navy"><i data-lucide="filter" class="w-5 h-5 text-orange-custom"></i><h3 class="text-lg font-black tracking-tight uppercase">Filtro</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-4">${renderFFRow('Por dia', todayT, 'today', sel)}${renderFFRow('Semana', fBR(dW1) + ' a ' + fBR(dW2), 'week', sel)}<div class="flex gap-3"><div class="flex-1">${renderFFRow('M√™s', `${["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][bD.month.getMonth()]} / ${bD.month.getFullYear()}`, 'month', sel)}</div><div class="flex-1">${renderFFRow('Ano', bD.year.getFullYear().toString(), 'year', sel)}</div></div></div><div class="p-4 bg-white border-t border-slate-50"><button onclick="window.applyNewFastFilter()" class="w-full bg-navy text-white py-4 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
            renderIcons();
        }

        function renderPickerItems(items, coll, isA, tar, prop, currentVal) {
            if (items.length === 0) return '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum registro.</div>';
            const sorted = [...items].sort((a, b) => ((coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '').localeCompare((coll === 'locations' ? b.localidade : (coll === 'perfis' ? b.nome : b.name)) || ''));
            return sorted.map((i) => {
                const name = (coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '';
                const sigla = coll === 'types' ? i.sigla : '';
                const isS = isA ? state.advancedFilter?.[tar]?.id === i.id : (tar === 'attendant_comum' ? currentVal === name : state[prop] === i.id);
                return `<button onclick="${isA ? `window.handleAdvSelectorSelect('${tar}', '${i.id}')` : (tar === 'attendant_comum' ? `window.handleAttendantComumSelection('${name.replace(/'/g, "\\'")}')` : `window.state.${prop} = '${i.id}'; window.state.formErrors = window.state.formErrors.filter(e => !'${prop}'.includes(e)); window.closeModal();`)}" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><div class="flex flex-col min-w-0 flex-1"><span class="group-hover:text-navy transition-colors font-bold text-sm leading-tight">${name}</span>${sigla ? `<span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-0.5">${sigla}</span>` : ''}</div>${isS ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0 ml-2"></i>' : ''}</button>`;
            }).join('');
        }

        async function refreshAllData() {
            if (!state.isAuthorized || !navigator.onLine) return;
            const tables = {
                'types': 'types',
                'locations': 'locations',
                'attendants': 'attendants',
                'agenda': 'events',
                'feriados': 'feriados',
                'perfis': 'perfis'
            };

            // Passo 1: Carregamento paralelo das tabelas
            try {
                const promises = Object.entries(tables).map(async ([table, key]) => {
                    const { data, error } = await supabaseClient.from(table).select('*');
                    if (!error && data) {
                        state[key] = data;
                        localStorage.setItem(`cache_${table}`, JSON.stringify(data));
                    }
                });
                await Promise.all(promises);
                scheduleRender();
                if (window.updateHomeList) window.updateHomeList();
            } catch (e) { }
        }

        function showConnStatus(status) {
            const el = document.getElementById('conn-status');
            if (!el) return;
            el.className = '';
            if (status === 'offline') { el.innerHTML = '<i data-lucide="wifi-off" class="w-3.5 h-3.5"></i> Sem internet - Modo Offline'; el.classList.add('offline'); }
            else if (status === 'online-recovered') { el.innerHTML = '<i data-lucide="wifi" class="w-3.5 h-3.5"></i> Online Sincronizando...'; el.classList.add('online-recovered'); setTimeout(() => { el.classList.remove('online-recovered'); }, 3000); }
            renderIcons();
        }

        Object.assign(window, {
            renderApp, scheduleRender, navigateTo, openMenu, closeMenu, closeModal, showModal,
            handleLogout: () => {
                state.isLoading = true;
                cleanupListeners();
                localStorage.clear();
                sessionStorage.clear();
                supabaseClient.auth.signOut().then(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                });
            },
            showLoginModal, saveRow, openRowModal, requestDeleteRow: (id, coll, name) => showDeleteConfirmModal(id, coll, name), confirmarExclusaoColecao, renderCalendar, renderClockUI, renderAdvancedFilterModal, openDistinctPicker, openAdvancedFilterModal: () => renderAdvancedFilterModal(), resetAllFilters: () => { state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; state.highlightedItemId = null; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; window.updateHomeList(); },
            startOpenAgenda: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; const t = new Date().toISOString().split('T')[0]; if (!state.selectedDate) state.selectedDate = t; state.viewDate = new Date(state.selectedDate + 'T00:00:00'); renderCalendar('filter'); },
            changeMonth: (o, m) => { const d = new Date(state.viewDate); d.setMonth(d.getMonth() + o); state.viewDate = d; if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); },
            changePickerYear: (o, m) => { const d = new Date(state.viewDate); d.setFullYear(d.getFullYear() + o); state.viewDate = d; if (m.includes('month') || m === 'adv_period') window.openMonthPicker(m); else window.openYearPicker(m); },
            selectMonth: (i, m) => { const d = new Date(state.viewDate); d.setMonth(i); state.viewDate = d; if (m === 'adv_period') { const first = new Date(d.getFullYear(), i, 1); const last = new Date(d.getFullYear(), i + 1, 0); state.advancedFilter.period.start = first.toISOString().split('T')[0]; state.advancedFilter.period.end = last.toISOString().split('T')[0]; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(i + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            selectYear: (y, m) => { const d = new Date(state.viewDate); d.setFullYear(y); state.viewDate = d; if (m === 'adv_period') { state.advancedFilter.period.start = `${y}-01-01`; state.advancedFilter.period.end = `${y}-12-31`; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${y}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            openMonthPicker: (m) => { const names = ["JANEIRO", "FEVEREIRO", "MAR√áO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"]; const year = state.viewDate.getFullYear(); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-6 h-6"></i></button><div class="flex items-center justify-center gap-3 w-full mb-6"><button onclick="window.changePickerYear(-1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><span class="text-sm font-black text-navy uppercase tracking-widest">${year}</span><button onclick="window.changePickerYear(1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div><div class="grid grid-cols-3 gap-3 w-full">${names.map((n, i) => `<button onclick="window.selectMonth(${i}, '${m}')" class="py-4 text-[11px] font-black rounded-xl border transition-all ${state.viewDate.getMonth() === i ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${n.slice(0, 3)}</button>`).join('')}</div></div>`); },
            openYearPicker: (m) => { const currentYear = new Date().getFullYear(); const selectedYear = (m === 'adv_period' && state.advancedFilter.period.start) ? new Date(state.advancedFilter.period.start + 'T00:00:00').getFullYear() : currentYear; state.viewDate = new Date(selectedYear, 0, 1); const years = []; for (let i = currentYear - 30; i < currentYear + 30; i++) years.push(i); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button><div class="flex items-center justify-center w-full mb-6"><span class="text-sm font-black text-navy uppercase tracking-widest">ANO</span></div><div id="year-scroll-container" class="grid grid-cols-3 gap-3 w-full max-h-[224px] overflow-y-auto scrollbar-none py-2">${years.map(y => `<button id="year-btn-${y}" onclick="window.selectYear(${y}, '${m}')" class="py-4 text-xs font-black rounded-xl border transition-all ${y === selectedYear ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${y}</button>`).join('')}</div></div>`); setTimeout(() => { const btn = document.getElementById(`year-btn-${selectedYear}`); if (btn) btn.scrollIntoView({ block: 'center' }); }, 10); },
            selectCalendarDate: (d, m = 'filter') => { if (m === 'filter') { state.selectedDate = d; renderCalendar('filter'); } else if (m === 'picker') { state.formTempDate = d; state.formErrors = state.formErrors.filter(e => e !== 'date'); closeModal(); } else if (m === 'adv_start' || m === 'adv_end') { state.advancedFilter.period[m === 'adv_start' ? 'start' : 'end'] = d; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); window.scrollToAdvSection('period'); } else if (m === 'feriado_picker') { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, { ...c.item, data: d }); } },
            applyCalendarAndClose: () => { state.fastFilter = { active: false }; state.advancedFilter.active = false; window.updateHomeList(); closeModal(); },
            openFormDate: () => { state.viewDate = new Date((state.formTempDate || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('picker'); },
            openFeriadoDatePicker: () => { state.viewDate = new Date((document.getElementById('feriado-date-val')?.value || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('feriado_picker'); },
            returnToFeriadoModal: () => { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, c.item); },
            renderFastFilterUI,
            openFastFilterModal: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; state.ffTemp.baseDates = { today: new Date(), week: new Date(), month: new Date(), year: new Date() }; renderFastFilterUI(); },
            shiftFF: (t, o) => {
                // Valida√ß√£o baseada no filtro mestre
                const currentDate = new Date(state.ffTemp.baseDates[t]);
                currentDate.setHours(0, 0, 0, 0);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Calcular a nova data
                const d = new Date(state.ffTemp.baseDates[t]);
                if (t === 'today') d.setDate(d.getDate() + o);
                else if (t === 'week') d.setDate(d.getDate() + (o * 7));
                else if (t === 'month') d.setMonth(d.getMonth() + o);
                else if (t === 'year') d.setFullYear(d.getFullYear() + o);

                const newDate = new Date(d);
                newDate.setHours(0, 0, 0, 0);

                // Aplicar restri√ß√µes baseadas no filtro mestre
                if (state.masterEventFilter === 'ativos') {
                    // Ativos: n√£o pode voltar para o passado
                    if (o === -1 && newDate < today) {
                        return; // Bloqueia navega√ß√£o para o passado
                    }
                } else if (state.masterEventFilter === 'inativos') {
                    // Inativos: n√£o pode avan√ßar para o futuro
                    if (o === 1 && newDate > today) {
                        return; // Bloqueia navega√ß√£o para o futuro
                    }
                }
                // Se 'todos', permite qualquer navega√ß√£o

                state.ffTemp.baseDates[t] = d;
                state.ffTemp.selected = t;
                renderFastFilterUI();
            },
            applyNewFastFilter: () => { const b = new Date(state.ffTemp.baseDates[state.ffTemp.selected]); let st = '', en = '', la = ''; const f = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; if (state.ffTemp.selected === 'today') { st = en = f(b); let w = b.toLocaleDateString('pt-BR', { weekday: 'long' }); la = `${w.charAt(0).toUpperCase() + w.slice(1)}, dia ${fBR(b)}`; } else if (state.ffTemp.selected === 'week') { const d1 = new Date(b); d1.setDate(b.getDate() - b.getDay()); const d2 = new Date(d1); d2.setDate(d1.getDate() + 6); st = f(d1); en = f(d2); la = `Semana ${fBR(d1)} a ${fBR(d2)}`; } else if (state.ffTemp.selected === 'month') { const d1 = new Date(b.getFullYear(), b.getMonth(), 1); const d2 = new Date(b.getFullYear(), b.getMonth() + 1, 0); st = f(d1); en = f(d2); la = `${["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"][b.getMonth()]} / ${b.getFullYear()}`; } else if (state.ffTemp.selected === 'year') { st = `${b.getFullYear()}-01-01`; en = `${b.getFullYear()}-12-31`; la = `Ano de ${b.getFullYear()}`; } state.selectedDate = null; state.advancedFilter.active = false; state.fastFilter = { active: true, dateStart: st, dateEnd: en, label: la }; closeModal(); window.updateHomeList(); },
            toggleAdvFilterSection: (sec) => { const af = state.advancedFilter; af[sec].enabled = !af[sec].enabled; af.validationErrors = af.validationErrors.filter(e => e !== sec); if (sec === 'adm' && !af.adm.enabled) { af.adm.value = ''; af.setor.enabled = false; af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'setor' && !af.setor.enabled) { af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'cidade' && !af.cidade.enabled) { af.cidade.value = ''; af.location.id = ''; } window.renderAdvancedFilterModal(); if (af[sec].enabled) window.scrollToAdvSection(sec); },
            handleAdvFilterSelect: (f, v) => {
                const af = state.advancedFilter;
                af[f].value = v;
                af.validationErrors = af.validationErrors.filter(e => e !== f);
                if (state.currentScreen === 'locations') {
                    window.applyLocalityCascade(f);
                } else {
                    if (f === 'adm') { af.setor.value = ''; af.cidade.value = ''; af.location.id = ''; }
                    else if (f === 'setor') { af.cidade.value = ''; af.location.id = ''; }
                    else if (f === 'cidade') af.location.id = '';
                }
                window.renderAdvancedFilterModal();
                window.scrollToAdvSection(f);
            },
            applyLocalityCascade: (startField) => {
                const af = state.advancedFilter;
                const levels = ['attendant', 'adm', 'setor', 'cidade', 'location'];
                const startIndex = levels.indexOf(startField);

                // Normaliza√ß√£o para compara√ß√£o
                const norm = (s) => (s || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();

                // Propaga√ß√£o em cascata estrita
                for (let i = startIndex; i < levels.length - 1; i++) {
                    const nextField = levels[i + 1];

                    // Filtrar localidades v√°lidas com base no que j√° est√° selecionado NO MOMENTO (inclusive valores preenchidos na cascata)
                    let validLocs = [...state.locations];

                    if (af.attendant.enabled && af.attendant.id) {
                        const att = state.attendants.find(a => a.id === af.attendant.id);
                        if (att) {
                            const attName = norm(att.name);
                            validLocs = validLocs.filter(l => [l.anciao_1, l.anciao_2, l.anciao_3, l.diacono_1, l.diacono_2, l.diacono_3, l.com_1, l.com_2, l.cjm].some(name => name && norm(name) === attName));
                        }
                    }
                    if (af.adm.enabled && af.adm.value) validLocs = validLocs.filter(l => norm(l.adm) === norm(af.adm.value));
                    if (af.setor.enabled && af.setor.value) validLocs = validLocs.filter(l => norm(l.setor) === norm(af.setor.value));
                    if (af.cidade.enabled && af.cidade.value) validLocs = validLocs.filter(l => norm(l.cidade) === norm(af.cidade.value));

                    // Verifica op√ß√µes para o PR√ìXIMO n√≠vel
                    let options = [];
                    if (nextField === 'location') {
                        options = validLocs.map(l => l.id);
                    } else {
                        options = [...new Set(validLocs.map(l => l[nextField]).filter(Boolean))];
                    }

                    if (options.length === 1) {
                        // √önica op√ß√£o: Abre campo, preenche e continua a cascata para o pr√≥ximo n√≠vel
                        af[nextField].enabled = true;
                        if (nextField === 'location') af[nextField].id = options[0];
                        else af[nextField].value = options[0];
                    } else {
                        // Mais de uma op√ß√£o (ou nenhuma): Fecha este campo e TODOS os inferiores na cadeia
                        for (let j = i + 1; j < levels.length; j++) {
                            const subField = levels[j];
                            af[subField].enabled = false;
                            if (subField === 'location' || subField === 'attendant') af[subField].id = '';
                            else af[subField].value = '';
                        }
                        break; // Para a propaga√ß√£o completamente
                    }
                }
            },
            setAdvFilterStatus: (s) => { state.advancedFilter.eventos.status = s; },
            clearAdvancedFilters: () => {
                state.advancedFilter = { active: false, eventos: { enabled: false, status: 'ativos' }, type: { enabled: false, id: '' }, location: { enabled: false, id: '' }, attendant: { enabled: false, id: '' }, adm: { enabled: false, value: '' }, setor: { enabled: false, value: '' }, cidade: { enabled: false, value: '' }, period: { enabled: false, start: '', end: '' }, validationErrors: [] };
                if (state.currentScreen === 'locations') window.updateManagerListUI('locations');
                else window.updateHomeList();
                window.renderAdvancedFilterModal();
            },
            applyAdvancedFilters: () => {
                const af = state.advancedFilter; const errs = [];
                if (af.type.enabled && !af.type.id) errs.push('type');
                if (af.location.enabled && !af.location.id) errs.push('location');
                if (af.attendant.enabled && !af.attendant.id) errs.push('attendant');
                if (af.adm.enabled && !af.adm.value) errs.push('adm');
                if (af.setor.enabled && !af.setor.value) errs.push('setor');
                if (af.cidade.enabled && !af.cidade.value) errs.push('cidade');
                if (af.period.enabled && (!af.period.start || !af.period.end)) errs.push('period');
                if (errs.length > 0) { state.advancedFilter.validationErrors = errs; window.renderAdvancedFilterModal(); return; }
                state.selectedDate = null; state.fastFilter.active = false; state.advancedFilter.active = true; state.advancedFilter.validationErrors = [];
                closeModal();
                if (state.currentScreen === 'locations') window.updateManagerListUI('locations');
                else window.updateHomeList();
            },
            handleAdvSelectorSelect: (tar, id) => {
                const af = state.advancedFilter;
                af[tar].id = id;
                af.validationErrors = af.validationErrors.filter(e => e !== tar);

                if (tar === 'attendant' && state.currentScreen === 'locations') {
                    window.applyLocalityCascade('attendant');
                } else if (tar === 'location' && state.currentScreen === 'locations') {
                    // Se selecionou localidade diretamente, garante que os pais estejam preenchidos se forem √∫nicos
                    const loc = state.locations.find(l => l.id === id);
                    if (loc) {
                        if (!af.adm.value) { af.adm.enabled = true; af.adm.value = loc.adm; }
                        if (!af.setor.value) { af.setor.enabled = true; af.setor.value = loc.setor; }
                        if (!af.cidade.value) { af.cidade.enabled = true; af.cidade.value = loc.cidade; }
                    }
                }

                window.renderAdvancedFilterModal();
                window.scrollToAdvSection(tar);
            },
            openDateRangePicker: (t) => { state.viewDate = new Date((state.advancedFilter.period[t] || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar(t === 'start' ? 'adv_start' : 'adv_end'); },
            openReportPreview: () => {
                window.activeReportType = 'events';
                const events = getFilteredEvents();
                const filterDesc = getFilterDescription('home');
                const itemsPerPage = 32; // Increased to 32 to match Locations report and fill A4 page
                const totalPages = Math.ceil(events.length / itemsPerPage) || 1;

                let pagesHtml = '';
                for (let i = 0; i < totalPages; i++) {
                    const pageEvents = events.slice(i * itemsPerPage, (i + 1) * itemsPerPage);

                    const dateSpans = [];
                    let d = 0;
                    while (d < pageEvents.length) {
                        let count = 1;
                        while (d + count < pageEvents.length && formatDate(pageEvents[d].date) === formatDate(pageEvents[d + count].date)) count++;
                        for (let j = 0; j < count; j++) dateSpans.push(j === 0 ? count : 0);
                        d += count;
                    }

                    const timeSpans = [];
                    let t = 0;
                    while (t < pageEvents.length) {
                        let count = 1;
                        const startsAtDateTop = (dateSpans[t] > 0);
                        while (
                            t + count < pageEvents.length &&
                            pageEvents[t].time === pageEvents[t + count].time
                        ) {
                            if (!startsAtDateTop && formatDate(pageEvents[t].date) !== formatDate(pageEvents[t + count].date)) break;
                            count++;
                        }
                        for (let j = 0; j < count; j++) timeSpans.push(j === 0 ? count : 0);
                        t += count;
                    }

                    const tableRows = pageEvents.map((e, index) => {
                        const type = state.types.find(t => t.id === e.type_id);
                        const loc = state.locations.find(l => l.id === e.location_id);
                        const att = state.attendants.find(a => a.id === e.attendant_id);
                        const att2 = state.attendants.find(a => a.id === e.attendant2_id);
                        const globalIndex = (i * itemsPerPage) + index;
                        const isZebra = globalIndex % 2 !== 0;
                        const dateSpan = dateSpans[index];
                        const timeSpan = timeSpans[index];

                        // Formatar exibi√ß√£o dos atendentes
                        let attendantDisplay = att?.name || '';
                        if (att2?.name) {
                            attendantDisplay = `${att?.name || ''} / ${att2.name}`;
                        }

                        return `
                            <tr>
                                ${dateSpan > 0 ? `<td rowspan="${dateSpan}" class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 text-center align-middle bg-white" style="vertical-align: middle;">${formatDate(e.date)}</td>` : ''}
                                ${timeSpan > 0 ? `<td rowspan="${timeSpan}" class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 text-center align-middle bg-white" style="vertical-align: middle;">${e.time}</td>` : ''}
                                <td class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-bold text-navy align-middle ${isZebra ? 'bg-slate-50' : 'bg-white'}" style="vertical-align: middle;">${type?.name || ''}</td>
                                <td class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 align-middle ${isZebra ? 'bg-slate-50' : 'bg-white'}" style="vertical-align: middle;">${loc?.localidade || ''}</td>
                                <td class="py-1 px-1 md:py-1 md:px-2 border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-600 align-middle ${isZebra ? 'bg-slate-50' : 'bg-white'}" style="vertical-align: middle;">${attendantDisplay}</td>
                            </tr>
                        `;
                    }).join('');

                    pagesHtml += `
                        <div class="report-page bg-white shadow-2xl w-full max-w-[210mm] min-h-[297mm] max-h-[297mm] md:max-h-none md:h-auto overflow-hidden md:overflow-visible p-1.5 md:pt-[13mm] md:px-[10mm] md:pb-[20mm] flex flex-col mx-auto mb-10 last:mb-0" data-page="${i + 1}">
                             <div class="mb-3 md:mb-6 border-b-2 border-navy pb-3 md:pb-4 text-center shrink-0">
                                <h2 class="text-base md:text-lg font-black text-navy uppercase tracking-tighter">Agenda CCB</h2>
                                <p class="text-[6px] md:text-[8px] font-bold text-slate-400 opacity-80 uppercase tracking-[0.2em] mt-1">${filterDesc}</p>
                            </div>

                            <div class="w-full border border-slate-200 rounded-lg shadow-sm flex-1 md:flex-none overflow-y-auto md:overflow-visible min-h-0 md:min-h-[auto] relative scrollbar-hide">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-navy text-white text-[8px] md:text-[10px] uppercase tracking-widest">
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Data</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Hora</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Evento</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Localidade</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center align-middle">Atendente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows || '<tr><td colspan="5" class="p-8 text-center text-slate-300 italic font-medium align-middle">Nenhum evento encontrado.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-4 md:mt-8 pt-4 md:pt-6 text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest flex justify-between border-t border-slate-100 shrink-0">
                                <span>Gerado: ${new Date().toLocaleDateString('pt-BR')}</span>
                                <span>P√°g ${i + 1}/${totalPages}</span>
                            </div>
                        </div>
                    `;
                }

                showModal(`
                    <div class="bg-slate-500/20 backdrop-blur-md rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div class="p-4 flex justify-between items-center border-b border-white/10 bg-navy text-white shrink-0">
                            <div class="flex items-center gap-2">
                                <i data-lucide="file-text" class="w-5 h-5 text-orange-custom"></i>
                                <h3 class="text-lg font-black tracking-tight uppercase">Visualiza√ß√£o do Relat√≥rio</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest hidden md:inline-block">${totalPages} ${totalPages > 1 ? 'P√°ginas' : 'P√°gina'}</span>
                                <button onclick="window.closeModal()" class="text-white/50 hover:text-white p-1 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-2 md:p-8 scrollbar-hide flex flex-col items-center bg-slate-600/10 gap-10">
                            ${pagesHtml}
                        </div>

                        <div class="p-6 border-t border-white/10 bg-navy grid grid-cols-2 gap-4 shrink-0">
                            <button onclick="window.downloadPDF()" class="py-4 bg-white text-navy rounded-xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 hover:bg-slate-50">
                                <i data-lucide="file-down" class="w-5 h-5 text-red-500"></i> PDF
                            </button>
                            <button onclick="window.downloadPNG()" class="py-4 bg-orange-custom text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 hover:brightness-110">
                                <i data-lucide="image" class="w-5 h-5"></i> PNG
                            </button>
                        </div>
                    </div>
                    <style>
                        .scrollbar-hide::-webkit-scrollbar { display: none; }
                        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                        .report-page table { border-collapse: collapse !important; border-spacing: 0 !important; }
                        .report-page td { 
                            vertical-align: middle !important;
                            display: table-cell !important;
                            line-height: 1.5 !important;
                        }
                        .report-page td > * {
                            display: inline-block !important;
                            vertical-align: middle !important;
                        }
                    </style>
                `);
                renderIcons();
            },
            getFilteredLocations: () => {
                let filtered = [...state.locations];
                const term = (state.managerSearchTerm || '').toLowerCase();
                const af = state.advancedFilter;

                // Search Term Check
                if (term) {
                    filtered = filtered.filter(l => {
                        const locName = (l.localidade || '').toLowerCase();
                        const admVal = (l.adm || '').toLowerCase();
                        const setorVal = (l.setor || '').toLowerCase();
                        const cidadeVal = (l.cidade || '').toLowerCase();
                        return locName.includes(term) || admVal.includes(term) || setorVal.includes(term) || cidadeVal.includes(term);
                    });
                }

                // Advanced Filter Check
                if (af.active && state.currentScreen === 'locations') {
                    if (af.adm.enabled && af.adm.value) filtered = filtered.filter(l => (l.adm || '').toLowerCase() === af.adm.value.toLowerCase());
                    if (af.setor.enabled && af.setor.value) filtered = filtered.filter(l => (l.setor || '').toLowerCase() === af.setor.value.toLowerCase());
                    if (af.cidade.enabled && af.cidade.value) filtered = filtered.filter(l => (l.cidade || '').toLowerCase() === af.cidade.value.toLowerCase());
                    if (af.location.enabled && af.location.id) filtered = filtered.filter(l => l.id === af.location.id);
                    if (af.attendant.enabled && af.attendant.id) {
                        const att = state.attendants.find(a => a.id === af.attendant.id);
                        if (att) {
                            const norm = (s) => (s || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
                            const attName = norm(att.name);
                            filtered = filtered.filter(l => [l.anciao_1, l.anciao_2, l.anciao_3, l.diacono_1, l.diacono_2, l.diacono_3, l.com_1, l.com_2, l.cjm].some(name => name && norm(name) === attName));
                        }
                    }
                }

                return filtered.sort((a, b) => {
                    const s1 = (a.adm || '').localeCompare(b.adm || '');
                    if (s1 !== 0) return s1;
                    const s2 = (a.setor || '').localeCompare(b.setor || '');
                    if (s2 !== 0) return s2;
                    const s3 = (a.cidade || '').localeCompare(b.cidade || '');
                    if (s3 !== 0) return s3;
                    return (a.localidade || '').localeCompare(b.localidade || '');
                });
            },
            openLocationsReportPreview: () => {
                window.activeReportType = 'locations';
                const items = window.getFilteredLocations();
                const filterDesc = getFilterDescription('locations');
                const itemsPerPage = 32;
                const totalPages = Math.ceil(items.length / itemsPerPage) || 1;

                let pagesHtml = '';
                for (let i = 0; i < totalPages; i++) {
                    const pageItems = items.slice(i * itemsPerPage, (i + 1) * itemsPerPage);

                    const admSpans = [];
                    let d = 0;
                    while (d < pageItems.length) {
                        let count = 1;
                        while (d + count < pageItems.length && (pageItems[d].adm || '') === (pageItems[d + count].adm || '')) count++;
                        for (let j = 0; j < count; j++) admSpans.push(j === 0 ? count : 0);
                        d += count;
                    }

                    const setorSpans = [];
                    let s = 0;
                    while (s < pageItems.length) {
                        let count = 1;
                        while (
                            s + count < pageItems.length &&
                            (pageItems[s].setor || '') === (pageItems[s + count].setor || '') &&
                            (pageItems[s].adm || '') === (pageItems[s + count].adm || '')
                        ) count++;
                        for (let j = 0; j < count; j++) setorSpans.push(j === 0 ? count : 0);
                        s += count;
                    }

                    const citySpans = [];
                    let c = 0;
                    while (c < pageItems.length) {
                        let count = 1;
                        while (
                            c + count < pageItems.length &&
                            (pageItems[c].cidade || '') === (pageItems[c + count].cidade || '') &&
                            (pageItems[c].setor || '') === (pageItems[c + count].setor || '') &&
                            (pageItems[c].adm || '') === (pageItems[c + count].adm || '')
                        ) count++;
                        for (let j = 0; j < count; j++) citySpans.push(j === 0 ? count : 0);
                        c += count;
                    }

                    const tableRows = pageItems.map((l, index) => {
                        const globalIndex = (i * itemsPerPage) + index;
                        const isZebra = globalIndex % 2 !== 0; // Keep zebra for non-merged cells if needed, or row based
                        // With merging, zebra usually looks better on the lowest level or per row. Keeping row based.

                        const admSpan = admSpans[index];
                        const setorSpan = setorSpans[index];
                        const citySpan = citySpans[index];

                        return `
                             <tr>
                                ${admSpan > 0 ? `<td rowspan="${admSpan}" class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 align-middle bg-white text-center" style="vertical-align: middle;">${l.adm || '-'}</td>` : ''}
                                ${setorSpan > 0 ? `<td rowspan="${setorSpan}" class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 align-middle bg-white text-center" style="vertical-align: middle;">${l.setor || '-'}</td>` : ''}
                                ${citySpan > 0 ? `<td rowspan="${citySpan}" class="py-1 px-1 md:py-1 md:px-2 border-r border-b border-slate-200 text-[8px] md:text-[11px] font-medium text-slate-700 align-middle bg-white text-center truncate max-w-[100px]" style="vertical-align: middle;">${l.cidade || '-'}</td>` : ''}
                                <td class="py-1 px-1 md:py-1 md:px-2 border-b border-slate-200 text-[8px] md:text-[11px] font-black text-navy align-middle ${isZebra ? 'bg-slate-50' : 'bg-white'} truncate max-w-[150px]" style="vertical-align: middle;">${l.localidade || '-'}</td>
                            </tr>
                        `;
                    }).join('');

                    pagesHtml += `
                        <div class="report-page bg-white shadow-2xl w-full max-w-[210mm] min-h-[297mm] max-h-[297mm] md:max-h-none md:h-auto overflow-hidden md:overflow-visible p-1.5 md:pt-[10mm] md:px-[10mm] md:pb-[20mm] flex flex-col mx-auto mb-10 last:mb-0" data-page="${i + 1}">
                             <div class="mb-3 md:mb-6 border-b-2 border-navy pb-3 md:pb-4 text-center shrink-0">
                                <h2 class="text-sm md:text-base font-black text-navy uppercase tracking-tighter">Relat√≥rio de Localidades</h2>
                                <p class="text-[6px] md:text-[8px] font-bold text-slate-400 opacity-80 uppercase tracking-[0.2em] mt-1">${filterDesc}</p>
                            </div>

                            <div class="w-full border border-slate-200 rounded-lg shadow-sm flex-1 md:flex-none overflow-y-auto md:overflow-visible min-h-0 md:min-h-[auto] relative scrollbar-hide">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr class="bg-navy text-white text-[8px] md:text-[10px] uppercase tracking-widest">
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">ADM</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Setor</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center border-r border-white align-middle">Cidade</th>
                                            <th class="py-1 px-1 md:py-1.5 md:px-2 text-center align-middle">Localidade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows || '<tr><td colspan="4" class="p-8 text-center text-slate-300 italic font-medium align-middle">Nenhuma localidade encontrada.</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            
                             <div class="mt-4 md:mt-8 pt-4 md:pt-6 text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest flex justify-between border-t border-slate-100 shrink-0">
                                <span>Gerado: ${new Date().toLocaleDateString('pt-BR')}</span>
                                <span>P√°g ${i + 1}/${totalPages}</span>
                            </div>
                        </div>
                    `;
                }

                showModal(`
                    <div class="bg-slate-500/20 backdrop-blur-md rounded-xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div class="p-4 flex justify-between items-center border-b border-white/10 bg-navy text-white shrink-0">
                            <div class="flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-5 h-5 text-orange-custom"></i>
                                <h3 class="text-lg font-black tracking-tight uppercase">Relat√≥rio de Localidades</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-[10px] font-bold text-white/40 uppercase tracking-widest hidden md:inline-block">${totalPages} ${totalPages > 1 ? 'P√°ginas' : 'P√°gina'}</span>
                                <button onclick="window.closeModal()" class="text-white/50 hover:text-white p-1 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto p-2 md:p-8 scrollbar-hide flex flex-col items-center bg-slate-600/10 gap-10">
                            ${pagesHtml}
                        </div>

                        <div class="p-6 border-t border-white/10 bg-navy grid grid-cols-2 gap-4 shrink-0">
                            <button onclick="window.downloadPDF()" class="py-4 bg-white text-navy rounded-xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 hover:bg-slate-50">
                                <i data-lucide="file-down" class="w-5 h-5 text-red-500"></i> PDF
                            </button>
                            <button onclick="window.downloadPNG()" class="py-4 bg-orange-custom text-white rounded-xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 hover:brightness-110">
                                <i data-lucide="image" class="w-5 h-5"></i> PNG
                            </button>
                        </div>
                    </div>
                    <style>
                        .scrollbar-hide::-webkit-scrollbar { display: none; }
                        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
                        .report-page table { border-collapse: collapse !important; border-spacing: 0 !important; }
                        .report-page td { 
                            vertical-align: middle !important;
                            display: table-cell !important;
                            line-height: 1.5 !important;
                        }
                        .report-page td > * {
                            display: inline-block !important;
                            vertical-align: middle !important;
                        }
                    </style>
                `);
                renderIcons();
            },
            downloadPDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                let tableConfig = {};
                let title = "Agenda CCB";
                let filterDesc = "";

                if (window.activeReportType === 'locations') {
                    title = "RELAT√ìRIO DE LOCALIDADES";
                    filterDesc = getFilterDescription('locations');
                    const items = window.getFilteredLocations();
                    const itemsPerPage = 32;
                    const totalPages = Math.ceil(items.length / itemsPerPage) || 1;

                    for (let i = 0; i < totalPages; i++) {
                        if (i > 0) doc.addPage();
                        const pageItems = items.slice(i * itemsPerPage, (i + 1) * itemsPerPage);

                        const admSpans = [];
                        let d = 0;
                        while (d < pageItems.length) {
                            let count = 1;
                            while (d + count < pageItems.length && (pageItems[d].adm || '') === (pageItems[d + count].adm || '')) count++;
                            for (let j = 0; j < count; j++) admSpans.push(j === 0 ? count : 0);
                            d += count;
                        }

                        const setorSpans = [];
                        let s = 0;
                        while (s < pageItems.length) {
                            let count = 1;
                            while (
                                s + count < pageItems.length &&
                                (pageItems[s].setor || '') === (pageItems[s + count].setor || '') &&
                                (pageItems[s].adm || '') === (pageItems[s + count].adm || '')
                            ) count++;
                            for (let j = 0; j < count; j++) setorSpans.push(j === 0 ? count : 0);
                            s += count;
                        }

                        const citySpans = [];
                        let c = 0;
                        while (c < pageItems.length) {
                            let count = 1;
                            while (
                                c + count < pageItems.length &&
                                (pageItems[c].cidade || '') === (pageItems[c + count].cidade || '') &&
                                (pageItems[c].setor || '') === (pageItems[c + count].setor || '') &&
                                (pageItems[c].adm || '') === (pageItems[c + count].adm || '')
                            ) count++;
                            for (let j = 0; j < count; j++) citySpans.push(j === 0 ? count : 0);
                            c += count;
                        }

                        doc.autoTable({
                            startY: 40,
                            theme: 'grid',
                            styles: { valign: 'middle', fontSize: 8.5, lineColor: [226, 232, 240], lineWidth: 0.25 },
                            headStyles: { fillColor: [0, 51, 102], textColor: [255, 255, 255], fontSize: 9.5, fontStyle: 'bold', halign: 'center', lineWidth: 0.1, lineColor: [255, 255, 255] },
                            alternateRowStyles: { fillColor: [248, 250, 252] },
                            margin: { top: 40, left: 15, right: 15 },
                            head: [['ADM', 'SETOR', 'CIDADE', 'LOCALIDADE']],
                            body: pageItems.map(l => [l.adm || '-', l.setor || '-', l.cidade || '-', l.localidade || '-']),
                            columnStyles: {
                                0: { cellWidth: 30, halign: 'center' },
                                1: { cellWidth: 30, halign: 'center' },
                                2: { cellWidth: 'auto', halign: 'center' },
                                3: { cellWidth: 70, halign: 'left', fontStyle: 'bold' }
                            },
                            didParseCell: (data) => {
                                if (data.section === 'body') {
                                    if (data.column.index === 0) {
                                        const span = admSpans[data.row.index];
                                        if (span > 1) data.cell.rowSpan = span;
                                        data.cell.styles.fillColor = [255, 255, 255];
                                    }
                                    if (data.column.index === 1) {
                                        const span = setorSpans[data.row.index];
                                        if (span > 1) data.cell.rowSpan = span;
                                        data.cell.styles.fillColor = [255, 255, 255];
                                    }
                                    if (data.column.index === 2) {
                                        const span = citySpans[data.row.index];
                                        if (span > 1) data.cell.rowSpan = span;
                                        data.cell.styles.fillColor = [255, 255, 255];
                                    }
                                }
                            },
                            didDrawPage: (data) => {
                                doc.setFontSize(11);
                                doc.setTextColor(0, 51, 102);
                                doc.setFont("helvetica", "bold");
                                const titleWidth = doc.getTextWidth(title);
                                doc.text(title, (pageWidth - titleWidth) / 2, 22);

                                doc.setFontSize(7);
                                doc.setTextColor(120, 120, 120);
                                doc.setFont("helvetica", "normal");
                                const subtitle = filterDesc.toUpperCase();
                                const subtitleWidth = doc.getTextWidth(subtitle);
                                doc.text(subtitle, (pageWidth - subtitleWidth) / 2, 30);

                                doc.setDrawColor(0, 51, 102);
                                doc.setLineWidth(0.5);
                                doc.line(15, 33, pageWidth - 15, 33);

                                doc.setFontSize(8);
                                doc.setTextColor(150, 150, 150);
                                const footerText = `Gerado em: ${new Date().toLocaleString('pt-BR')}  |  P√°gina ${i + 1}`;
                                const footerWidth = doc.getTextWidth(footerText);
                                doc.text(footerText, (pageWidth - footerWidth) / 2, 287);
                            }
                        });
                    }
                    doc.save(`relatorio_${window.activeReportType || 'agenda'}_${new Date().toISOString().split('T')[0]}.pdf`);
                    return;
                } else {
                    filterDesc = getFilterDescription('home');
                    const events = getFilteredEvents();

                    const head = [['Data', 'Hora', 'Evento', 'Localidade', 'Atendente']];
                    const body = events.map(e => {
                        const type = state.types.find(t => t.id === e.type_id);
                        const loc = state.locations.find(l => l.id === e.location_id);
                        const att = state.attendants.find(a => a.id === e.attendant_id);
                        const att2 = state.attendants.find(a => a.id === e.attendant2_id);

                        // Formatar exibi√ß√£o dos atendentes
                        let attendantDisplay = att?.name || '';
                        if (att2?.name) {
                            attendantDisplay = `${att?.name || ''} / ${att2.name}`;
                        }

                        return [formatDate(e.date), e.time, type?.name || '', loc?.localidade || '', attendantDisplay];
                    });

                    const dateSpans = [];
                    let d = 0;
                    while (d < events.length) {
                        let count = 1;
                        while (d + count < events.length && formatDate(events[d].date) === formatDate(events[d + count].date)) count++;
                        for (let j = 0; j < count; j++) dateSpans.push(j === 0 ? count : 0);
                        d += count;
                    }
                    const timeSpans = [];
                    let t = 0;
                    while (t < events.length) {
                        let count = 1;
                        const startsAtDateTop = (dateSpans[t] > 0);
                        while (
                            t + count < events.length &&
                            events[t].time === events[t + count].time
                        ) {
                            if (!startsAtDateTop && formatDate(events[t].date) !== formatDate(events[t + count].date)) break;
                            count++;
                        }
                        for (let j = 0; j < count; j++) timeSpans.push(j === 0 ? count : 0);
                        t += count;
                    }

                    tableConfig = {
                        head: head,
                        body: body,
                        columnStyles: {
                            0: { cellWidth: 25, halign: 'center' },
                            1: { cellWidth: 15, halign: 'center' },
                            2: { cellWidth: 'auto' },
                            3: { cellWidth: 'auto' },
                            4: { cellWidth: 'auto' }
                        },
                        didParseCell: (data) => {
                            if (data.section === 'body') {
                                if (data.column.index === 0) {
                                    const span = dateSpans[data.row.index];
                                    if (span > 1) data.cell.rowSpan = span;
                                    data.cell.styles.fillColor = [255, 255, 255];
                                }
                                if (data.column.index === 1) {
                                    const span = timeSpans[data.row.index];
                                    if (span > 1) data.cell.rowSpan = span;
                                    data.cell.styles.fillColor = [255, 255, 255];
                                }
                            }
                        }
                    };
                }

                doc.autoTable({
                    startY: 40,
                    theme: 'grid',
                    styles: { valign: 'middle', fontSize: 8.5, lineColor: [226, 232, 240], lineWidth: 0.25 },
                    headStyles: { fillColor: [0, 51, 102], textColor: [255, 255, 255], fontSize: 9.5, fontStyle: 'bold', halign: 'center', lineWidth: 0.1, lineColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [248, 250, 252] },
                    margin: { top: 40, left: 15, right: 15 },
                    ...tableConfig,
                    didDrawPage: (data) => {
                        doc.setFontSize(window.activeReportType === 'locations' ? 11 : 16);
                        doc.setTextColor(0, 51, 102);
                        doc.setFont("helvetica", "bold");
                        const titleWidth = doc.getTextWidth(title);
                        doc.text(title, (pageWidth - titleWidth) / 2, 22);

                        doc.setFontSize(7);
                        doc.setTextColor(120, 120, 120);
                        doc.setFont("helvetica", "normal");
                        const subtitle = filterDesc.toUpperCase();
                        const subtitleWidth = doc.getTextWidth(subtitle);
                        doc.text(subtitle, (pageWidth - subtitleWidth) / 2, 30);

                        doc.setDrawColor(0, 51, 102);
                        doc.setLineWidth(0.5);
                        doc.line(15, 33, pageWidth - 15, 33);

                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        const footerText = `Gerado em: ${new Date().toLocaleString('pt-BR')}  |  P√°gina ${data.pageNumber}`;
                        const footerWidth = doc.getTextWidth(footerText);
                        doc.text(footerText, (pageWidth - footerWidth) / 2, 287);
                    }
                });

                doc.save(`relatorio_${window.activeReportType || 'agenda'}_${new Date().toISOString().split('T')[0]}.pdf`);
            },
            downloadPNG: async () => {
                const pages = document.querySelectorAll('.report-page');
                if (!pages || pages.length === 0) return;

                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];

                    try {
                        // Capture the page content
                        const contentCanvas = await html2canvas(page, {
                            scale: 2,
                            useCORS: true,
                            logging: false,
                            backgroundColor: '#ffffff',
                            width: page.scrollWidth,
                            height: page.scrollHeight,
                            windowWidth: page.scrollWidth,
                            windowHeight: page.scrollHeight,
                            scrollX: 0,
                            scrollY: 0,
                            x: 0,
                            y: 0
                        });

                        // Create A4 canvas
                        const a4WidthMm = 210;
                        const a4HeightMm = 297;
                        const mmToPx = 3.7795275591;
                        const scale = 2;

                        const a4Width = Math.round(a4WidthMm * mmToPx * scale);
                        const a4Height = Math.round(a4HeightMm * mmToPx * scale);

                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = a4Width;
                        finalCanvas.height = a4Height;

                        const ctx = finalCanvas.getContext('2d');
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, a4Width, a4Height);

                        // Center content horizontally
                        const xOffset = (a4Width - contentCanvas.width) / 2;
                        const yOffset = 0;

                        ctx.drawImage(contentCanvas, xOffset, yOffset);

                        const link = document.createElement('a');
                        link.download = `relatorio_${window.activeReportType || 'agenda'}_pag_${i + 1}_${new Date().toISOString().split('T')[0]}.png`;
                        link.href = finalCanvas.toDataURL('image/png');
                        link.click();

                        await new Promise(r => setTimeout(r, 500));
                    } catch (error) {
                        console.error('Erro ao gerar PNG:', error);
                        alert('Erro ao gerar PNG da p√°gina ' + (i + 1));
                    }
                }
            },
            startCreateEvent: () => { state.editingEventId = null; state.formTempDate = new Date().toISOString().split('T')[0]; state.formTempTime = '08:00'; state.formTempLoc = ''; state.formTempType = ''; state.formTempAtt = ''; state.formTempAtt2 = ''; state.formTempIrmaos = ''; state.formTempIrmas = ''; state.formErrors = []; state.originalEventSnapshot = null; state.highlightedItemId = null; navigateTo('event-form'); },
            openEditEvent: (id) => { const ev = state.events.find((e) => String(e.id) === String(id)); if (ev) { state.editingEventId = id; state.formTempDate = ev.date; state.formTempTime = ev.time; state.formTempLoc = ev.location_id; state.formTempType = ev.type_id; state.formTempAtt = ev.attendant_id || ''; state.formTempAtt2 = ev.attendant2_id || ''; state.formTempIrmaos = ev.irmaos || ''; state.formTempIrmas = ev.irmas || ''; state.formErrors = []; state.originalEventSnapshot = JSON.parse(JSON.stringify(ev)); state.highlightedItemId = null; navigateTo('event-form'); } },
            openTimePickerModal: () => { const [h, m] = (state.formTempTime || '08:00').split(':'); state.clockTempHour = h; state.clockTempMinute = m; state.clockMode = 'hour'; showModal(''); renderClockUI(); },
            selectClockValue: (v) => { if (state.clockMode === 'hour') { state.clockTempHour = v.padStart(2, '0'); state.clockMode = 'minute'; } else state.clockTempMinute = v.padStart(2, '0'); renderClockUI(); },
            confirmClockTime: () => { state.formTempTime = `${state.clockTempHour}:${state.clockTempMinute}`; closeModal(); },
            openSelectPicker: (coll, tit, pr) => {
                const norm = (s) => (s || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toLowerCase();
                let items = [...state[coll]];
                if (coll === 'locations' && pr === 'adv_location') {
                    const af = state.advancedFilter;
                    if (af.attendant.enabled && af.attendant.id) {
                        const att = state.attendants.find(a => a.id === af.attendant.id);
                        if (att) {
                            const attName = norm(att.name);
                            items = items.filter(l => [l.anciao_1, l.anciao_2, l.anciao_3, l.diacono_1, l.diacono_2, l.diacono_3, l.com_1, l.com_2, l.cjm].some(name => name && norm(name) === attName));
                        }
                    }
                    if (af.adm.enabled && af.adm.value) items = items.filter(l => norm(l.adm) === norm(af.adm.value));
                    if (af.setor.enabled && af.setor.value) items = items.filter(l => norm(l.setor) === norm(af.setor.value));
                    if (af.cidade.enabled && af.cidade.value) items = items.filter(l => norm(l.cidade) === norm(af.cidade.value));
                }
                if (coll === 'locations' && pr === 'attendant_comum') {
                    const uniqueNames = [...new Set(items.map(l => l.localidade).filter(Boolean))].sort();
                    items = uniqueNames.map(name => ({ id: name, localidade: name }));
                }

                // Filtro de Tipos de Eventos por Localidade (Form Cadastro Evento)
                if (coll === 'types' && pr === 'formTempType' && state.formTempLoc) {
                    const loc = state.locations.find(l => String(l.id) === String(state.formTempLoc));
                    const allowed = loc?.eventos_que_pode_ter || '';
                    if (allowed && allowed !== 'Todos') {
                        const sigList = allowed.split('/').map(s => s.trim().toUpperCase());
                        items = items.filter(t => sigList.includes((t.sigla || '').toUpperCase()));
                    }
                }

                if (coll === 'attendants') {
                    let quemAtende = '';
                    if ((pr === 'formTempAtt' || pr === 'formTempAtt2') && state.formTempType) {
                        const selType = state.types.find(t => t.id === state.formTempType);
                        quemAtende = selType?.quem_atende || '';
                    } else if (pr === 'adv_attendant' && state.advancedFilter.type.enabled && state.advancedFilter.type.id) {
                        const selType = state.types.find(t => t.id === state.advancedFilter.type.id);
                        quemAtende = selType?.quem_atende || '';
                    }

                    if (quemAtende.trim()) {
                        const allowedList = quemAtende.toLowerCase().split(/[,;/]+/).map(s => s.trim()).filter(Boolean);
                        items = items.filter(a => {
                            const minA = (a.ministerio || '').toLowerCase().trim();
                            return allowedList.some(allow => minA.includes(allow));
                        });
                    }
                }
                const isA = pr.startsWith('adv_');
                const target = isA ? pr.replace('adv_', '') : pr;
                const currentVal = target === 'attendant_comum' ? document.getElementById('row-comum')?.value : '';
                showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${tit}</h3></div><button onclick="${isA ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="px-5 py-4"><div class="relative group"><input id="pickerSearch" type="text" placeholder="Filtrar..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium"><i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i></div></div><div id="pickerItemsList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none"></div></div>`);
                const listEl = document.getElementById('pickerItemsList');
                if (listEl) listEl.innerHTML = renderPickerItems(items, coll, isA, target, pr, currentVal);
                document.getElementById('pickerSearch')?.addEventListener('input', (e) => {
                    const term = (e.target.value || '').toLowerCase();
                    const filtered = items.filter((i) => {
                        let match = ((coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '').toLowerCase().includes(term);
                        if (coll === 'locations' && pr !== 'attendant_comum') {
                            const attendantsStr = [i.anciao_1, i.anciao_2, i.anciao_3, i.diacono_1, i.diacono_2, i.diacono_3, i.com_1, i.com_2, i.cjm].filter(Boolean).join(' ').toLowerCase();
                            if (attendantsStr.includes(term)) match = true;
                        }
                        if (coll === 'types') {
                            return match || (i.sigla || '').toLowerCase().includes(term);
                        }
                        return match;
                    });
                    if (listEl) listEl.innerHTML = renderPickerItems(filtered, coll, isA, target, pr, currentVal);
                    renderIcons();
                });
                renderIcons();
            },
            saveEvent: async () => {
                console.log("[saveEvent] Bot√£o Salvar clicado.");
                const btn = document.querySelector('button[onclick="window.saveEvent()"]');
                if (btn) { btn.disabled = true; btn.innerText = "Salvando..."; }
                try {
                    const errs = [];
                    if (!state.formTempDate) errs.push('date');
                    if (!state.formTempLoc) errs.push('loc');
                    if (!state.formTempType) errs.push('type');
                    if (errs.length > 0) { state.formErrors = errs; return; }
                    const eventData = { date: state.formTempDate, time: state.formTempTime, location_id: state.formTempLoc, type_id: state.formTempType, attendant_id: state.formTempAtt || null, attendant2_id: state.formTempAtt2 || null, irmaos: parseInt(document.getElementById('event-irmaos')?.value || '0'), irmas: parseInt(document.getElementById('event-irmas')?.value || '0') };
                    const duplicate = state.events.find(e => e.date === eventData.date && e.time === eventData.time && e.location_id === eventData.location_id && e.type_id === eventData.type_id && String(e.id) !== String(state.editingEventId));
                    if (duplicate) { showEventDuplicateModal(duplicate); return; }
                    const action = state.editingEventId ? 'UPDATE' : 'INSERT';
                    await window.smartSave('agenda', action, eventData, state.editingEventId, () => {
                        window.navigateTo('home');
                        state.editingEventId = null;
                    });
                } catch (e) {
                    alert("Erro inesperado: " + e.message);
                } finally {
                    if (btn) { btn.disabled = false; btn.innerText = `SALVAR EVENTO ${!navigator.onLine ? '(OFFLINE)' : ''}`; }
                    if (state.formErrors && state.formErrors.length > 0) scheduleRender();
                }
            },
            requestDeleteEvent: (id) => { const ev = state.events.find((e) => String(e.id) === String(id)); const type = state.types.find((t) => t.id === ev?.type_id); const loc = state.locations.find((l) => l.id === ev?.location_id); showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[8px] border-red-500"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mb-5"><i data-lucide="alert-triangle" class="text-red-500 w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3">Excluir?</h3><p class="text-sm text-slate-500 mb-8 px-2">Deseja excluir este evento?<br><strong class="text-slate-700">${type?.name || ''} em ${loc?.localidade || ''}</strong></p><div class="w-full flex gap-3"><button onclick="window.closeModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-sm">N√£o</button><button onclick="window.confirmarEDeletar('${id}')" class="flex-1 bg-red-600 py-3 rounded-xl font-black uppercase text-sm">Sim</button></div></div></div>`); },
            confirmarEDeletar,
            locateDuplicate: (id, coll) => { const targetScreen = coll === 'agenda' ? 'home' : (coll === 'perfis' ? 'users' : coll); closeModal(); navigateTo(targetScreen); state.managerSearchTerm = ''; state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; state.highlightedItemId = id; if (targetScreen === 'home') window.updateHomeList(); else if (window.updateManagerListUI) window.updateManagerListUI(coll); },
            showExitConfirmation: () => {
                showModal(`
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] overflow-hidden border-t-8 border-navy/10">
                        <div class="p-8 flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 text-navy">
                                <i data-lucide="log-out" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3">Sair do App?</h3>
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">Voc√™ deseja realmente encerrar sua sess√£o e sair do aplicativo agora?</p>
                            <div class="w-full flex flex-col gap-3">
                                <button onclick="window.closeModal()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Continuar no App</button>
                                <button onclick="window.handleLogout()" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Sim, Sair</button>
                            </div>
                        </div>
                    </div>
                `);
            },
            showInstallPromptModal: () => {
                showModal(`
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] overflow-hidden border-t-8 border-orange-custom">
                        <div class="p-8 flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6 text-orange-custom">
                                <i data-lucide="calendar" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3">Agenda CCB</h3>
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">Deseja instalar a Agenda?</p>
                            <div class="w-full flex flex-col gap-3">
                                <button onclick="window.confirmInstall()" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Sim, instalar</button>
                                <button onclick="window.rejectInstall()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">N√£o</button>
                            </div>
                        </div>
                    </div>
                `);
            },
            showInstallingStatusModal: () => {
                showModal(`
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] overflow-hidden border-t-8 border-navy">
                        <div class="p-8 flex flex-col items-center text-center">
                            <div class="loading-spinner mb-6"></div>
                            <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3">Agenda CCB</h3>
                            <p class="text-sm font-medium text-slate-500 mb-4 leading-relaxed">Instalando...</p>
                        </div>
                    </div>
                `);
            },
            confirmInstall: async () => {
                const promptEvent = window.deferredPrompt;
                if (promptEvent) {
                    await promptEvent.prompt();
                    const { outcome } = await promptEvent.userChoice;

                    if (outcome === 'accepted') {
                        window.showInstallingStatusModal();
                    } else {
                        closeModal();
                    }
                    window.deferredPrompt = null;
                } else {
                    closeModal();
                }
            },
            rejectInstall: () => {
                closeModal();
                window.close();
                setTimeout(() => {
                    document.body.innerHTML = "";
                    window.location.href = "about:blank";
                }, 100);
            },
            scrollToAdvSection: (sec) => {
                setTimeout(() => {
                    const el = document.getElementById(`adv-sec-${sec}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 50);
            },
            openLocationStaffPicker: (coll, id, fieldId, title, requiredMinistry = '') => {
                // Salvar a posi√ß√£o de rolagem atual antes de abrir o picker
                const scrollContainer = document.querySelector('.overflow-y-auto.scrollbar-none');
                const scrollPosition = scrollContainer ? scrollContainer.scrollTop : 0;

                const currentVals = {
                    id: id,
                    adm: document.getElementById('loc-adm')?.value,
                    setor: document.getElementById('loc-setor')?.value,
                    cidade: document.getElementById('loc-cidade')?.value,
                    localidade: document.getElementById('row-name')?.value,
                    anciao_1: document.getElementById('loc-anciao-1')?.value,
                    anciao_2: document.getElementById('loc-anciao-2')?.value,
                    anciao_3: document.getElementById('loc-anciao-3')?.value,
                    diacono_1: document.getElementById('loc-diacono-1')?.value,
                    diacono_2: document.getElementById('loc-diacono-2')?.value,
                    diacono_3: document.getElementById('loc-diacono-3')?.value,
                    com_1: document.getElementById('loc-com-1')?.value,
                    com_2: document.getElementById('loc-com-2')?.value,
                    cjm: document.getElementById('loc-cjm')?.value,
                };
                window.__location_modal_cache = { coll, id, item: currentVals, scrollPosition };

                let items = [...state.attendants];
                if (requiredMinistry) {
                    items = items.filter(a => (a.ministerio || '').toLowerCase() === requiredMinistry.toLowerCase());
                }

                showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${title}</h3></div><button onclick="window.openRowModal('locations', '${id}', window.__location_modal_cache.item)" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="px-5 py-4 shrink-0"><div class="relative group"><input id="pickerSearch" type="text" placeholder="Filtrar..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium"><i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i></div></div><div id="pickerItemsList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none"></div></div>`);

                const renderItems = (list) => {
                    const sorted = [...list].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    return `<button onclick="window.handleLocationStaffSelection('${fieldId}', '')" class="w-full p-4 text-left font-semibold text-red-500 hover:bg-red-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-red-100"><span class="font-bold text-sm leading-tight italic">Limpar Sele√ß√£o</span></button>` +
                        sorted.map((i) => {
                            const isS = currentVals[fieldId.replace('loc-', '').replace(/-/g, '_')] === i.name;
                            return `<button onclick="window.handleLocationStaffSelection('${fieldId}', '${i.name.replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="group-hover:text-navy transition-colors font-bold text-sm leading-tight">${i.name}</span>${isS ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0 ml-2"></i>' : ''}</button>`;
                        }).join('');
                };

                const listEl = document.getElementById('pickerItemsList');
                if (listEl) listEl.innerHTML = renderItems(items);

                document.getElementById('pickerSearch')?.addEventListener('input', (e) => {
                    const term = (e.target.value || '').toLowerCase();
                    const filtered = items.filter((i) => (i.name || '').toLowerCase().includes(term));
                    document.getElementById('pickerItemsList').innerHTML = renderItems(filtered);
                    renderIcons();
                });
                renderIcons();
            },
            handleLocationStaffSelection: (fieldId, name) => {
                const cache = window.__location_modal_cache;
                cache.item[fieldId.replace('loc-', '').replace(/-/g, '_')] = name;
                // Salvar o fieldId para fazer scroll ap√≥s recriar o modal
                cache.lastFieldId = fieldId;
                window.openRowModal('locations', cache.id, cache.item);

                // Fazer scroll at√© o campo que foi alterado para mant√™-lo vis√≠vel
                setTimeout(() => {
                    const fieldElement = document.getElementById(fieldId);
                    // O input est√° dentro de um bot√£o, ent√£o pegamos o bot√£o pai para scroll
                    const targetElement = fieldElement?.closest('button') || fieldElement?.parentElement;
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 150);
            },
            openPermissionPicker: (coll, id, currentVal) => {
                const options = [
                    { value: 'leitura', label: 'Somente Leitura' },
                    { value: 'admin', label: 'Administrador' }
                ];
                const auth = document.getElementById('user-authorized')?.checked;
                const nome = state.perfis.find(p => String(p.id) === String(id))?.nome || '';
                window.__user_modal_cache = { coll, id, item: { autorizado: auth, permissao: currentVal, nome: nome } };

                showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0"><div class="flex items-center gap-3 text-navy"><i data-lucide="shield-check" class="w-5 h-5"></i><h3 class="font-bold text-lg">N√≠vel de Acesso</h3></div><button onclick="window.closePermissionPicker()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-2 flex flex-col">
                    ${options.map(o => `
                        <button onclick="window.handlePermissionSelection('${o.value}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                            <span class="font-bold text-sm text-navy">${o.label}</span>
                            ${currentVal === o.value ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                        </button>
                    `).join('')}
                </div></div>`);
                renderIcons();
            },
            handlePermissionSelection: (val) => {
                const cache = window.__user_modal_cache;
                cache.item.permissao = val;
                window.openRowModal('perfis', cache.id, cache.item);
            },
            closePermissionPicker: () => {
                const cache = window.__user_modal_cache;
                window.openRowModal('perfis', cache.id, cache.item);
            },
            openAttendantMinistryPicker: (id) => {
                const name = document.getElementById('row-name')?.value.trim();
                const currentMin = document.getElementById('row-extra')?.value;
                const currentComum = document.getElementById('row-comum')?.value;
                window.__attendant_modal_cache = { id, item: { name: name, ministerio: currentMin, comum: currentComum } };

                const options = ['Anci√£o', 'Di√°cono', 'Coop. Oficial', 'Coop. Jovens', 'Enc. Regional'];
                showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0"><div class="flex items-center gap-3 text-navy"><i data-lucide="shield-check" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar Minist√©rio</h3></div><button onclick="window.closeAttendantMinistryPicker()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-2 flex flex-col">
                    ${options.map(o => `
                        <button onclick="window.handleAttendantMinistrySelection('${o}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                            <span class="font-bold text-sm text-navy">${o}</span>
                            ${currentMin === o ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                        </button>
                    `).join('')}
                </div></div>`);
                renderIcons();
            },
            handleAttendantMinistrySelection: (val) => {
                const cache = window.__attendant_modal_cache;
                cache.item.ministerio = val;
                window.openRowModal('attendants', cache.id, cache.item);
            },
            closeAttendantMinistryPicker: () => {
                const cache = window.__attendant_modal_cache;
                window.openRowModal('attendants', cache.id, cache.item);
            },
            openAttendantComumPicker: (id) => {
                const name = document.getElementById('row-name')?.value.trim();
                const currentMin = document.getElementById('row-extra')?.value;
                const currentComum = document.getElementById('row-comum')?.value;
                window.__attendant_modal_cache = { id, item: { name: name, ministerio: currentMin, comum: currentComum } };
                window.openSelectPicker('locations', 'Comum', 'attendant_comum');
            },
            handleAttendantComumSelection: (val) => {
                const cache = window.__attendant_modal_cache;
                cache.item.comum = val;
                window.openRowModal('attendants', cache.id, cache.item);
            },
            closeAttendantComumPicker: () => {
                const cache = window.__attendant_modal_cache;
                window.openRowModal('attendants', cache.id, cache.item);
            },
            openQuemAtendePicker: (id) => {
                const name = document.getElementById('row-name')?.value.trim();
                const sigla = document.getElementById('row-extra')?.value.trim();
                const currentVal = document.getElementById('row-quem-atende')?.value || '';
                window.__type_modal_cache = { id, item: { name, sigla, quem_atende: currentVal } };

                const allOptions = ['Anci√£o', 'Di√°cono', 'Coop. Oficial', 'Coop. Jovens', 'Enc. Regional'];
                const selected = currentVal.split(/[/]+/).map(s => s.trim()).filter(Boolean);
                const options = allOptions.filter(o => !selected.includes(o));

                showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0"><div class="flex items-center gap-3 text-navy"><i data-lucide="users" class="w-5 h-5"></i><h3 class="font-bold text-lg">Quem Atende</h3></div><button onclick="window.closeQuemAtendePicker()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-2 flex flex-col">
                    ${options.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Todas as op√ß√µes j√° selecionadas.</div>' : options.map(o => `
                        <button onclick="window.handleQuemAtendeSelection('${o}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                            <span class="font-bold text-sm text-navy">${o}</span>
                            <i data-lucide="plus" class="w-4 h-4 text-slate-300 group-hover:text-navy"></i>
                        </button>
                    `).join('')}
                    ${selected.length > 0 ? `<button onclick="window.handleQuemAtendeSelection('', true)" class="w-full p-4 text-left font-bold text-red-500 hover:bg-red-50 transition-colors flex items-center gap-2 mt-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Limpar Sele√ß√£o</button>` : ''}
                </div></div>`);
                renderIcons();
            },
            handleQuemAtendeSelection: (val, clear = false) => {
                const cache = window.__type_modal_cache;
                if (!cache) return; // Case where clear button on main modal is clicked without cache

                if (clear) {
                    cache.item.quem_atende = '';
                } else {
                    const current = cache.item.quem_atende || '';
                    cache.item.quem_atende = current ? `${current}/${val}` : val;
                }
                window.openRowModal('types', cache.id, cache.item);
            },
            closeQuemAtendePicker: () => {
                const cache = window.__type_modal_cache;
                window.openRowModal('types', cache.id, cache.item);
            },
            openEventosPossiveisPicker: (id) => {
                // Verificar se j√° existe cache (ao reabrir o modal)
                let currentVal = '';
                if (window.__location_modal_cache && window.__location_modal_cache.id === id) {
                    // Usar valor do cache (j√° atualizado pelas sele√ß√µes)
                    currentVal = window.__location_modal_cache.item.eventos_que_pode_ter || '';
                } else {
                    // Primeira vez abrindo - capturar valores atuais do formul√°rio
                    const adm = document.getElementById('loc-adm')?.value || '';
                    const setor = document.getElementById('loc-setor')?.value || '';
                    const cidade = document.getElementById('loc-cidade')?.value || '';
                    const localidade = document.getElementById('row-name')?.value || '';
                    currentVal = document.getElementById('loc-eventos-possiveis')?.value || '';

                    // Salvar no cache
                    window.__location_modal_cache = {
                        id,
                        item: {
                            adm, setor, cidade, localidade,
                            eventos_que_pode_ter: currentVal,
                            anciao_1: document.getElementById('loc-anciao-1')?.value || '',
                            anciao_2: document.getElementById('loc-anciao-2')?.value || '',
                            anciao_3: document.getElementById('loc-anciao-3')?.value || '',
                            diacono_1: document.getElementById('loc-diacono-1')?.value || '',
                            diacono_2: document.getElementById('loc-diacono-2')?.value || '',
                            diacono_3: document.getElementById('loc-diacono-3')?.value || '',
                            com_1: document.getElementById('loc-com-1')?.value || '',
                            com_2: document.getElementById('loc-com-2')?.value || '',
                            cjm: document.getElementById('loc-cjm')?.value || ''
                        }
                    };
                }

                // Obter lista de tipos de eventos
                const tipos = [...state.types].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                // Verificar quais siglas j√° est√£o selecionadas
                const selectedSiglas = currentVal === 'Todos' ? ['Todos'] : (currentVal ? currentVal.split('/').map(s => s.trim()) : []);

                showModal(`
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
                        <div class="p-5 flex justify-between items-center bg-white border-b border-slate-50 shrink-0">
                            <div class="flex items-center gap-3 text-navy">
                                <i data-lucide="calendar-check" class="w-5 h-5"></i>
                                <h3 class="font-bold text-lg">Eventos Poss√≠veis</h3>
                            </div>
                            <button onclick="window.returnToLocationModal()" class="text-slate-400 p-1">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto scrollbar-none">
                            <!-- Op√ß√£o "Todos" -->
                            <button onclick="window.handleEventosPossiveisSelection('Todos', 'Todos')" 
                                    class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                                <div class="flex flex-col">
                                    <span class="font-bold text-sm text-navy">Todos os Eventos</span>
                                    <span class="text-[10px] text-slate-400 font-medium">Permite todos os tipos</span>
                                </div>
                                ${selectedSiglas.includes('Todos') ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                            </button>
                            
                            <!-- Lista de tipos de eventos -->
                            ${tipos.map(tipo => `
                                <button onclick="window.handleEventosPossiveisSelection('${tipo.sigla}', '${tipo.name.replace(/'/g, "\\'")}')" 
                                        class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-sm text-navy">${tipo.name}</span>
                                        <span class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">${tipo.sigla}</span>
                                    </div>
                                    ${selectedSiglas.includes(tipo.sigla) ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom"></i>' : ''}
                                </button>
                            `).join('')}
                        </div>
                        
                        <div class="p-4 border-t border-slate-50 flex gap-3 shrink-0">
                            <button onclick="window.handleEventosPossiveisSelection('', 'limpar')" 
                                    class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs uppercase tracking-widest active:scale-95 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpar
                            </button>
                            <button onclick="window.returnToLocationModal()" 
                                    class="flex-1 bg-navy text-white py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i> Concluir
                            </button>
                        </div>
                    </div>
                `);
                renderIcons();
            },
            handleEventosPossiveisSelection: (sigla, action) => {
                const cache = window.__location_modal_cache;
                let currentVal = cache.item.eventos_que_pode_ter || '';

                if (action === 'limpar') {
                    // Limpar tudo
                    cache.item.eventos_que_pode_ter = '';
                } else if (sigla === 'Todos') {
                    // Selecionar "Todos" (sobrescreve tudo)
                    cache.item.eventos_que_pode_ter = 'Todos';
                } else {
                    // Toggle de sigla individual
                    const siglas = currentVal === 'Todos' ? [] : (currentVal ? currentVal.split('/').map(s => s.trim()) : []);

                    if (siglas.includes(sigla)) {
                        // Remover sigla
                        const newSiglas = siglas.filter(s => s !== sigla);
                        cache.item.eventos_que_pode_ter = newSiglas.join('/');
                    } else {
                        // Adicionar sigla
                        siglas.push(sigla);
                        cache.item.eventos_que_pode_ter = siglas.join('/');
                    }
                }

                // Reabrir o modal de eventos poss√≠veis para mostrar a atualiza√ß√£o
                window.openEventosPossiveisPicker(cache.id);
            },
            returnToLocationModal: () => {
                const cache = window.__location_modal_cache;
                window.openRowModal('locations', cache.id, cache.item);
            },
        });

        function loadCachedData() {
            const tablesToCache = ['types', 'locations', 'attendants', 'agenda', 'feriados', 'perfis'];
            let hasInitialData = false;
            tablesToCache.forEach(table => {
                const cachedData = localStorage.getItem(`cache_${table}`);
                if (cachedData) {
                    const key = table === 'agenda' ? 'events' : table;
                    state[key] = JSON.parse(cachedData);
                    hasInitialData = true;
                }
            });
            return hasInitialData;
        }

        async function init() {
            let hasInitialData = loadCachedData();

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.user = session.user;
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();

                const cachedProfile = getCachedProfile();
                if (isMasterAdmin || cachedProfile.isAuthorized) {
                    state.isAdmin = isMasterAdmin || cachedProfile.isAdmin;
                    state.isAuthorized = isMasterAdmin || cachedProfile.isAuthorized;
                }

                if (state.isAuthorized && hasInitialData) {
                    state.isLoading = false;
                }

                if (navigator.onLine) {
                    try {
                        const { data: profile, error } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        if (!error && profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);

                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({
                                isAdmin: state.isAdmin,
                                isAuthorized: state.isAuthorized
                            }));
                        }
                    } catch (e) { }
                    if (state.isAuthorized) await refreshAllData();
                }
            }

            state.isLoading = false;

            window.history.replaceState({ screen: 'home' }, "");
            window.addEventListener('popstate', (event) => {
                if (state.isMenuOpen) { state.isMenuOpen = false; return; }
                const modal = document.getElementById('modal-container');
                if (modal && !modal.classList.contains('hidden')) {
                    closeModal();
                    if (state.currentScreen === 'home') window.history.pushState({ screen: 'home' }, "");
                    return;
                }
                if (event.state && event.state.screen) navigateTo(event.state.screen, false);
                else {
                    if (state.currentScreen === 'home') { window.showExitConfirmation(); window.history.pushState({ screen: 'home' }, ""); }
                    else navigateTo('home', false);
                }
            });

            window.addEventListener('offline', () => { showConnStatus('offline'); });
            window.addEventListener('online', () => processOfflineQueue(true));

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'TOKEN_REFRESHED' && session) {
                    state.user = session.user;
                    console.log("Token refreshed");
                    return;
                }

                if (event === 'SIGNED_OUT' || !session) {
                    cleanupListeners();
                    state.user = null; state.isAuthorized = false; state.isAdmin = false; state.currentScreen = 'home';
                    localStorage.removeItem(USER_PROFILE_CACHE_KEY); scheduleRender(); return;
                }

                state.user = session?.user || null;
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();

                if (session?.user && navigator.onLine) {
                    try {
                        const { data: profile } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        if (profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);
                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({ isAdmin: state.isAdmin, isAuthorized: state.isAuthorized }));
                        }
                    } catch (e) { }
                }

                if (state.isAuthorized) {
                    await refreshAllData();
                    setupAllListeners();
                }
                if (event === 'SIGNED_IN') closeModal();
                scheduleRender();
            });

            if (state.isAuthorized) {
                setupAllListeners();
            }

            loadExternalHolidays(new Date().getFullYear());



            // Tenta sincronizar pend√™ncias logo ao abrir o app
            if (navigator.onLine) processOfflineQueue(true);
        }

        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); window.deferredPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches) window.showInstallPromptModal();
        });

        window.addEventListener('appinstalled', (evt) => {
            setTimeout(() => { closeModal(); showLoginModal(true); }, 8000);
        });

        // Removida fun√ß√£o visibilitychange duplicada que causava recarregamentos prematuros no mobile
        // A fun√ß√£o principal est√° nas linhas 358-405 e j√° gerencia sess√£o e Realtime corretamente

        init();
    </script>

</body>

</html>
