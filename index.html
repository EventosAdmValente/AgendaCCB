
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda CCB</title>
    <meta name="description" content="Agenda CCB">
    <meta name="theme-color" content="#003366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Agenda CCB">
    <meta name="mobile-web-app-capable" content="yes">
    
    
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    
    <!-- PDF & Image Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        html, body, * { -ms-overflow-style: none; scrollbar-width: none; }
        .bg-navy { background-color: #003366; } .text-navy { color: #003366; } .border-navy { border-color: #003366; }
        .bg-orange-custom { background-color: #FF8C00; } .text-orange-custom { color: #FF8C00; } .border-orange-custom { border-color: #FF8C00; }
        input:focus, select:focus, textarea:focus { outline: none; }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 30px white inset !important; }
        .disabled-area { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; border-width: 2px !important; }

        .loading-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; width: 100vw; background-color: #f1f5f9; position: fixed; top: 0; left: 0; z-index: 50;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #003366; border-top-color: transparent;
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text { font-size: 0.875rem; font-weight: 600; color: #94a3b8; }

        #report-capture-area { width: 794px; min-height: 1123px; background: white; padding: 50px; box-sizing: border-box; display: flex; flex-direction: column; transform-origin: top center; }
        .highlight-item { background-color: #fef3c7 !important; border-left: 4px solid #f59e0b !important; }

        /* Status Conexão */
        #conn-status {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; transition: all 0.3s ease; pointer-events: none;
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            border-radius: 99px; font-size: 10px; font-weight: 800; text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; visibility: hidden;
        }
        #conn-status.offline { background: #ef4444; color: white; opacity: 1; visibility: visible; }
        #conn-status.online-recovered { background: #10b981; color: white; opacity: 1; visibility: visible; }
    </style>
    <link rel="manifest" href="./manifest.json">
</head>
<body class="h-screen w-full flex flex-col bg-slate-100">

    <!-- App Root -->
    <div id="app" class="flex-1 w-full h-full relative overflow-hidden flex flex-col">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <span class="loading-text">Carregando Agenda...</span>
        </div>
    </div>

    <!-- Connection Status Toast -->
    <div id="conn-status"></div>

    <!-- Modals Overlay -->
    <div id="modal-container" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm"></div>

    <!-- Template: Login Modal -->
    <template id="login-modal-template">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 id="modal-login-title" class="font-bold text-lg text-navy uppercase tracking-tight">Área Administrativa</h3>
                <button type="button" onclick="window.closeModal()" class="text-slate-400 p-1 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="login-form" class="p-6 flex flex-col gap-4">
                <div id="name-field" class="hidden">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Nome Completo</label>
                    <input type="text" id="login-name" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10" placeholder="Seu nome">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10" placeholder="exemplo@email.com" required>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-navy/10" placeholder="••••••••" required>
                </div>
                <div id="login-error" class="text-red-500 text-[11px] hidden font-bold bg-red-50 p-2 rounded-lg border border-red-100"></div>
                <button type="submit" id="login-submit-btn" class="w-full py-4 rounded-xl bg-navy text-white font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Entrar</button>
                <div class="text-center pt-2">
                    <button type="button" id="toggle-auth-mode" class="text-[11px] font-bold text-slate-500 hover:text-navy uppercase tracking-tight underline">Não tem conta? Cadastre-se</button>
                </div>
            </form>
        </div>
    </template>

    <!-- Main Logic -->
    <script type="module">
        /**
         * ==========================================
         * 1. CONFIGURAÇÃO DO SUPABASE
         * ==========================================
         */
        const SUPABASE_URL = "https://gcsvapoqpbrrqubxawkd.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdjc3ZhcG9xcGJycnF1Ynhhd2tkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTgyMzYsImV4cCI6MjA4MDQ3NDIzNn0.QtIldObznGEYTXyEf0MS4mIgIDgbMKmS0M2FBVInTZQ";
        const ADMIN_EMAIL = "eventosadmvalente@gmail.com"; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        /**
         * Tradução de erros de autenticação do Supabase
         */
        function translateAuthError(message) {
            const msg = message.toLowerCase();
            if (msg.includes('invalid login credentials')) return "E-mail ou senha incorretos.";
            if (msg.includes('user already registered')) return "Este e-mail já está cadastrado no sistema.";
            if (msg.includes('password should be at least 6 characters')) return "A senha deve ter pelo menos 6 caracteres.";
            if (msg.includes('signup requires a valid email')) return "Por favor, insira um endereço de e-mail válido.";
            if (msg.includes('email not confirmed')) return "E-mail ainda não confirmado. Verifique sua caixa de entrada.";
            if (msg.includes('invalid email or password')) return "E-mail ou senha inválidos.";
            return message; // Retorna original caso não mapeado
        }

        /**
         * ==========================================
         * LÓGICA DE PERSISTÊNCIA OFFLINE
         * ==========================================
         */
            const SYNC_QUEUE_KEY = 'adm_valente_sync_queue';
            const USER_PROFILE_CACHE_KEY = 'cache_user_profile';

            async function processOfflineQueue() {
                if (!navigator.onLine) return;
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                if (queue.length === 0) return;

                console.log(`[Offline Sync] Sincronizando ${queue.length} itens...`);
                state.isLoading = true;

                for (const item of queue) {
                    try {
                        const { table, action, data, id } = item;
                        if (action === 'INSERT') await supabaseClient.from(table).insert(data);
                        if (action === 'UPDATE') await supabaseClient.from(table).update(data).eq('id', id);
                        if (action === 'DELETE') await supabaseClient.from(table).delete().eq('id', id);
                    } catch (err) {
                        console.error("Erro ao sincronizar item da fila:", err);
                    }
                }

                localStorage.removeItem(SYNC_QUEUE_KEY);
                await refreshAllData();
                state.isLoading = false;
                showConnStatus('online-recovered');
            }

            window.smartSave = async (table, action, data, id = null) => {
                if (!navigator.onLine) {
                    const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                    queue.push({ table, action, data, id, timestamp: Date.now() });
                    localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));
                    showConnStatus('offline');
                    return { success: true, offline: true };
                }
                try {
                    let res;
                    if (action === 'INSERT') res = await supabaseClient.from(table).insert(data);
                    if (action === 'UPDATE') res = await supabaseClient.from(table).update(data).eq('id', id);
                    if (res && res.error) throw res.error;
                    return { success: true, offline: false };
                } catch (err) {
                    console.error("Erro no smartSave:", err);
                    return { success: false, error: err.message };
                }
            };

            window.addEventListener('online', processOfflineQueue);
        
        /**
         * ==========================================
         * 2. ESTADO GLOBAL (STATE)
         * ==========================================
         */
        const getCachedProfile = () => {
            try {
                const p = localStorage.getItem(USER_PROFILE_CACHE_KEY);
                return p ? JSON.parse(p) : { isAdmin: false, isAuthorized: false };
            } catch(e) { return { isAdmin: false, isAuthorized: false }; }
        };
        const initialProfile = getCachedProfile();

        const INITIAL_STATE = {
            user: null, 
            isAdmin: initialProfile.isAdmin || false, 
            isAuthorized: initialProfile.isAuthorized || false,
            currentScreen: 'home',
            events: [], 
            types: [], 
            locations: [], 
            attendants: [],
            feriados: [],
            perfis: [],
            externalHolidays: [], 
            fetchedYears: new Set(), 
            isMenuOpen: false, 
            editingEventId: null,
            searchTerm: '', 
            managerSearchTerm: '', 
            highlightedItemId: null, 
            fastFilter: { active: false, dateStart: '', dateEnd: '', label: '' },
            ffTemp: { 
                selected: 'today',
                baseDates: {
                    today: new Date(),
                    week: new Date(),
                    month: new Date(),
                    year: new Date()
                }
            },
            selectedDate: null, 
            viewDate: new Date(),
            formTempDate: '', formTempTime: '08:00', formTempLoc: '', formTempType: '', formTempAtt: '',
            formTempIrmaos: '', formTempIrmas: '',
            isLoading: true,
            advancedFilter: {
                active: false,
                eventos: { enabled: false, status: 'ativos' }, 
                type: { enabled: false, id: '' },
                location: { enabled: false, id: '' },
                attendant: { enabled: false, id: '' },
                adm: { enabled: false, value: '' },
                setor: { enabled: false, value: '' },
                cidade: { enabled: false, value: '' },
                period: { enabled: false, start: '', end: '' },
                validationErrors: []
            },
            formErrors: [], 
            clockMode: 'hour', 
            clockTempHour: '08',
            clockTempMinute: '00'
        };

        const state = new Proxy(INITIAL_STATE, {
            set(target, property, value) {
                if (target[property] === value) return true;
                target[property] = value;
                
                const silent = ['searchTerm', 'managerSearchTerm', 'clockMode', 'clockTempHour', 'clockTempMinute', 'ffTemp', 'fetchedYears', 'formErrors'];
                if (!silent.includes(property)) {
                    scheduleRender();
                }
                
                if (property === 'searchTerm' && window.updateHomeList) {
                    window.updateHomeList();
                }

                if (property === 'currentScreen' && value === 'home') {
                    if (!state.highlightedItemId) state.highlightedItemId = null;
                }

                if (['clockMode', 'clockTempHour', 'clockTempMinute'].includes(property)) {
                    if (typeof window.renderClockUI === 'function') window.renderClockUI();
                }

                return true;
            }
        });

        window.state = state;

        /**
         * ==========================================
         * 3. FERIADOS EXTERNOS (API BRASIL + BAHIA)
         * ==========================================
         */

        async function loadExternalHolidays(year) {
            if (state.fetchedYears.has(year)) return;

            try {
                const response = await fetch(`https://brasilapi.com.br/api/feriados/v1/${year}`);
                if (!response.ok) throw new Error("Erro API");
                const holidays = await response.json();
                
                const dateBA = `${year}-07-02`;
                if (!holidays.some((h) => h.date === dateBA)) {
                    holidays.push({ date: dateBA, name: "Independência da Bahia", type: "state" });
                }

                state.externalHolidays = [...state.externalHolidays, ...holidays];
                state.fetchedYears.add(year);
                scheduleRender();
            } catch (e) {
                console.error("Não foi possível carregar feriados externos para", year);
            }
        }

        /**
         * ==========================================
         * 4. RENDERIZAÇÃO E NAVEGAÇÃO
         * ==========================================
         */

        let renderTimer = null;
        function scheduleRender() {
            if (renderTimer) return;
            renderTimer = window.requestAnimationFrame(() => {
                renderApp();
                renderTimer = null;
            });
        }

        const formatDate = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0].slice(2)}`; };
        const formatDateFull = (dateStr) => { if (!dateStr) return ''; const parts = dateStr.split('-'); return `${parts[2]}/${parts[1]}/${parts[0]}`; };
        const isEventPast = (date, time) => { return new Date(`${date}T${time}`) < new Date(); };

        function renderIcons() { if (window.lucide) window.lucide.createIcons(); }

        function renderApp() {
            const app = document.getElementById('app');
            if (!app) return;

            if (state.isLoading) {
                app.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><span class="loading-text">Conectando ao Supabase...</span></div>`;
                return;
            }

            switch (state.currentScreen) {
                case 'home': renderHome(); break; 
                case 'event-form': renderEventForm(); break; 
                case 'types': renderGenericManager('Tipos de Eventos', 'types'); break; 
                case 'locations': renderGenericManager('Cidades / Localidades', 'locations'); break; 
                case 'attendants': renderGenericManager('Atendentes', 'attendants'); break; 
                case 'feriados': renderGenericManager('Feriados', 'feriados'); break;
                case 'users': renderGenericManager('Gestão de Usuários', 'perfis'); break;
                case 'about': renderAbout(); break;
            }
            renderIcons();
        }

        function renderHome() {
            const app = document.getElementById('app');
            if (!app) return;

            // CASO 1: Usuário não logado
            if (!state.user) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <div class="w-7 h-7"></div>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-blue-50 text-navy rounded-3xl flex items-center justify-center border border-blue-100 shadow-sm"><i data-lucide="lock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Acesso Restrito</h2>
                                <p class="text-sm text-slate-500 mt-2">Faça login para visualizar a agenda administrativa.</p>
                            </div>
                            <button onclick="window.showLoginModal()" class="bg-navy text-white px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all">Fazer Login</button>
                        </div>
                    </div>
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            // CASO 2: Usuário logado mas NÃO autorizado
            if (!state.isAuthorized) {
                app.innerHTML = `
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                            <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                            <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                            <button onclick="window.handleLogout()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="log-out" class="w-6 h-6"></i></button>
                        </div>
                        <div class="flex-1 flex flex-col items-center justify-center p-8 text-center gap-6">
                            <div class="w-20 h-20 bg-orange-50 text-orange-custom rounded-3xl flex items-center justify-center border border-orange-100 shadow-sm animate-pulse"><i data-lucide="clock" class="w-10 h-10"></i></div>
                            <div>
                                <h2 class="text-xl font-black text-navy uppercase">Aguardando Autorização</h2>
                                <p class="text-sm text-slate-500 mt-2">Seu cadastro foi realizado com sucesso. Aguarde até que um administrador aprove seu acesso.</p>
                            </div>
                            <div class="p-4 bg-white border border-slate-200 rounded-2xl w-full max-w-xs shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Status Atual</span>
                                <span class="text-xs font-bold text-orange-500 uppercase">Pendente</span>
                            </div>
                            <button onclick="window.handleLogout()" class="mt-8 px-8 py-3 bg-red-600 text-white rounded-xl text-xs font-black uppercase tracking-widest flex items-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="log-out" class="w-4 h-4 text-white"></i> Sair da conta</button>
                        </div>
                    </div>
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                `;
                renderIcons();
                return;
            }

            // CASO 3: Usuário Autorizado (Visualização Normal)
            app.innerHTML = `
                <div id="home-container" class="flex flex-col h-full bg-slate-100 relative">
                    <div id="nav-menu-placeholder">${renderNavMenu()}</div>
                    <div class="bg-navy text-white p-4 sticky top-0 z-10 shadow-lg flex justify-between items-center">
                        <button onclick="window.openMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        <h1 class="text-lg font-bold uppercase tracking-wide">Agenda CCB</h1>
                        <button onclick="window.resetAllFilters()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="home" class="w-7 h-7"></i></button>
                    </div>
                    <div class="flex flex-col flex-1 overflow-hidden p-4 gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="flex gap-2">
                            <button onclick="window.startOpenAgenda()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> AGENDA</button>
                            <button onclick="window.resetAllFilters()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="list" class="w-3.5 h-3.5"></i> TODOS</button>
                            <button onclick="window.openFastFilterModal()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="filter" class="w-3.5 h-3.5"></i> FILTRO</button>
                            <button onclick="window.openPDFPreview()" class="flex-1 flex items-center justify-center gap-1.5 h-9 bg-navy text-white text-[9px] font-bold rounded shadow uppercase px-1"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> EXPORTAR</button>
                        </div>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input id="homeSearch" type="text" placeholder="Pesquisar evento, local ou atendente..." class="w-full pl-10 pr-3 h-10 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-navy/10" value="${state.searchTerm || ''}">
                                <i data-lucide="search" class="absolute left-3 top-3 text-slate-400 w-4 h-4"></i>
                            </div>
                            <button onclick="window.renderAdvancedFilterModal()" class="w-10 h-10 bg-white border border-slate-300 rounded-lg flex items-center justify-center text-navy shadow-sm active:bg-slate-50 relative">
                                <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                                ${state.advancedFilter.active ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-orange-custom rounded-full border-2 border-white"></span>' : ''}
                            </button>
                        </div>
                        <div id="event-list-container" class="flex flex-col gap-2 flex-1 min-h-0"></div>
                    </div>
                    ${state.isAdmin ? `<button onclick="window.startCreateEvent()" class="fixed bottom-6 right-6 w-14 h-14 bg-orange-custom text-white rounded-full shadow-xl flex items-center justify-center z-50 border-2 border-white/20"><i data-lucide="plus" class="w-8 h-8"></i></button>` : ''}
                </div>
            `;
            
            document.getElementById('homeSearch')?.addEventListener('input', (e) => { state.searchTerm = e.target.value; });
            updateHomeList();
        }

        function getFilteredEvents() {
            if (!state.isAuthorized) return [];
            let filtered = [...(state.events || [])];
            
            if (state.selectedDate) {
                filtered = filtered.filter((e) => e.date === state.selectedDate);
            } else if (state.fastFilter?.active) {
                if (state.fastFilter.dateStart) filtered = filtered.filter((e) => e.date >= state.fastFilter.dateStart);
                if (state.fastFilter.dateEnd) filtered = filtered.filter((e) => e.date <= state.fastFilter.dateEnd);
            }
            
            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                if (af.eventos.enabled) {
                    filtered = filtered.filter((e) => {
                        const isPast = isEventPast(e.date, e.time);
                        return af.eventos.status === 'ativos' ? !isPast : isPast;
                    });
                }
                if (af.type.enabled && af.type.id) {
                    filtered = filtered.filter((e) => e.type_id === af.type.id);
                }
                if (af.type.enabled && af.type.id) {
                    filtered = filtered.filter((e) => e.type_id === af.type.id);
                }
                if (af.attendant.enabled && af.attendant.id) {
                    filtered = filtered.filter((e) => e.attendant_id === af.attendant.id);
                }
                if (af.adm.enabled && af.adm.value) {
                    const validLocs = state.locations.filter((l) => l.adm === af.adm.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.setor.enabled && af.setor.value) {
                    const validLocs = state.locations.filter((l) => l.setor === af.setor.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.cidade.enabled && af.cidade.value) {
                    const validLocs = state.locations.filter((l) => l.cidade === af.cidade.value).map((l) => l.id);
                    filtered = filtered.filter((e) => validLocs.includes(e.location_id));
                }
                if (af.location.enabled && af.location.id) {
                    filtered = filtered.filter((e) => e.location_id === af.location.id);
                }
                if (af.period.enabled) {
                    if (af.period.start) filtered = filtered.filter((e) => e.date >= af.period.start);
                    if (af.period.end) filtered = filtered.filter((e) => e.date <= af.period.end);
                }
            }

            if (state.searchTerm) {
                const term = (state.searchTerm || '').toLowerCase();
                filtered = filtered.filter((e) => {
                    const typeObj = state.types.find((t) => t.id === e.type_id);
                    const typeName = (typeObj?.name || '').toLowerCase();
                    const typeSigla = (typeObj?.sigla || '').toLowerCase();
                    const locObj = state.locations.find((l) => l.id === e.location_id);
                    const loc = (locObj?.localidade || '').toLowerCase();
                    const termAtt = state.attendants.find((a) => a.id === e.attendant_id)?.name?.toLowerCase() || '';
                    return typeName.includes(term) || typeSigla.includes(term) || loc.includes(term) || termAtt.includes(term);
                });
            }
            
            return filtered.sort((a, b) => (a.date || '').localeCompare(b.date || '') || (a.time || '').localeCompare(b.time || ''));
        }

        function updateHomeList() {
            const container = document.getElementById('event-list-container');
            if (!container) return;

            if (!state.isAuthorized) {
                container.innerHTML = '';
                return;
            }

            const filtered = getFilteredEvents();
            container.innerHTML = `
                <div class="flex justify-between items-start px-1 mb-1 gap-2 min-h-[18px] overflow-visible">
                    <div id="home-filter-label" class="font-bold text-navy uppercase flex-1 min-w-0 leading-tight whitespace-normal break-words overflow-visible transition-all duration-200" style="font-size: 13px;">
                        ${getFilterDescription()}
                    </div>
                    <span class="text-[10px] font-medium text-slate-500 uppercase shrink-0 pt-0.5">${filtered.length} registros</span>
                </div>
                <div class="flex-1 bg-white rounded-xl shadow-md overflow-y-auto border border-slate-200 scrollbar-none">
                    ${filtered.length === 0 ? '<div class="p-12 text-center text-slate-400 flex flex-col items-center gap-4"><i data-lucide="calendar-x" class="w-10 h-10 opacity-20"></i><span>Nenhum evento encontrado.</span></div>' : `
                        <ul class="divide-y divide-slate-100">
                            ${filtered.map((e) => {
                                const type = state.types.find((t) => t.id === e.type_id);
                                const loc = state.locations.find((l) => l.id === e.location_id);
                                const att = state.attendants.find((a) => a.id === e.attendant_id);
                                const isPast = isEventPast(e.date, e.time);
                                const isHighlighted = state.highlightedItemId === e.id;
                                
                                const typeNameLower = (type?.name || '').toLowerCase();
                                const isBatismo = typeNameLower.includes('batismo');
                                const isSantaCeia = typeNameLower.includes('santa ceia');
                                const hasStats = isBatismo || isSantaCeia;
                                const total = (e.irmaos || 0) + (e.irmas || 0);
                                const isTemp = String(e.id).startsWith('temp_');

                                return `
                                    <li id="item-${e.id}" onclick="${state.isAdmin ? `window.openEditEvent('${e.id}')` : ''}" class="relative p-3 transition-all ${isHighlighted ? 'bg-yellow-50 ring-2 ring-yellow-400 ring-inset z-10' : state.isAdmin ? 'active:bg-slate-50' : ''} ${isPast && !isHighlighted ? 'bg-slate-50/50 grayscale-[0.5] opacity-70' : ''}">
                                        
                                        <div class="absolute top-3 right-3 flex flex-col items-end gap-1.5 z-10">
                                            <span class="text-[9px] font-black bg-navy text-white px-1.5 py-0.5 rounded uppercase tracking-tighter shadow-sm flex items-center gap-1">
                                                ${isTemp ? '<i data-lucide="cloud-off" class="w-3 h-3 text-orange-400"></i>' : ''}
                                                ${type?.sigla || 'EVT'}
                                            </span>
                                            ${hasStats ? `
                                                <div class="flex flex-col items-end text-[12.15px] font-semibold text-slate-400 leading-tight">
                                                    <div>Irmãs: ${e.irmas || 0}</div>
                                                    <div>Irmãos: ${e.irmaos || 0}</div>
                                                    <div>Total: ${total}</div>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <div class="flex gap-3">
                                            <div class="w-12 h-12 rounded-xl flex items-center justify-center shrink-0 ${isPast ? 'bg-slate-200 text-slate-500' : 'bg-blue-50 text-navy border border-blue-100'}">
                                                <i data-lucide="${isPast ? 'check-circle' : 'calendar-clock'}" class="w-6 h-6"></i>
                                            </div>
                                            <div class="min-w-0 flex-1 pr-16 flex flex-col justify-center">
                                                <div class="font-bold text-navy text-[16.2px] leading-tight whitespace-normal">${type?.name || 'Evento'}</div>
                                                <div class="text-[12.15px] font-semibold text-slate-600 mt-1 leading-tight">${formatDate(e.date)} - ${e.time}</div>
                                                <div class="flex flex-col gap-1 mt-1 leading-tight">
                                                    <div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${loc?.localidade || ''}</span></div>
                                                    <div class="text-[12.15px] text-slate-600 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3 shrink-0"></i> <span class="whitespace-normal">${att?.name || ''}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    `}
                </div>
            `;
            
            const labelEl = document.getElementById('home-filter-label');
            if (labelEl) {
                let currentSize = 13;
                labelEl.style.fontSize = currentSize + 'px';
                while (labelEl.scrollHeight > 34 && currentSize > 9) {
                    currentSize -= 0.2;
                    labelEl.style.fontSize = currentSize + 'px';
                }
            }

            renderIcons();

            if (state.highlightedItemId) {
                setTimeout(() => {
                    const el = document.getElementById(`item-${state.highlightedItemId}`);
                    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function getFilterDescription() {
            if (state.selectedDate) return `Agenda: ${formatDateFull(state.selectedDate)}`;
            if (state.fastFilter?.active) return state.fastFilter.label || 'Filtro Ativo';
            
            if (state.advancedFilter.active) {
                const af = state.advancedFilter;
                const parts = [];
                if (af.eventos.enabled) parts.push(af.eventos.status === 'ativos' ? 'Ativos' : 'Inativos');
                if (af.type.enabled && af.type.id) {
                    const type = state.types.find((t) => t.id === af.type.id);
                    if (type) parts.push(type.name);
                }
                const locChain = [];
                if (af.adm.enabled && af.adm.value) locChain.push(af.adm.value);
                if (af.setor.enabled && af.setor.value) {
                    const cleanSetor = af.setor.value.replace(/setor\s+/gi, '');
                    locChain.push(`Setor ${cleanSetor}`);
                }
                if (af.cidade.enabled && af.cidade.value) locChain.push(af.cidade.value);
                if (af.location.enabled && af.location.id) {
                    const loc = state.locations.find((l) => l.id === af.location.id);
                    if (loc) locChain.push(loc.localidade);
                }
                if (locChain.length > 0) parts.push(locChain.join(' > '));
                if (af.period.enabled && af.period.start && af.period.end) {
                    parts.push(`${formatDate(af.period.start)} a ${formatDate(af.period.end)}`);
                }
                return parts.length > 0 ? parts.join(' | ') : 'Todos os Eventos';
            }

            if (state.searchTerm) return `Busca: ${state.searchTerm}`;
            return 'Todos os Eventos';
        }

        function renderNavMenu() { 
            if (!state.isMenuOpen) return ''; 
            
            const baseItems = [
                { id: 'home', icon: 'home', label: 'Início' }
            ];

            if (state.isAuthorized) {
                baseItems.push(
                    { id: 'types', icon: 'tag', label: 'Tipos de Evento' },
                    { id: 'locations', icon: 'map-pin', label: 'Localidades' },
                    { id: 'attendants', icon: 'users', label: 'Atendentes' },
                    { id: 'feriados', icon: 'sun', label: 'Feriados' }
                );
            }

            const adminItems = (state.isAdmin && state.isAuthorized) ? [
                { id: 'users', icon: 'shield-check', label: 'Gestão de Usuários' }
            ] : [];

            const footerItems = [
                { id: 'about', icon: 'info', label: 'Sobre' }
            ];

            const menuItems = [...baseItems, ...adminItems, ...footerItems];

            return `
                <div class="fixed inset-0 z-50 flex">
                    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="window.closeMenu()"></div>
                    <div class="relative w-72 h-full bg-navy text-white flex flex-col shadow-2xl">
                        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-[#002855]">
                            <h2 class="text-xl font-bold tracking-tight">Menu</h2>
                            <button onclick="window.closeMenu()" class="p-1 hover:bg-white/10 rounded"><i data-lucide="x"></i></button>
                        </div>
                        <nav class="flex-1 py-4 flex flex-col gap-1 overflow-y-auto scrollbar-none">
                            ${menuItems.map(item => `
                                <button onclick="window.navigateTo('${item.id}')" class="w-full flex items-center px-6 py-4 hover:bg-white/10 gap-4 border-l-4 border-transparent hover:border-orange-custom transition-all">
                                    <i data-lucide="${item.icon}" class="text-orange-custom w-5 h-5"></i>
                                    <span class="font-medium">${item.label}</span>
                                </button>
                            `).join('')}
                        </nav>
                        <div class="p-4 border-t border-white/10 bg-[#002244]">
                            ${state.user ? `<button onclick="window.handleLogout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-red-600/20 text-red-200 rounded-lg font-bold border border-red-500/30 active:scale-95 transition-transform"><i data-lucide="log-out" class="w-4 h-4"></i> Sair da Conta</button>` : `<button onclick="window.showLoginModal()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white/10 text-white rounded-lg font-bold hover:bg-white/20 border border-white/10"><i data-lucide="lock" class="w-4 h-4"></i> Login Admin</button>`}
                        </div>
                    </div>
                </div>
            `; 
        }

        function renderUsersManager() {
            const app = document.getElementById('app');
            if (!app) return;
            renderGenericManager('Gestão de Usuários', 'perfis');
        }

        function renderEventForm() {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const isEditing = !!state.editingEventId;
            const app = document.getElementById('app');
            if (!app) return;
            const selectedType = state.types.find((t) => t.id === state.formTempType);
            const typeName = (selectedType?.name || '').toLowerCase();
            const showCounters = typeName.includes('batismo') || typeName.includes('santa ceia');
            const errs = state.formErrors || [];

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide text-sm">${isEditing ? 'Editar' : 'Novo'} Evento</h1>
                    </div>
                    <div class="p-4 flex flex-col gap-4 max-w-xl mx-auto w-full overflow-y-auto scrollbar-none">
                        <div class="bg-white p-5 rounded-xl shadow-md flex flex-col gap-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Data</label>
                                    <button onclick="window.openFormDate()" class="flex items-center gap-2 border ${errs.includes('date') ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                        <i data-lucide="calendar" class="w-4 h-4 opacity-50"></i>
                                        ${state.formTempDate ? formatDate(state.formTempDate) : 'Selecionar'}
                                    </button>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Hora</label>
                                    <button onclick="window.openTimePickerModal()" class="flex items-center gap-2 border border-slate-200 p-3 rounded-lg text-left text-sm bg-slate-50 font-medium text-navy transition-colors">
                                        <i data-lucide="clock" class="w-4 h-4 opacity-50"></i>
                                        ${state.formTempTime}
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Localidade</label>
                                <button onclick="window.openSelectPicker('locations', 'Local', 'formTempLoc')" class="flex items-center gap-2 border ${errs.includes('loc') ? 'border-red-500 bg-red-50' : 'border-slate-200 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                    <i data-lucide="map-pin" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.locations.find((l)=>l.id===state.formTempLoc)?.localidade || 'Selecionar Localidade'}</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Evento</label>
                                <button onclick="window.openSelectPicker('types', 'Tipo', 'formTempType')" class="flex items-center gap-2 border ${errs.includes('type') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} p-3 rounded-lg text-left text-sm font-medium text-navy transition-colors">
                                    <i data-lucide="tag" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.types.find((t)=>t.id===state.formTempType)?.name || 'Selecionar Tipo'}</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Atendente</label>
                                <button onclick="window.openSelectPicker('attendants', 'Atendente', 'formTempAtt')" class="flex items-center gap-2 border border-slate-200 p-3 rounded-lg text-left text-sm bg-slate-50 font-medium text-navy transition-colors">
                                    <i data-lucide="users" class="w-4 h-4 opacity-50"></i>
                                    <span>${state.attendants.find((a)=>a.id===state.formTempAtt)?.name || 'Selecionar Atendente'}</span>
                                </button>
                            </div>
                            <div class="${showCounters ? '' : 'hidden'} grid grid-cols-2 gap-3 transition-all duration-300">
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Irmãos</label>
                                    <input id="event-irmaos" type="number" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${state.formTempIrmaos || ''}" placeholder="0">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Irmãs</label>
                                    <input id="event-irmas" type="number" class="w-full border border-slate-200 p-3 rounded-lg text-sm bg-slate-50 font-medium text-navy focus:ring-2 focus:ring-navy/10" value="${state.formTempIrmas || ''}" placeholder="0">
                                </div>
                            </div>
                            <button onclick="window.saveEvent()" class="bg-navy text-white p-4 rounded-xl font-black mt-2 shadow-lg active:scale-[0.98] transition-transform">SALVAR EVENTO</button>
                            ${isEditing ? `<button onclick="window.requestDeleteEvent('${state.editingEventId}')" class="text-red-600 p-3 text-xs font-bold border border-red-100 rounded-lg bg-red-50/30 mt-2 flex items-center justify-center gap-2 active:bg-red-100 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir Evento</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            renderIcons();
        }

        function renderGenericManager(title, collection) {
            if (!state.isAuthorized) { navigateTo('home'); return; }
            const app = document.getElementById('app');
            if (!app) return;
            let itemIcon = 'tag';
            if (collection === 'locations') itemIcon = 'map-pin';
            if (collection === 'attendants') itemIcon = 'user';
            if (collection === 'feriados') itemIcon = 'sun';
            if (collection === 'perfis') itemIcon = 'shield-check';

            let searchPlaceholder = "Buscar...";
            if (collection === 'locations') searchPlaceholder = "Pesq. por adm, setor, cidade, localidade";
            else if (collection === 'types') searchPlaceholder = "Pesquisar por nome ou sigla...";
            else if (collection === 'attendants') searchPlaceholder = "Pesquisar por nome ou ministério...";
            else if (collection === 'feriados') searchPlaceholder = "Pesquisar por nome ou tipo...";
            else if (collection === 'perfis') searchPlaceholder = "Pesquisar por nome ou permissão...";

            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex justify-between items-center shadow-lg z-10">
                        <div class="flex items-center gap-3">
                            <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                            <h1 class="font-bold uppercase tracking-wide text-sm">${title}</h1>
                        </div>
                        <button onclick="window.resetAllFilters(); window.navigateTo('home')" class="p-2 hover:bg-white/10 rounded"><i data-lucide="home" class="w-5 h-5"></i></button>
                    </div>
                    <div class="p-4 flex flex-col gap-4 flex-1 overflow-hidden max-w-xl mx-auto w-full">
                        <div class="relative">
                            <input id="managerSearch" type="text" placeholder="${searchPlaceholder}" class="w-full pl-10 pr-4 py-2.5 border-2 border-blue-200 rounded-xl text-sm font-medium shadow-sm transition-all focus:border-blue-500 bg-white" value="${state.managerSearchTerm || ''}">
                            <i data-lucide="search" class="absolute left-3.5 top-3.5 text-blue-300 w-4 h-4"></i>
                        </div>
                        <div id="manager-list-stats" class="flex justify-end pr-1 -mt-2"></div>
                        <div id="manager-items-container" class="flex-1 overflow-y-auto mb-1 bg-white rounded-2xl border border-slate-200 shadow-sm divide-y divide-slate-100 scrollbar-none"></div>
                        ${(state.isAdmin && collection !== 'perfis') ? `
                            <div class="flex justify-center pb-2">
                                <button onclick="window.openRowModal('${collection}')" class="bg-navy text-white px-8 py-2.5 rounded-xl font-black shadow-lg flex items-center justify-center gap-3 active:scale-[0.98] transition-all border-2 border-white/10 w-full text-xs uppercase tracking-widest">
                                    <i data-lucide="plus" class="w-4 h-4"></i> ADICIONAR
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            window.updateManagerListUI = (coll) => {
                const container = document.getElementById('manager-items-container');
                const stats = document.getElementById('manager-list-stats');
                if (!container || !stats) return;
                const items = [...(state[coll] || [])];
                items.sort((a, b) => {
                    if (coll === 'feriados') return (a.data || '').localeCompare(b.data || '');
                    const nameA = (coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '';
                    const nameB = (coll === 'locations' ? b.localidade : (coll === 'perfis' ? a.nome : b.name)) || '';
                    return nameA.localeCompare(nameB);
                });
                const term = (state.managerSearchTerm || '').toLowerCase();
                const filtered = items.filter((i) => {
                    if (coll === 'types') return (i.name || '').toLowerCase().includes(term) || (i.sigla || '').toLowerCase().includes(term);
                    if (coll === 'locations') return (i.localidade || '').toLowerCase().includes(term) || (i.adm || '').toLowerCase().includes(term) || (i.setor || '').toLowerCase().includes(term) || (i.cidade || '').toLowerCase().includes(term);
                    if (coll === 'attendants') return (i.name || '').toLowerCase().includes(term) || (i.ministerio || '').toLowerCase().includes(term);
                    if (coll === 'feriados') return (i.nome_feriado || '').toLowerCase().includes(term) || (i.tipo_feriado || '').toLowerCase().includes(term) || (i.data || '').toLowerCase().includes(term);
                    if (coll === 'perfis') return (i.nome || '').toLowerCase().includes(term) || (i.permissao || '').toLowerCase().includes(term);
                    return false;
                });
                stats.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${filtered.length} REGISTROS</span>`;
                container.innerHTML = filtered.length === 0 ? '<div class="p-12 text-center text-slate-300 italic text-sm">Nenhum registro encontrado.</div>' : filtered.map((item) => {
                    let badgesHtml = "";
                    const mainName = (coll === 'locations' ? item.localidade : (coll === 'feriados' ? item.nome_feriado : (coll === 'perfis' ? item.nome : item.name))) || '';
                    if (coll === 'locations') {
                        const line2 = [item.adm, item.setor].filter(Boolean).join(' | ');
                        badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${line2}</div><div class="text-[11px] text-slate-400 font-semibold leading-tight mt-0.5 h-3">${item.cidade || ''}</div>`;
                    } else if (coll === 'types') {
                        badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.sigla || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3"></div>`;
                    } else if (coll === 'attendants') {
                        badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.ministerio || ''}</div><div class="text-[11px] text-slate-400 leading-tight mt-0.5 h-3"></div>`;
                    } else if (coll === 'feriados') {
                        badgesHtml = `<div class="text-[11px] text-slate-600 font-medium leading-tight mt-1 h-3">${item.tipo_feriado || ''}</div><div class="text-[11px] text-slate-400 font-semibold leading-tight mt-0.5 h-3">${formatDateFull(item.data) || ''}</div>`;
                    } else if (coll === 'perfis') {
                        const isAuth = item.autorizado === true;
                        const role = item.permissao === 'admin' ? 'Administrador' : 'Leitura';
                        badgesHtml = `<div class="text-[11px] font-bold leading-tight mt-1 ${isAuth ? 'text-green-600' : 'text-orange-500'}">${isAuth ? 'AUTORIZADO' : 'PENDENTE'}</div><div class="text-[10px] text-slate-400 font-semibold uppercase tracking-tighter mt-0.5">${role}</div>`;
                    }
                    const isHighlighted = state.highlightedItemId === item.id;
                    const safeMainName = (mainName || '').replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    return `<div id="item-${item.id}" class="p-4 flex items-center justify-between hover:bg-slate-50 transition-all ${isHighlighted ? 'bg-yellow-50 highlight-item ring-2 ring-yellow-400 ring-inset' : ''}"><div class="flex items-center gap-4 min-w-0"><div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center shrink-0 border border-blue-100"><i data-lucide="${itemIcon}" class="w-5 h-5 text-navy"></i></div><div class="min-w-0 flex flex-col justify-center"><div class="font-bold text-navy text-sm leading-tight">${mainName}</div>${badgesHtml}</div></div><div class="flex gap-1 ml-4 shrink-0">${state.isAdmin ? `<button onclick="window.openRowModal('${coll}', '${item.id}')" class="p-2.5 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="window.requestDeleteRow('${item.id}', '${coll}', '${safeMainName}')" class="p-2.5 text-red-400 hover:bg-red-100 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}</div></div>`;
                }).join('');
                renderIcons();
                if (state.highlightedItemId) {
                    setTimeout(() => { const el = document.getElementById(`item-${state.highlightedItemId}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                }
            };
            document.getElementById('managerSearch')?.addEventListener('input', (e) => { state.managerSearchTerm = e.target.value; state.highlightedItemId = null; window.updateManagerListUI(collection); });
            window.updateManagerListUI(collection);
       }

        function renderAbout() {
            const app = document.getElementById('app');
            if (!app) return;
            app.innerHTML = `
                <div class="flex flex-col h-full bg-slate-100">
                    <div class="bg-navy text-white p-4 flex items-center gap-3 shadow-lg">
                        <button onclick="window.navigateTo('home')" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="arrow-left"></i></button>
                        <h1 class="font-bold uppercase tracking-wide text-sm">Sobre</h1>
                    </div>
                    <div class="p-8 flex flex-col items-center text-center flex-1 justify-center">
                        <div class="w-20 h-20 bg-navy rounded-3xl flex items-center justify-center shadow-lg mb-6"><i data-lucide="calendar" class="w-10 h-10 text-white"></i></div>
                        <h2 class="text-2xl font-black text-navy uppercase tracking-tighter">Agenda CCB</h2>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">v1.4.0 Vanilla JS</p>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mt-8 max-w-xs">
                            <p class="text-sm text-slate-600">Sistema oficial de agenda administrativa para controle de eventos e localidades com suporte a gestão de ADM e Setores.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendar(mode) {
            const viewDate = new Date(state.viewDate);
            const month = viewDate.getMonth();
            const year = viewDate.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            loadExternalHolidays(year);
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);
            const fmt = (d) => `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            let currentSelected = '';
            if (mode === 'filter') currentSelected = state.selectedDate || '';
            else if (mode === 'picker') currentSelected = state.formTempDate || '';
            else if (mode === 'adv_start') currentSelected = state.advancedFilter.period.start || '';
            else if (mode === 'adv_end') currentSelected = state.advancedFilter.period.end || '';
            else if (mode === 'feriado_picker') currentSelected = document.getElementById('feriado-date-val')?.value || '';
            
            const eventDots = {};
            state.events.forEach((e) => { 
                const datePart = e.date.substring(0, 7); 
                if (datePart === `${year}-${String(month + 1).padStart(2, '0')}`) eventDots[e.date] = (eventDots[e.date] || 0) + 1; 
            });

            const monthHolidays = [...state.externalHolidays.filter((h) => { 
                const d = new Date(h.date + 'T00:00:00'); 
                return d.getMonth() === month && d.getFullYear() === year; 
            }), ...state.feriados.filter((f) => { 
                const d = new Date(f.data + 'T00:00:00'); 
                return d.getMonth() === month && d.getFullYear() === year; 
            })].sort((a, b) => (a.date || a.data).localeCompare(b.date || b.data));
            
            const holidayLegendItems = monthHolidays.map(h => { 
                const dateStr = h.date || h.data; 
                const day = parseInt(dateStr.split('-')[2]); 
                return `<span class="whitespace-nowrap"><span class="font-bold text-red-500">${day}</span> - ${h.name || h.nome_feriado}</span>`; 
            }).join(' <span class="text-slate-300 mx-2">|</span> ');
            
            let title = mode === 'filter' ? 'Agenda' : 'Selecionar Data';
            if (mode === 'adv_start') title = 'Data de Início';
            if (mode === 'adv_end') title = 'Data do Fim';
            
            let contentHtml = `<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col max-h-[95vh]"><div class="p-3 flex justify-between items-center border-b border-slate-50 bg-white shrink-0"><div class="flex items-center gap-2 text-navy"><i data-lucide="calendar" class="w-4 h-4"></i><h3 class="text-base font-black tracking-tight uppercase">${title}</h3></div><button onclick="${(mode === 'adv_start' || mode === 'adv_end') ? 'window.renderAdvancedFilterModal()' : mode === 'feriado_picker' ? 'window.returnToFeriadoModal()' : 'window.closeModal()'}" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-3 overflow-y-auto scrollbar-none"><div class="flex justify-between items-center mb-3 px-1"><button onclick="window.changeMonth(-1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><div class="flex gap-2 font-black text-[14px] uppercase tracking-widest text-navy"><button onclick="window.openMonthPicker('${mode}')" class="hover:text-orange-custom">${monthNames[month]}</button><button onclick="window.openYearPicker('${mode}')" class="hover:text-orange-custom">${year}</button></div><button onclick="window.changeMonth(1, '${mode}')" class="p-1.5 text-navy hover:bg-slate-50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 text-center text-[11px] font-black uppercase tracking-widest text-slate-400 mb-2"><span class="text-red-500">D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span></div><div class="grid grid-cols-7 gap-y-1.5 text-center items-center justify-items-center">${days.map(d => { if (!d) return '<div></div>'; const fullDate = fmt(d); const isToday = fullDate === new Date().toISOString().split('T')[0]; const isHoliday = state.externalHolidays.some((h) => h.date === fullDate) || state.feriados.some((f) => f.data === fullDate); return `<div class="flex flex-col items-center gap-0.5"><button onclick="window.selectCalendarDate('${fullDate}', '${mode}')" class="w-7 h-7 flex items-center justify-center rounded-lg text-xs font-bold transition-all relative ${fullDate === currentSelected ? 'bg-navy text-white shadow-md' : isToday ? 'text-green-600 border border-green-100' : (new Date(year, month, d).getDay() === 0 || isHoliday) ? 'text-red-500' : 'text-slate-600 hover:bg-slate-50'}">${d}</button><div class="flex gap-0.5 h-1.5 items-center justify-center">${(eventDots[fullDate] || 0) > 0 ? Array(Math.min(eventDots[fullDate], 4)).fill(0).map(() => `<span class="w-1 h-1 rounded-full ${fullDate === currentSelected ? 'bg-orange-custom' : 'bg-navy'}"></span>`).join('') : ''}</div></div>`; }).join('')}</div></div>${holidayLegendItems ? `<div class="px-4 py-2 border-t border-slate-50 bg-slate-50/40 shrink-0"><div class="flex flex-wrap gap-y-1 text-[11px] items-center">${holidayLegendItems}</div></div>` : ''}`;
            
            if (mode === 'filter' && state.selectedDate) {
                const dayEvents = state.events.filter((e) => e.date === state.selectedDate).sort((a, b) => a.time.localeCompare(b.time));
                contentHtml += `<div class="flex flex-col border-t border-slate-100 shrink-0"><div class="px-4 py-1.5 flex justify-between items-center bg-slate-50/50"><span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">EVENTOS: ${formatDate(state.selectedDate)}</span></div><div class="flex flex-col divide-y divide-slate-100 max-h-[160px] overflow-y-auto scrollbar-none bg-white">${dayEvents.length === 0 ? '<div class="text-center text-slate-300 py-6 text-[10px] font-medium italic">Nenhum evento programado</div>' : dayEvents.map((e) => {
                    const loc = state.locations.find((l) => l.id === e.location_id)?.localidade || '';
                    const att = state.attendants.find((a) => a.id === e.attendant_id)?.name || '';
                    return `<div class="p-2.5 flex flex-col gap-0.5 active:bg-slate-50 transition-colors relative group"><div class="flex items-center gap-2"><span class="text-[11px] font-black text-navy shrink-0">${e.time}</span><span class="text-[11px] font-bold text-slate-800 leading-tight">${state.types.find((t) => t.id === e.type_id)?.name || 'Evento'}</span></div><div class="flex items-center gap-3 pr-10"><div class="text-[9px] text-slate-400 font-medium flex items-center gap-1"><i data-lucide="map-pin" class="w-2 h-2 shrink-0"></i> <span>${loc} ${att ? '| ' + att : ''}</span></div></div><div class="absolute bottom-2 right-3 bg-navy text-white text-[7px] font-black px-1 py-0.5 rounded uppercase tracking-tighter shrink-0 shadow-sm">${state.types.find((t) => t.id === e.type_id)?.sigla || 'EVT'}</div></div>`;
                }).join('')}</div><div class="p-3 bg-white border-t border-slate-50"><button onclick="window.applyCalendarAndClose()" class="w-full bg-navy text-white py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg shadow-navy/20 active:scale-95 transition-all"><i data-lucide="list" class="w-3.5 h-3.5"></i> Ver na Lista</button></div></div>`;
            }
            contentHtml += `</div>`;
            showModal(contentHtml);
        }

        function renderClockUI() {
            const isH = state.clockMode === 'hour';
            const values = isH ? ['00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23'] : ['00','05','10','15','20','25','30','35','40','45','50','55'];
            showModal(`<div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md overflow-hidden"><div class="flex justify-center items-center gap-4 mb-8"><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'hour'" class="text-4xl font-black ${isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempHour || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Hora</span></div><span class="text-4xl font-black text-slate-200 mb-5">:</span><div class="flex flex-col items-center"><button onclick="window.state.clockMode = 'minute'" class="text-4xl font-black ${!isH ? 'text-navy scale-110' : 'text-slate-200'}">${state.clockTempMinute || '00'}</button><span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-1">Min</span></div></div><div class="grid grid-cols-4 gap-3">${values.map(v => `<button onclick="window.selectClockValue('${v}')" class="aspect-square flex items-center justify-center rounded-2xl font-bold text-sm transition-all ${(isH ? state.clockTempHour === v : state.clockTempMinute === v) ? 'bg-navy text-white shadow-lg' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}">${v}</button>`).join('')}</div><div class="flex gap-3 mt-8"><button onclick="window.closeModal()" class="flex-1 py-4 text-slate-400 font-bold text-xs uppercase tracking-widest">Cancelar</button><button onclick="window.confirmClockTime()" class="flex-2 bg-navy text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-lg">OK</button></div></div>`);
        }

        function renderAdvancedFilterModal() {
            const af = state.advancedFilter;
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const errs = af.validationErrors || [];
            
            let selMonthLabel = 'Mês';
            let selYearLabel = 'Ano';
            if (af.period.enabled && af.period.start) {
                const d = new Date(af.period.start + 'T00:00:00');
                const dEnd = new Date(af.period.end + 'T00:00:00');
                const isFullMonth = d.getDate() === 1 && dEnd.getDate() === new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate() && d.getMonth() === dEnd.getMonth();
                const isFullYear = d.getDate() === 1 && d.getMonth() === 0 && dEnd.getDate() === 31 && dEnd.getMonth() === 11;
                if (isFullYear) { selYearLabel = d.getFullYear().toString(); selMonthLabel = 'Mês'; } 
                else if (isFullMonth) { selMonthLabel = monthNames[d.getMonth()]; selYearLabel = d.getFullYear().toString(); }
            }

            state.searchTerm = '';
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-center gap-2 text-navy"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i><h3 class="text-lg font-black tracking-tight uppercase">Filtros Avançados</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-5 overflow-y-auto scrollbar-none"><div class="flex flex-col gap-3"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('eventos')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status dos Eventos</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.eventos.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.eventos.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.eventos.enabled ? `<div class="flex bg-slate-100 p-1 rounded-xl"><button onclick="window.setAdvFilterStatus('ativos'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'ativos' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">ATIVOS</button><button onclick="window.setAdvFilterStatus('passados'); window.renderAdvancedFilterModal();" class="flex-1 py-1.5 text-[10px] font-black rounded-lg transition-all ${af.eventos.status === 'passados' ? 'bg-white text-navy shadow-sm' : 'text-slate-400'}">INATIVOS</button></div>` : ''}</div><div class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('type')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Tipo</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.type.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.type.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.type.enabled ? `<button onclick="window.openSelectPicker('types', 'Tipo', 'adv_type')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('type') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span class="truncate">${state.types.find((t)=>t.id===af.type.id)?.name || 'Selecionar Tipo...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('adm')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por ADM</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.adm.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.adm.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.adm.enabled ? `<button onclick="window.openDistinctPicker('adm')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('adm') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors mb-2"><span>${af.adm.value || 'Selecionar ADM...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.adm.value ? `<div class="flex flex-col gap-2 mt-2 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('setor')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Setor</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.setor.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.setor.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.setor.enabled ? `<button onclick="window.openDistinctPicker('setor')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('setor') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.setor.value || 'Selecionar Setor...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>${af.setor.value ? `<div class="flex flex-col gap-2 mt-4 ml-2 border-l-2 border-slate-100 pl-4"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('cidade')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Cidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.cidade.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.cidade.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.cidade.enabled ? `<button onclick="window.openDistinctPicker('cidade')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('cidade') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${af.cidade.value || 'Selecionar Cidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div>` : ''}` : ''}</div>` : ''}` : ''}</div><div class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('location')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Localidade</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.location.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.location.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.location.enabled ? `<button onclick="window.openSelectPicker('locations', 'Local', 'adv_location')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('location') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.locations.find((l)=>l.id===af.location.id)?.localidade || 'Selecionar Localidade...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('attendant')"><label class="text-[10px] font-black text-slate-400 uppercase ml-1 block uppercase tracking-widest">Filtrar por Atendente</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.attendant.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.attendant.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.attendant.enabled ? `<button onclick="window.openSelectPicker('attendants', 'Atendente', 'adv_attendant')" class="w-full flex justify-between items-center py-2.5 px-4 ${errs.includes('attendant') ? 'border-red-500 bg-red-50' : 'border-slate-100 bg-slate-50'} border rounded-2xl text-xs font-bold text-navy transition-colors"><span>${state.attendants.find((a)=>a.id===af.attendant.id)?.name || 'Selecionar Atendente...'}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button>` : ''}</div><div class="flex flex-col gap-2"><div class="flex justify-between items-center" onclick="window.toggleAdvFilterSection('period')"><label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Filtrar por Período</label><div class="w-10 h-5 bg-slate-100 rounded-full relative transition-colors ${af.period.enabled ? 'bg-orange-custom/20' : ''}"><div class="absolute top-1 left-1 w-3 h-3 rounded-full transition-all ${af.period.enabled ? 'left-6 bg-orange-custom' : 'bg-slate-300'}"></div></div></div>${af.period.enabled ? `<div class="flex flex-col gap-2"><div class="grid grid-cols-2 gap-2"><button onclick="window.openDateRangePicker('start')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.start ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">Início</span><span class="truncate">${af.period.start ? formatDate(af.period.start) : 'Data...'}</span></button><button onclick="window.openDateRangePicker('end')" class="relative flex items-center justify-center py-2.5 px-4 bg-slate-50 border ${errs.includes('period') && !af.period.end ? 'border-red-500 bg-red-50' : 'border-slate-100'} rounded-2xl text-xs font-bold text-navy transition-colors"><span class="absolute left-3 text-[9px] text-slate-400 uppercase">Fim</span><span class="truncate">${af.period.end ? formatDate(af.period.end) : 'Data...'}</span></button></div><div class="grid grid-cols-2 gap-2"><button onclick="state.viewDate = (state.advancedFilter.period.start ? new Date(state.advancedFilter.period.start + 'T00:00:00') : new Date()); window.openMonthPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selMonthLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button><button onclick="window.openYearPicker('adv_period')" class="w-full flex justify-between items-center py-2.5 px-4 bg-slate-50 border border-slate-100 rounded-2xl text-xs font-bold text-navy"><span class="text-navy uppercase">${selYearLabel}</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-30"></i></button></div></div>` : ''}</div></div><div class="p-6 border-t border-slate-50 flex gap-3"><button onclick="window.clearAdvancedFilters()" class="flex-1 bg-slate-100 text-slate-600 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpar Filtro</button><button onclick="window.applyAdvancedFilters()" class="flex-1 bg-navy text-white py-2.5 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg shadow-navy/20 text-[11px] uppercase tracking-widest active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
        }

        function openDistinctPicker(f) {
            const af = state.advancedFilter; let locs = [...state.locations];
            if (f === 'setor') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); }
            else if (f === 'cidade') { if (af.adm.enabled && af.adm.value) locs = locs.filter(l => l.adm === af.adm.value); if (af.setor.enabled && af.setor.value) locs = locs.filter(l => l.setor === af.setor.value); }
            const values = [...new Set(locs.map((l) => l[f]).filter((v) => v))].sort();
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${f.toUpperCase()}</h3></div><button onclick="window.renderAdvancedFilterModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="distinctItemsList" class="flex-1 overflow-y-auto px-2 pb-4 pt-2 scrollbar-none">${values.length === 0 ? '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum dado encontrado.</div>' : values.map(val => `<button onclick="window.handleAdvFilterSelect('${f}', '${val.replace(/'/g, "\\'")}')" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><span class="font-bold text-sm text-navy leading-tight">${val}</span>${af[f].value === val ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0"></i>' : ''}</button>`).join('')}</div></div>`);
            renderIcons();
        }

        function openRowModal(coll, id = '', initVals = {}) {
            if (!state.isAdmin) return;
            const safeId = (!id || id === 'undefined') ? '' : id;
            const isE = !!safeId;
            const item = (initVals && Object.keys(initVals).length > 0) ? initVals : (isE ? state[coll].find((i) => i.id === safeId) : {});
            const ctx = { 
                types: { title: 'Tipo de Evento', name: 'Nome do Evento' }, 
                locations: { title: 'Cidade / Localidade', name: 'Nome da Localidade' }, 
                attendants: { title: 'Atendente', name: 'Nome Completo' }, 
                feriados: { title: 'Feriado', name: 'Nome do Feriado' },
                perfis: { title: 'Usuário', name: 'Nome do Usuário' }
            }[coll] || { title: 'Registro', name: 'Nome' };

            const mainV = (coll === 'locations' ? item.localidade : (coll === 'feriados' ? item.nome_feriado : (coll === 'perfis' ? item.nome : item.name))) || '';
            
            if (coll === 'feriados') window.__feriado_modal_cache = { safeId, item };
            
            // Layout especializado para PERFIS (Gestão de Usuários)
            if (coll === 'perfis') {
                showModal(`
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                            <h3 class="font-black text-navy text-xs uppercase tracking-widest">Gerenciar Usuário</h3>
                            <button onclick="window.closeModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-6 flex flex-col gap-5">
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nome Completo</label>
                                <input type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-400 cursor-not-allowed" value="${mainV}" disabled>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-navy uppercase">Autorizado</span>
                                    <span class="text-[10px] text-slate-400 font-medium">Permitir acesso à agenda</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="user-authorized" class="sr-only peer" ${item.autorizado ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-custom"></div>
                                </label>
                            </div>

                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nível de Permissão</label>
                                <select id="user-permission" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10 appearance-none bg-white">
                                    <option value="leitura" ${item.permissao === 'leitura' ? 'selected' : ''}>Somente Leitura</option>
                                    <option value="admin" ${item.permissao === 'admin' ? 'selected' : ''}>Administrador</option>
                                </select>
                            </div>

                            <button onclick="window.saveRow('perfis', '${safeId}')" class="w-full bg-navy text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg mt-2 active:scale-95 transition-transform">SALVAR ALTERAÇÕES</button>
                        </div>
                    </div>
                `);
                renderIcons();
                return;
            }

            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"><div class="p-4 bg-slate-50 border-b flex justify-between items-center"><h3 class="font-black text-navy text-xs uppercase tracking-widest">${isE ? 'Editar' : 'Novo'} ${ctx.title}</h3><button onclick="window.closeModal()" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-4">${coll === 'locations' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">ADM</label><input id="loc-adm" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.adm || ''}" placeholder="Nome do ADM"></div><div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Setor</label><input id="loc-setor" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.setor || ''}" placeholder="Número/Nome do Setor"></div><div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Cidade</label><input id="loc-cidade" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.cidade || ''}" placeholder="Ex: Valente"></div>` : ''}${coll === 'feriados' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Data do Feriado</label><button id="feriado-btn" onclick="window.openFeriadoDatePicker()" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy bg-slate-50 text-left flex justify-between items-center transition-colors"><span id="feriado-date-display">${item.data ? formatDateFull(item.data) : 'Selecionar Data...'}</span><i data-lucide="calendar" class="w-4 h-4 opacity-40"></i><input type="hidden" id="feriado-date-val" value="${item.data || ''}"></button></div><div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Tipo de Feriado</label><input id="feriado-tipo" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.tipo_feriado || ''}" placeholder="Ex: Nacional, Municipal..."></div>` : ''}<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">${ctx.name}</label><input id="row-name" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10 transition-colors" value="${mainV}" placeholder="Digite aqui..."></div>${coll === 'types' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Sigla (EVT)</label><input id="row-extra" type="text" maxlength="5" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-black text-navy uppercase" value="${item.sigla || ''}"></div>` : ''}${coll === 'attendants' ? `<div class="flex flex-col gap-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Ministério</label><input id="row-extra" type="text" class="w-full p-3 border border-slate-200 rounded-xl text-sm font-semibold text-navy focus:ring-2 focus:ring-navy/10" value="${item.ministerio || ''}" placeholder="Ex: Louvor"></div>` : ''}<button onclick="window.saveRow('${coll}', '${safeId}')" class="w-full bg-navy text-white p-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg mt-2 active:scale-95 transition-transform">SALVAR REGISTRO</button></div></div>`);
        }

        async function saveRow(coll, id) {
            if (!state.isAdmin) return;
            const nameEl = document.getElementById('row-name');
            const name = nameEl?.value.trim();
            const dateVal = document.getElementById('feriado-date-val')?.value;
            const dateBtn = document.getElementById('feriado-btn');

            let hasError = false;
            if (coll !== 'perfis') { // Perfis não permite mudar nome no modal edit
                if (!name) { nameEl?.classList.add('input-error'); hasError = true; } else { nameEl?.classList.remove('input-error'); }
            }
            if (coll === 'feriados' && !dateVal) { dateBtn?.classList.add('input-error'); hasError = true; } else { dateBtn?.classList.remove('input-error'); }
            if (hasError) return;

            const p = {};
            if (coll === 'types') { const sigla = document.getElementById('row-extra')?.value.trim() || ""; p.name = name; p.sigla = sigla.toUpperCase(); }
            else if (coll === 'locations') { p.localidade = name; p.adm = document.getElementById('loc-adm')?.value.trim(); p.setor = document.getElementById('loc-setor')?.value.trim(); p.cidade = document.getElementById('loc-cidade')?.value.trim(); }
            else if (coll === 'attendants') { const min = document.getElementById('row-extra')?.value.trim() || ""; p.name = name; p.ministerio = min; }
            else if (coll === 'feriados') { p.nome_feriado = name; p.data = dateVal; p.tipo_feriado = document.getElementById('feriado-tipo')?.value.trim(); }
            else if (coll === 'perfis') { 
                p.autorizado = document.getElementById('user-authorized')?.checked; 
                p.permissao = document.getElementById('user-permission')?.value; 
            }
            
            // Verificação de duplicados (apenas para novas inserções ou mudança de nome em tabelas comuns)
            if (coll !== 'perfis' && coll !== 'agenda') {
                let ext = null;
                if (coll === 'types') {
                    ext = state.types.find(i => i.id !== id && ((i.name || '').toLowerCase() === name.toLowerCase() || (i.sigla || '').toUpperCase() === p.sigla));
                } else if (coll === 'feriados') {
                    ext = state.feriados.find(i => i.id !== id && i.data === p.data && (i.nome_feriado || '').toLowerCase() === name.toLowerCase());
                } else {
                    const key = coll === 'locations' ? 'localidade' : 'name';
                    ext = state[coll].find(i => i.id !== id && (i[key] || '').toLowerCase() === name.toLowerCase());
                }
                if (ext) { showDuplicateModal(name, coll, ext.id, id, p); return; }
            }

            const isN = !id || id === 'undefined' || id === '';
            const action = isN ? 'INSERT' : 'UPDATE';
            const result = await window.smartSave(coll, action, p, id);

            if (result.success) {
                if (result.offline) {
                    const cL = [...state[coll]];
                    if (isN) { cL.push({ id: 'temp_' + Date.now(), ...p }); } 
                    else { const idx = cL.findIndex(i => i.id === id); if (idx !== -1) cL[idx] = { ...cL[idx], ...p }; }
                    state[coll] = cL;
                } else { await refreshAllData(); }
                closeModal();
            }
        }

        function showDuplicateModal(name, coll, dupId, edId, curVals) {
            window.__duplicate_temp_data = curVals;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Registro Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Já existe um registro com este nome ou sigla:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dupId}', '${coll}')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.openRowModal('${coll}', '${edId}', window.__duplicate_temp_data)" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showEventDuplicateModal(dup) {
            const type = state.types.find((t) => t.id === dup.type_id);
            const loc = state.locations.find((l) => l.id === dup.location_id);
            const name = `${type?.name || 'Evento'} em ${loc?.localidade || 'Local'} (${formatDate(dup.date)} às ${dup.time})`;
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[10px] border-orange-custom"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-orange-50 rounded-2xl flex items-center justify-center mb-6"><i data-lucide="copy" class="text-orange-custom w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3 leading-tight">Evento Duplicado</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Já existe um evento idêntico cadastrado:<br><strong class="text-slate-700">"${name}"</strong>.</p><div class="w-full flex flex-col gap-3"><button onclick="window.locateDuplicate('${dup.id}', 'agenda')" class="w-full bg-navy text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all text-[13px] uppercase tracking-wide"><i data-lucide="search" class="w-4 h-4"></i> Localizar Duplicata</button><button onclick="window.closeModal()" class="w-full bg-slate-50 text-slate-500 py-4 rounded-xl font-bold active:scale-95 transition-all text-[13px] uppercase tracking-wide">Cancelar e Editar</button></div></div></div>`);
        }

        function showDeleteConfirmModal(id, coll, name) {
            if (!state.isAdmin) return;
            const isUser = coll === 'perfis';
            showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[8px] border-red-500"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mb-5"><i data-lucide="${isUser ? 'user-minus' : 'alert-triangle'}" class="text-red-500 w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3">Confirmação</h3><p class="text-sm text-slate-500 mb-8 leading-relaxed px-2">Deseja realmente excluir ${isUser ? 'o usuário e sua conta' : 'o registro'} <br><strong class="text-slate-700">"${name || ''}"</strong>?</p><div class="w-full flex gap-3"><button onclick="window.closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold active:scale-95 transition-all text-sm uppercase">Não</button><button onclick="window.confirmarExclusaoColecao('${id}', '${coll}')" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-black shadow-lg active:scale-95 transition-all text-sm uppercase">Sim, Excluir</button></div></div></div>`);
        }

        async function confirmarExclusaoColecao(id, coll) {
            if (!state.isAdmin) return;
            
            if (!navigator.onLine) {
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                queue.push({ table: coll, action: 'DELETE', id: id });
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));
                state[coll] = state[coll].filter(i => i.id !== id);
                closeModal();
                showConnStatus('offline');
                return;
            }

            try { 
                const { error } = await supabaseClient.from(coll).delete().eq('id', id); 
                if (!error) {
                    state[coll] = state[coll].filter(i => i.id !== id);
                    closeModal(); 
                    if (window.updateManagerListUI) window.updateManagerListUI(coll);
                } else {
                    alert("Erro ao excluir: " + error.message);
                }
            } catch(e) {
                console.error("Erro na exclusão:", e);
            }
        }

        async function confirmarEDeletar(id) {
            if (!id || !state.isAdmin) return;
            if (!navigator.onLine) {
                const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || '[]');
                queue.push({ table: 'agenda', action: 'DELETE', id: id.trim() });
                localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));
                state.events = state.events.filter((e) => e.id !== id.trim());
                closeModal();
                navigateTo('home');
                showConnStatus('offline');
                return;
            }
            try { const { error } = await supabaseClient.from('agenda').delete().eq('id', id.trim()); if (!error) { state.events = state.events.filter((e) => e.id !== id.trim()); state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; closeModal(); navigateTo('home'); } } catch(e) {}
        }

        function navigateTo(screen, push = true) { 
            if (push && state.currentScreen !== screen) window.history.pushState({ screen }, "");
            state.currentScreen = screen; 
            state.isMenuOpen = false; 
            state.managerSearchTerm = ''; 
            state.highlightedItemId = null; 
            state.formErrors = []; 
        }

        function openMenu() { state.isMenuOpen = true; }
        function closeMenu() { state.isMenuOpen = false; }
        function closeModal() { const m = document.getElementById('modal-container'); if(m){ m.classList.add('hidden'); m.innerHTML=''; } }
        function showModal(html) { const m = document.getElementById('modal-container'); if(m){ m.innerHTML = html; m.classList.remove('hidden'); } renderIcons(); }

        function showLoginModal() {
            const t = document.getElementById('login-modal-template');
            const m = document.getElementById('modal-container');
            if (m && t) {
                m.innerHTML = ''; m.appendChild(t.content.cloneNode(true)); m.classList.remove('hidden');
                let isSignUp = false;
                const toggleBtn = document.getElementById('toggle-auth-mode');
                const nameField = document.getElementById('name-field');
                const submitBtn = document.getElementById('login-submit-btn');
                const titleEl = document.getElementById('modal-login-title');
                toggleBtn?.addEventListener('click', () => {
                    isSignUp = !isSignUp;
                    if (isSignUp) { titleEl.innerText = "Novo Cadastro"; nameField.classList.remove('hidden'); submitBtn.innerText = "Cadastrar"; toggleBtn.innerText = "Já tem conta? Entre"; } 
                    else { titleEl.innerText = "Área Administrativa"; nameField.classList.add('hidden'); submitBtn.innerText = "Entrar"; toggleBtn.innerText = "Não tem conta? Cadastre-se"; }
                });
                document.getElementById('login-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); const errD = document.getElementById('login-error');
                    if (btn) { btn.disabled = true; btn.innerText = isSignUp ? 'Cadastrando...' : 'Entrando...'; }
                    const name = document.getElementById('login-name').value.trim();
                    const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
                    try { 
                        if (isSignUp) {
                            if (!name) throw new Error("O nome é obrigatório para cadastro.");
                            const { data, error } = await supabaseClient.auth.signUp({ 
                                email, 
                                password,
                                options: {
                                    data: {
                                        full_name: name
                                    }
                                }
                            });
                            if (error) throw error;
                            alert("Cadastro realizado! Aguarde a aprovação de um administrador."); closeModal();
                        } else {
                            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                            if (error) throw error;
                            closeModal();
                        }
                    } catch (err) { 
                        if (errD) { 
                            errD.innerText = translateAuthError(err.message); 
                            errD.classList.remove('hidden'); 
                        } 
                        if (btn) { 
                            btn.disabled = false; 
                            btn.innerText = isSignUp ? 'Cadastrar' : 'Entrar'; 
                        } 
                    }
                });
            }
            renderIcons();
        }

        function renderFFRow(l, v, t, c) {
            const isS = c === t;
            return `<div class="flex flex-col gap-1.5 p-3 rounded-2xl border-2 transition-all h-full ${isS ? 'border-orange-custom bg-orange-50/30' : 'border-slate-100 bg-slate-50/50'}" onclick="window.state.ffTemp.selected = '${t}'; window.renderFastFilterUI();"><div class="flex justify-between items-center px-1"><span class="text-[9px] font-black uppercase tracking-tight ${isS ? 'text-orange-custom' : 'text-slate-400'}">${l}</span><div class="flex gap-2"><button Pete.stopPropagation(); window.shiftFF('${t}', -1)" class="p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white"><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i></button><button Pete.stopPropagation(); window.shiftFF('${t}', 1)" class="p-1 hover:bg-white rounded-full text-navy shadow-sm border border-slate-200 bg-white"><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button></div></div><div class="text-[11px] font-bold text-navy px-1 leading-tight">${v}</div></div>`;
        }

        function renderFastFilterUI() {
            const bD = state.ffTemp.baseDates; const sel = state.ffTemp.selected;
            const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            const todayT = `${bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).charAt(0).toUpperCase() + bD.today.toLocaleDateString('pt-BR', { weekday: 'long' }).slice(1)}, dia ${fBR(bD.today)}`;
            const dW1 = new Date(bD.week); dW1.setDate(bD.week.getDate() - bD.week.getDay()); const dW2 = new Date(dW1); dW2.setDate(dW1.getDate() + 6);
            showModal(`<div class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md flex flex-col"><div class="p-4 flex justify-between items-center border-b border-slate-50 bg-white"><div class="flex items-gap-2 text-navy"><i data-lucide="filter" class="w-5 h-5 text-orange-custom"></i><h3 class="text-lg font-black tracking-tight uppercase">Filtro</h3></div><button onclick="window.closeModal()" class="text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 flex flex-col gap-4">${renderFFRow('Por dia', todayT, 'today', sel)}${renderFFRow('Semana', fBR(dW1) + ' a ' + fBR(dW2), 'week', sel)}<div class="flex gap-3"><div class="flex-1">${renderFFRow('Mês', `${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][bD.month.getMonth()]} / ${bD.month.getFullYear()}`, 'month', sel)}</div><div class="flex-1">${renderFFRow('Ano', bD.year.getFullYear().toString(), 'year', sel)}</div></div></div><div class="p-4 bg-white border-t border-slate-50"><button onclick="window.applyNewFastFilter()" class="w-full bg-navy text-white py-4 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all"><i data-lucide="check" class="w-4 h-4"></i> Aplicar</button></div></div>`);
            renderIcons();
        }

        function renderPickerItems(items, coll, isA, tar, prop) {
            if (items.length === 0) return '<div class="p-8 text-center text-slate-300 italic text-sm">Nenhum registro.</div>';
            const sorted = [...items].sort((a, b) => ((coll === 'locations' ? a.localidade : (coll === 'perfis' ? a.nome : a.name)) || '').localeCompare((coll === 'locations' ? b.localidade : (coll === 'perfis' ? b.nome : b.name)) || ''));
            return sorted.map((i) => {
                const name = (coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '';
                const isS = isA ? state.advancedFilter?.[tar]?.id === i.id : state[prop] === i.id;
                return `<button onclick="${isA ? `window.state.advancedFilter.${tar}.id = '${i.id}'; window.state.advancedFilter.validationErrors = window.state.advancedFilter.validationErrors.filter(e => e !== '${tar}'); window.renderAdvancedFilterModal();` : `window.state.${prop} = '${i.id}'; window.state.formErrors = window.state.formErrors.filter(e => !'${prop}'.includes(e)); window.closeModal();`}" class="w-full p-4 text-left font-semibold text-slate-700 hover:bg-slate-50 transition-colors border-b border-slate-50 flex justify-between items-center group active:bg-slate-100"><div class="flex flex-col min-w-0 flex-1"><span class="group-hover:text-navy transition-colors font-bold text-sm leading-tight">${name}</span></div>${isS ? '<i data-lucide="check" class="w-4 h-4 text-orange-custom shrink-0 ml-2"></i>' : ''}</button>`;
            }).join('');
        }

        async function refreshAllData() {
            if (!state.isAuthorized || !navigator.onLine) return;
            const tables = { 'types': 'types', 'locations': 'locations', 'attendants': 'attendants', 'agenda': 'events', 'feriados': 'feriados', 'perfis': 'perfis' };
            for (const [table, key] of Object.entries(tables)) {
                try {
                    const { data } = await supabaseClient.from(table).select('*');
                    if (data) {
                        state[key] = data;
                        localStorage.setItem(`cache_${table}`, JSON.stringify(data));
                    }
                } catch(e) {}
            }
        }

        function showConnStatus(status) {
            const el = document.getElementById('conn-status');
            if (!el) return;
            el.className = '';
            if (status === 'offline') { el.innerHTML = '<i data-lucide="wifi-off" class="w-3.5 h-3.5"></i> Sem internet'; el.classList.add('offline'); } 
            else if (status === 'online-recovered') { el.innerHTML = '<i data-lucide="wifi" class="w-3.5 h-3.5"></i> Conexão restabelecida.'; el.classList.add('online-recovered'); setTimeout(() => { el.classList.remove('online-recovered'); }, 3000); }
            renderIcons();
        }

        Object.assign(window, {
            renderApp, scheduleRender, navigateTo, openMenu, closeMenu, closeModal, showModal,
            handleLogout: () => { 
                state.isLoading = true;
                localStorage.clear();
                sessionStorage.clear();
                supabaseClient.auth.signOut().then(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                });
            }, 
            showLoginModal, saveRow, openRowModal, requestDeleteRow: (id, coll, name) => showDeleteConfirmModal(id, coll, name), confirmarExclusaoColecao, updateHomeList, renderCalendar, renderClockUI, renderAdvancedFilterModal, openDistinctPicker, openAdvancedFilterModal: () => renderAdvancedFilterModal(), resetAllFilters: () => { state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; updateHomeList(); },
            startOpenAgenda: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; const t = new Date().toISOString().split('T')[0]; if (!state.selectedDate) state.selectedDate = t; state.viewDate = new Date(state.selectedDate + 'T00:00:00'); renderCalendar('filter'); },
            changeMonth: (o, m) => { const d = new Date(state.viewDate); d.setMonth(d.getMonth() + o); state.viewDate = d; if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); },
            changePickerYear: (o, m) => { const d = new Date(state.viewDate); d.setFullYear(d.getFullYear() + o); state.viewDate = d; if (m.includes('month') || m === 'adv_period') window.openMonthPicker(m); else window.openYearPicker(m); },
            selectMonth: (i, m) => { const d = new Date(state.viewDate); d.setMonth(i); state.viewDate = d; if (m === 'adv_period') { const first = new Date(d.getFullYear(), i, 1); const last = new Date(d.getFullYear(), i + 1, 0); state.advancedFilter.period.start = first.toISOString().split('T')[0]; state.advancedFilter.period.end = last.toISOString().split('T')[0]; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${d.getFullYear()}-${String(i + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            selectYear: (y, m) => { const d = new Date(state.viewDate); d.setFullYear(y); state.viewDate = d; if (m === 'adv_period') { state.advancedFilter.period.start = `${y}-01-01`; state.advancedFilter.period.end = `${y}-12-31`; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else { if (m === 'filter') state.selectedDate = `${y}-${String(d.getMonth() + 1).padStart(2, '0')}-01`; renderCalendar(m); } },
            openMonthPicker: (m) => { const names = ["JANEIRO","FEVEREIRO","MARÇO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"]; const year = state.viewDate.getFullYear(); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-6 h-6"></i></button><div class="flex items-center justify-center gap-3 w-full mb-6"><button onclick="window.changePickerYear(-1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><span class="text-sm font-black text-navy uppercase tracking-widest">${year}</span><button onclick="window.changePickerYear(1, '${m}')" class="p-1.5 hover:bg-slate-50 rounded-xl text-navy"><i data-lucide="chevron-right" class="w-6 h-6"></i></button></div><div class="grid grid-cols-3 gap-3 w-full">${names.map((n, i) => `<button onclick="window.selectMonth(${i}, '${m}')" class="py-4 text-[11px] font-black rounded-xl border transition-all ${state.viewDate.getMonth() === i ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${n.slice(0, 3)}</button>`).join('')}</div></div>`); },
            openYearPicker: (m) => { const currentYear = new Date().getFullYear(); const selectedYear = (m === 'adv_period' && state.advancedFilter.period.start) ? new Date(state.advancedFilter.period.start + 'T00:00:00').getFullYear() : currentYear; state.viewDate = new Date(selectedYear, 0, 1); const years = []; for(let i = currentYear - 30; i < currentYear + 30; i++) years.push(i); showModal(`<div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md flex flex-col items-center relative"><button onclick="${m.startsWith('adv_') ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="absolute top-2 right-2 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-6 h-6"></i></button><div class="flex items-center justify-center w-full mb-6"><span class="text-sm font-black text-navy uppercase tracking-widest">ANO</span></div><div id="year-scroll-container" class="grid grid-cols-3 gap-3 w-full max-h-[224px] overflow-y-auto scrollbar-none py-2">${years.map(y => `<button id="year-btn-${y}" onclick="window.selectYear(${y}, '${m}')" class="py-4 text-xs font-black rounded-xl border transition-all ${y === selectedYear ? 'bg-navy text-white shadow-md' : 'bg-white text-navy border-slate-100 hover:border-navy/20'}">${y}</button>`).join('')}</div></div>`); setTimeout(() => { const btn = document.getElementById(`year-btn-${selectedYear}`); if (btn) btn.scrollIntoView({ block: 'center' }); }, 10); },
            selectCalendarDate: (d, m = 'filter') => { if (m === 'filter') { state.selectedDate = d; renderCalendar('filter'); } else if (m === 'picker') { state.formTempDate = d; state.formErrors = state.formErrors.filter(e => e !== 'date'); closeModal(); } else if (m === 'adv_start' || m === 'adv_end') { state.advancedFilter.period[m === 'adv_start' ? 'start' : 'end'] = d; state.advancedFilter.validationErrors = state.advancedFilter.validationErrors.filter(e => e !== 'period'); window.renderAdvancedFilterModal(); } else if (m === 'feriado_picker') { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, { ...c.item, data: d }); } },
            applyCalendarAndClose: () => { state.fastFilter = { active: false }; state.advancedFilter.active = false; updateHomeList(); closeModal(); },
            openFormDate: () => { state.viewDate = new Date((state.formTempDate || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('picker'); },
            openFeriadoDatePicker: () => { state.viewDate = new Date((document.getElementById('feriado-date-val')?.value || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar('feriado_picker'); },
            returnToFeriadoModal: () => { const c = window.__feriado_modal_cache; window.openRowModal('feriados', c.safeId, c.item); },
            renderFastFilterUI,
            openFastFilterModal: () => { state.searchTerm = ''; if (document.getElementById('homeSearch')) document.getElementById('homeSearch').value = ''; state.ffTemp.baseDates = { today: new Date(), week: new Date(), month: new Date(), year: new Date() }; renderFastFilterUI(); },
            shiftFF: (t, o) => { const d = new Date(state.ffTemp.baseDates[t]); if (t === 'today') d.setDate(d.getDate() + o); else if (t === 'week') d.setDate(d.getDate() + (o * 7)); else if (t === 'month') d.setMonth(d.getMonth() + o); else if (t === 'year') d.setFullYear(d.getFullYear() + o); state.ffTemp.baseDates[t] = d; state.ffTemp.selected = t; renderFastFilterUI(); },
            applyNewFastFilter: () => { const b = new Date(state.ffTemp.baseDates[state.ffTemp.selected]); let st = '', en = '', la = ''; const f = (d) => d.toISOString().split('T')[0]; const fBR = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; if (state.ffTemp.selected === 'today') { st = en = f(b); let w = b.toLocaleDateString('pt-BR', { weekday: 'long' }); la = `${w.charAt(0).toUpperCase() + w.slice(1)}, dia ${fBR(b)}`; } else if (state.ffTemp.selected === 'week') { const d1 = new Date(b); d1.setDate(b.getDate() - b.getDay()); const d2 = new Date(d1); d2.setDate(d1.getDate() + 6); st = f(d1); en = f(d2); la = `Semana ${fBR(d1)} a ${fBR(d2)}`; } else if (state.ffTemp.selected === 'month') { const d1 = new Date(b.getFullYear(), b.getMonth(), 1); const d2 = new Date(b.getFullYear(), b.getMonth() + 1, 0); st = f(d1); en = f(d2); la = `${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][b.getMonth()]} / ${b.getFullYear()}`; } else if (state.ffTemp.selected === 'year') { st = `${b.getFullYear()}-01-01`; en = `${b.getFullYear()}-12-31`; la = `Ano de ${b.getFullYear()}`; } state.selectedDate = null; state.advancedFilter.active = false; state.fastFilter = { active: true, dateStart: st, dateEnd: en, label: la }; closeModal(); updateHomeList(); },
            toggleAdvFilterSection: (sec) => { const af = state.advancedFilter; af[sec].enabled = !af[sec].enabled; af.validationErrors = af.validationErrors.filter(e => e !== sec); if (sec === 'adm' && !af.adm.enabled) { af.adm.value = ''; af.setor.enabled = false; af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'setor' && !af.setor.enabled) { af.setor.value = ''; af.cidade.enabled = false; af.cidade.value = ''; af.location.id = ''; } else if (sec === 'cidade' && !af.cidade.enabled) { af.cidade.value = ''; af.location.id = ''; } window.renderAdvancedFilterModal(); },
            handleAdvFilterSelect: (f, v) => { const af = state.advancedFilter; af[f].value = v; af.validationErrors = af.validationErrors.filter(e => e !== f); if (f === 'adm') { af.setor.value = ''; af.cidade.value = ''; af.location.id = ''; } else if (f === 'setor') { af.cidade.value = ''; af.location.id = ''; } else if (f === 'cidade') af.location.id = ''; window.renderAdvancedFilterModal(); },
            setAdvFilterStatus: (s) => { state.advancedFilter.eventos.status = s; },
            clearAdvancedFilters: () => { state.advancedFilter = { active: false, eventos: { enabled: false, status: 'ativos' }, type: { enabled: false, id: '' }, location: { enabled: false, id: '' }, attendant: { enabled: false, id: '' }, adm: { enabled: false, value: '' }, setor: { enabled: false, value: '' }, cidade: { enabled: false, value: '' }, period: { enabled: false, start: '', end: '' }, validationErrors: [] }; updateHomeList(); window.renderAdvancedFilterModal(); },
            applyAdvancedFilters: () => { const af = state.advancedFilter; const errs = []; if (af.type.enabled && !af.type.id) errs.push('type'); if (af.location.enabled && !af.location.id) errs.push('location'); if (af.attendant.enabled && !af.attendant.id) errs.push('attendant'); if (af.adm.enabled && !af.adm.value) errs.push('adm'); if (af.setor.enabled && !af.setor.value) errs.push('setor'); if (af.cidade.enabled && !af.cidade.value) errs.push('cidade'); if (af.period.enabled && (!af.period.start || !af.period.end)) errs.push('period'); if (errs.length > 0) { state.advancedFilter.validationErrors = errs; window.renderAdvancedFilterModal(); return; } state.selectedDate = null; state.fastFilter.active = false; state.advancedFilter.active = true; state.advancedFilter.validationErrors = []; closeModal(); updateHomeList(); },
            openDateRangePicker: (t) => { state.viewDate = new Date((state.advancedFilter.period[t] || new Date().toISOString().split('T')[0]) + 'T00:00:00'); renderCalendar(t === 'start' ? 'adv_start' : 'adv_end'); },
            openPDFPreview: () => alert("Exportação em breve."),
            startCreateEvent: () => { state.editingEventId = null; state.formTempDate = new Date().toISOString().split('T')[0]; state.formTempTime = '08:00'; state.formTempLoc = ''; state.formTempType = ''; state.formTempAtt = ''; state.formTempIrmaos = ''; state.formTempIrmas = ''; state.formErrors = []; navigateTo('event-form'); },
            openEditEvent: (id) => { const ev = state.events.find((e) => e.id === id); if (ev) { state.editingEventId = id; state.formTempDate = ev.date; state.formTempTime = ev.time; state.formTempLoc = ev.location_id; state.formTempType = ev.type_id; state.formTempAtt = ev.attendant_id || ''; state.formTempIrmaos = ev.irmaos || ''; state.formTempIrmas = ev.irmas || ''; state.formErrors = []; navigateTo('event-form'); } },
            openTimePickerModal: () => { const [h, m] = (state.formTempTime || '08:00').split(':'); state.clockTempHour = h; state.clockTempMinute = m; state.clockMode = 'hour'; showModal(''); renderClockUI(); },
            selectClockValue: (v) => { if (state.clockMode === 'hour') { state.clockTempHour = v.padStart(2, '0'); state.clockMode = 'minute'; } else state.clockTempMinute = v.padStart(2, '0'); renderClockUI(); },
            confirmClockTime: () => { state.formTempTime = `${state.clockTempHour}:${state.clockTempMinute}`; closeModal(); },
            openSelectPicker: (coll, tit, pr) => { let items = [...state[coll]]; if (coll === 'locations' && pr === 'adv_location') { const af = state.advancedFilter; if (af.adm.enabled && af.adm.value) items = items.filter(l => l.adm === af.adm.value); if (af.setor.enabled && af.setor.value) items = items.filter(l => l.setor === af.setor.value); if (af.cidade.enabled && af.cidade.value) items = items.filter(l => l.cidade === af.cidade.value); } const isA = pr.startsWith('adv_'); const target = isA ? pr.replace('adv_', '') : pr; showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]"><div class="p-5 flex justify-between items-center bg-white border-b border-slate-50"><div class="flex items-center gap-3 text-navy"><i data-lucide="list" class="w-5 h-5"></i><h3 class="font-bold text-lg">Selecionar ${tit}</h3></div><button onclick="${isA ? 'window.renderAdvancedFilterModal()' : 'window.closeModal()'}" class="text-slate-400 p-1"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="px-5 py-4"><div class="relative group"><input id="pickerSearch" type="text" placeholder="Filtrar..." class="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-xl text-sm font-medium"><i data-lucide="search" class="absolute left-3.5 top-3.5 text-slate-400 w-4 h-4"></i></div></div><div id="pickerItemsList" class="flex-1 overflow-y-auto px-2 pb-4 scrollbar-none"></div></div>`); const listEl = document.getElementById('pickerItemsList'); if (listEl) listEl.innerHTML = renderPickerItems(items, coll, isA, target, pr); document.getElementById('pickerSearch')?.addEventListener('input', (e) => { const term = (e.target.value || '').toLowerCase(); const filtered = items.filter((i) => ((coll === 'locations' ? i.localidade : (coll === 'perfis' ? i.nome : i.name)) || '').toLowerCase().includes(term)); document.getElementById('pickerItemsList').innerHTML = renderPickerItems(filtered, coll, isA, target, pr); renderIcons(); }); renderIcons(); },
            saveEvent: async () => { const errs = []; if (!state.formTempDate) errs.push('date'); if (!state.formTempLoc) errs.push('loc'); if (!state.formTempType) errs.push('type'); if (errs.length > 0) { state.formErrors = errs; return; } const eventData = { date: state.formTempDate, time: state.formTempTime, location_id: state.formTempLoc, type_id: state.formTempType, attendant_id: state.formTempAtt || null, irmaos: PeteInt(document.getElementById('event-irmaos')?.value || '0'), irmas: PeteInt(document.getElementById('event-irmas')?.value || '0') }; const duplicate = state.events.find(e => e.date === eventData.date && e.time === eventData.time && e.location_id === eventData.location_id && e.type_id === eventData.type_id && e.id !== state.editingEventId); if (duplicate) { showEventDuplicateModal(duplicate); return; } const action = state.editingEventId ? 'UPDATE' : 'INSERT'; const result = await window.smartSave('agenda', action, eventData, state.editingEventId); if (result.success) { if (result.offline) { if (action === 'UPDATE') state.events = state.events.map(e => e.id === state.editingEventId ? { ...e, ...eventData } : e); else state.events = [...state.events, { id: 'temp-' + Date.now(), ...eventData, is_temp: true }]; } window.navigateTo('home'); state.editingEventId = null; } else alert("Erro ao salvar: " + result.error); },
            requestDeleteEvent: (id) => { const ev = state.events.find((e) => e.id === id); const type = state.types.find((t) => t.id === ev?.type_id); const loc = state.locations.find((l) => l.id === ev?.location_id); showModal(`<div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden relative border-t-[8px] border-red-500"><div class="p-8 flex flex-col items-center text-center"><div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mb-5"><i data-lucide="alert-triangle" class="text-red-500 w-8 h-8"></i></div><h3 class="text-xl font-black text-navy mb-3">Excluir?</h3><p class="text-sm text-slate-500 mb-8 px-2">Deseja excluir este evento?<br><strong class="text-slate-700">${type?.name || ''} em ${loc?.localidade || ''}</strong></p><div class="w-full flex gap-3"><button onclick="window.closeModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold uppercase text-sm">Não</button><button onclick="window.confirmarEDeletar('${id}')" class="flex-1 bg-red-600 py-3 rounded-xl font-black uppercase text-sm">Sim</button></div></div></div>`); },
            confirmarEDeletar,
            locateDuplicate: (id, coll) => { const targetScreen = coll === 'agenda' ? 'home' : (coll === 'perfis' ? 'users' : coll); closeModal(); navigateTo(targetScreen); state.managerSearchTerm = ''; state.searchTerm = ''; state.selectedDate = null; state.fastFilter = { active: false }; state.advancedFilter.active = false; state.highlightedItemId = id; if (targetScreen === 'home') updateHomeList(); else if (window.updateManagerListUI) window.updateManagerListUI(coll); },
            showExitConfirmation: () => {
                showModal(`
                    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] overflow-hidden border-t-8 border-navy/10">
                        <div class="p-8 flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-6 text-navy">
                                <i data-lucide="log-out" class="w-8 h-8"></i>
                            </div>
                            <h3 class="text-xl font-black text-navy uppercase tracking-tight mb-3">Sair do App?</h3>
                            <p class="text-sm font-medium text-slate-500 mb-8 leading-relaxed">Você deseja realmente encerrar sua sessão e sair do aplicativo agora?</p>
                            <div class="w-full flex flex-col gap-3">
                                <button onclick="window.closeModal()" class="w-full py-4 bg-slate-100 text-slate-600 rounded-2xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all">Continuar no App</button>
                                <button onclick="window.handleLogout()" class="w-full py-4 bg-navy text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl active:scale-95 transition-all">Sim, Sair</button>
                            </div>
                        </div>
                    </div>
                `);
            }
        });

       async function init() {
            // 1. Carregar cache local IMEDIATAMENTE (antes de qualquer rede)
            const tablesToCache = ['types', 'locations', 'attendants', 'agenda', 'feriados', 'perfis'];
            tablesToCache.forEach(table => { 
                const cachedData = localStorage.getItem(`cache_${table}`); 
                if (cachedData) { 
                    const key = table === 'agenda' ? 'events' : table; 
                    state[key] = JSON.parse(cachedData); 
                } 
            });

            // 2. Tentar recuperar sessão local
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                state.user = session.user;
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();
                
                // Se for MasterAdmin ou tiver cache autorizado, já libera a interface
                if (isMasterAdmin || initialProfile.isAuthorized) {
                    state.isAdmin = isMasterAdmin || initialProfile.isAdmin;
                    state.isAuthorized = isMasterAdmin || initialProfile.isAuthorized;
                }

                // 3. SE estiver autorizado (pelo cache ou master), encerramos o loading aqui para abrir instantâneo
                if (state.isAuthorized) {
                    state.isLoading = false;
                }

                // 4. Background check do perfil (só se estiver online)
                if (navigator.onLine) {
                    try {
                        const { data: profile, error } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        // Importante: Só sobrescrevemos o estado se recebermos uma resposta válida do banco
                        if (!error && profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);
                            
                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({
                                isAdmin: state.isAdmin,
                                isAuthorized: state.isAuthorized
                            }));
                        }
                    } catch (e) {
                        console.error("Falha silenciosa na atualização de perfil (vontando ao cache).");
                    }
                }
                
                if (state.isAuthorized) await refreshAllData();
            }
            
            // Garante que o loading saia em qualquer caso
            state.isLoading = false;

            // 5. Gestão de Histórico
            window.history.replaceState({ screen: 'home' }, "");
            window.addEventListener('popstate', (event) => {
                if (state.isMenuOpen) { state.isMenuOpen = false; return; }
                const modal = document.getElementById('modal-container');
                if (modal && !modal.classList.contains('hidden')) { 
                    closeModal(); 
                    if (state.currentScreen === 'home') window.history.pushState({ screen: 'home' }, "");
                    return; 
                }
                if (event.state && event.state.screen) navigateTo(event.state.screen, false); 
                else {
                    if (state.currentScreen === 'home') { window.showExitConfirmation(); window.history.pushState({ screen: 'home' }, ""); }
                    else navigateTo('home', false); 
                }
            });

            window.addEventListener('offline', () => { showConnStatus('offline'); });
            window.addEventListener('online', async () => { showConnStatus('online-recovered'); await refreshAllData(); scheduleRender(); });

            supabaseClient.auth.onAuthStateChange(async (event, session) => { 
                if (event === 'SIGNED_OUT' || !session) {
                    state.user = null; state.isAuthorized = false; state.isAdmin = false; state.currentScreen = 'home';
                    localStorage.removeItem(USER_PROFILE_CACHE_KEY); scheduleRender(); return;
                }

                state.user = session?.user || null; 
                const isMasterAdmin = session.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();
                
                // Se o evento for SIGNED_IN ou mudança com rede, validamos no servidor
                if (session?.user && navigator.onLine) {
                    try {
                        const { data: profile } = await supabaseClient.from('perfis').select('permissao, autorizado').eq('id', session.user.id).single();
                        if (profile) {
                            state.isAdmin = isMasterAdmin || (profile.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (profile.autorizado === true);
                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({ isAdmin: state.isAdmin, isAuthorized: state.isAuthorized }));
                        }
                    } catch (e) {
                        // Mantém permissões do state se houver falha de rede
                    }
                }
                
                if (state.isAuthorized) await refreshAllData();
                if (event === 'SIGNED_IN') closeModal(); 
                scheduleRender(); 
            });

            const setupListener = (table, stateKey) => {
                // Sincronização Realtime (só funciona online)
                supabaseClient.channel(`public:${table}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table }, (payload) => {
                        const current = [...(state[stateKey] || [])];
                        if (!current.find(item => item.id === payload.new.id)) {
                            state[stateKey] = [...current, payload.new];
                            localStorage.setItem(`cache_${table}`, JSON.stringify(state[stateKey]));
                        }
                    })
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table }, async (payload) => {
                        const current = [...(state[stateKey] || [])];
                        state[stateKey] = current.map(item => item.id === payload.new.id ? payload.new : item);
                        localStorage.setItem(`cache_${table}`, JSON.stringify(state[stateKey]));
                        
                        if (table === 'perfis' && state.user && payload.new.id === state.user.id) {
                            const isMasterAdmin = state.user.email?.toLowerCase() === (ADMIN_EMAIL || '').toLowerCase();
                            state.isAdmin = isMasterAdmin || (payload.new.permissao === 'admin');
                            state.isAuthorized = isMasterAdmin || (payload.new.autorizado === true);
                            localStorage.setItem(USER_PROFILE_CACHE_KEY, JSON.stringify({ isAdmin: state.isAdmin, isAuthorized: state.isAuthorized }));
                            if (state.isAuthorized) await refreshAllData();
                        }
                    })
                    .on('postgres_changes', { event: 'DELETE', schema: 'public', table }, (payload) => {
                        const current = [...(state[stateKey] || [])];
                        state[stateKey] = current.filter(item => item.id !== payload.old.id);
                        localStorage.setItem(`cache_${table}`, JSON.stringify(state[stateKey]));
                    })
                    .subscribe();
            };

            setupListener('types', 'types'); setupListener('locations', 'locations'); setupListener('attendants', 'attendants'); setupListener('agenda', 'events'); setupListener('feriados', 'feriados'); setupListener('perfis', 'perfis');
            loadExternalHolidays(new Date().getFullYear());
        }
        init();
    </script>
</body>
</html>
